/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mtrn.form;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataUtilities;
import erp.gui.session.SSessionCustom;
import erp.lib.SLibConstants;
import erp.lib.SLibTimeUtilities;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormUtilities;
import erp.lib.form.SFormValidation;
import erp.lib.table.STableColumnForm;
import erp.lib.table.STableConstants;
import erp.lib.table.STablePane;
import erp.lib.table.STableRow;
import erp.mbps.data.SDataBizPartnerBranch;
import erp.mcfg.data.SDataCompanyBranchEntity;
import erp.mod.trn.db.SStockValuationUtils;
import erp.mtrn.data.SDataDiog;
import erp.mtrn.data.SDataDiogEntry;
import erp.mtrn.data.SDataDps;
import erp.mtrn.data.STrnDpsStockReturnRow;
import erp.mtrn.data.STrnStockMove;
import erp.mtrn.data.STrnUtilities;
import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.sql.ResultSet;
import java.util.Vector;
import javax.swing.JButton;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import sa.lib.SLibUtils;

/**
 *
 * @author Sergio Flores, Claudio Peña, Edwin Carmona
 */
public class SDialogDpsStockReturn extends javax.swing.JDialog implements ActionListener, ListSelectionListener {

    private static final int COL_QTY = 4;
    private static final int COL_PRI = 9;

    private int mnFormResult;
    private int mnFormStatus;
    private boolean mbFirstTime;
    private erp.client.SClientInterface miClient;
    private erp.lib.table.STablePane moPaneDpsEntries;
    private erp.mtrn.form.SPanelDps moPanelDps;
    private erp.mtrn.form.SDialogPickerStockLots moPickerStockLots;

    private int mnYear;
    private int[] manWarehouseKey;
    private erp.mbps.data.SDataBizPartnerBranch moParamCompanyBranch;
    private erp.mcfg.data.SDataCompanyBranchEntity moParamWarehouse;
    private erp.mtrn.data.SDataDps moParamDps;
    private erp.mtrn.data.SDataDiog moParamDiog;

    /** Creates new form SDialogDpsStockReturn */
    public SDialogDpsStockReturn(erp.client.SClientInterface client) {
        super(client.getFrame(), true);

        miClient = client;

        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jlPanelDps = new javax.swing.JLabel();
        jpDpsEntries = new javax.swing.JPanel();
        jpDpsEntriesControls = new javax.swing.JPanel();
        jpDpsEntriesControls1 = new javax.swing.JPanel();
        jlWarehouse = new javax.swing.JLabel();
        jtfCompanyBranch = new javax.swing.JTextField();
        jtfCompanyBranchCode = new javax.swing.JTextField();
        jtfWarehouse = new javax.swing.JTextField();
        jtfWarehouseCode = new javax.swing.JTextField();
        jpDpsEntriesControls2 = new javax.swing.JPanel();
        jbSupplyAll = new javax.swing.JButton();
        jbCleanAll = new javax.swing.JButton();
        jpDpsEntriesInfo = new javax.swing.JPanel();
        jpDpsEntriesInfo1 = new javax.swing.JPanel();
        jpDpsEntriesInfo11 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jlQuantityBase = new javax.swing.JLabel();
        jtfQuantityBase = new javax.swing.JTextField();
        jtfQuantityBaseUnit = new javax.swing.JTextField();
        jPanel5 = new javax.swing.JPanel();
        jlQuantityReturned = new javax.swing.JLabel();
        jtfQuantityReturned = new javax.swing.JTextField();
        jtfQuantityReturnedUnit = new javax.swing.JTextField();
        jPanel6 = new javax.swing.JPanel();
        jlQuantityPending = new javax.swing.JLabel();
        jtfQuantityPending = new javax.swing.JTextField();
        jtfQuantityPendingUnit = new javax.swing.JTextField();
        jpDpsEntriesInfo12 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jPanel9 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jpDpsEntriesInfo2 = new javax.swing.JPanel();
        jpDpsEntriesInfo21 = new javax.swing.JPanel();
        jlStock = new javax.swing.JLabel();
        jtfStock = new javax.swing.JTextField();
        jtfStockUnit = new javax.swing.JTextField();
        jbViewLots = new javax.swing.JButton();
        jpDpsEntriesInfo22 = new javax.swing.JPanel();
        jlCurrentlyUsed = new javax.swing.JLabel();
        jtfCurrentlyUsed = new javax.swing.JTextField();
        jtfCurrentlyUsedUnit = new javax.swing.JTextField();
        jpDpsEntriesInfo23 = new javax.swing.JPanel();
        jlAvailable = new javax.swing.JLabel();
        jtfAvailable = new javax.swing.JTextField();
        jtfAvailableUnit = new javax.swing.JTextField();
        jlYear = new javax.swing.JLabel();
        jtfYear = new javax.swing.JTextField();
        jpControls = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();
        jPanel7 = new javax.swing.JPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Devolución de documento");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jlPanelDps.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jlPanelDps.setText("[Panel de documento de compras-ventas]");
        jlPanelDps.setPreferredSize(new java.awt.Dimension(100, 200));
        getContentPane().add(jlPanelDps, java.awt.BorderLayout.NORTH);

        jpDpsEntries.setBorder(javax.swing.BorderFactory.createTitledBorder("Partidas pendientes del documento:"));
        jpDpsEntries.setLayout(new java.awt.BorderLayout(0, 5));

        jpDpsEntriesControls.setLayout(new java.awt.BorderLayout());

        jpDpsEntriesControls1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT, 5, 0));

        jlWarehouse.setText("Almacén:");
        jlWarehouse.setPreferredSize(new java.awt.Dimension(65, 23));
        jpDpsEntriesControls1.add(jlWarehouse);

        jtfCompanyBranch.setBackground(java.awt.Color.lightGray);
        jtfCompanyBranch.setEditable(false);
        jtfCompanyBranch.setText("TEXT");
        jtfCompanyBranch.setFocusable(false);
        jtfCompanyBranch.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsEntriesControls1.add(jtfCompanyBranch);

        jtfCompanyBranchCode.setBackground(java.awt.Color.lightGray);
        jtfCompanyBranchCode.setEditable(false);
        jtfCompanyBranchCode.setText("CODE");
        jtfCompanyBranchCode.setFocusable(false);
        jtfCompanyBranchCode.setPreferredSize(new java.awt.Dimension(55, 23));
        jpDpsEntriesControls1.add(jtfCompanyBranchCode);

        jtfWarehouse.setBackground(java.awt.Color.lightGray);
        jtfWarehouse.setEditable(false);
        jtfWarehouse.setText("TEXT");
        jtfWarehouse.setFocusable(false);
        jtfWarehouse.setPreferredSize(new java.awt.Dimension(155, 23));
        jpDpsEntriesControls1.add(jtfWarehouse);

        jtfWarehouseCode.setBackground(java.awt.Color.lightGray);
        jtfWarehouseCode.setEditable(false);
        jtfWarehouseCode.setText("CODE");
        jtfWarehouseCode.setFocusable(false);
        jtfWarehouseCode.setPreferredSize(new java.awt.Dimension(55, 23));
        jpDpsEntriesControls1.add(jtfWarehouseCode);

        jpDpsEntriesControls.add(jpDpsEntriesControls1, java.awt.BorderLayout.WEST);

        jpDpsEntriesControls2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT, 5, 0));

        jbSupplyAll.setText("Devolver todo");
        jbSupplyAll.setMargin(new java.awt.Insets(2, 0, 2, 0));
        jbSupplyAll.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsEntriesControls2.add(jbSupplyAll);

        jbCleanAll.setText("Limpiar todo");
        jbCleanAll.setMargin(new java.awt.Insets(2, 0, 2, 0));
        jbCleanAll.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsEntriesControls2.add(jbCleanAll);

        jpDpsEntriesControls.add(jpDpsEntriesControls2, java.awt.BorderLayout.CENTER);

        jpDpsEntries.add(jpDpsEntriesControls, java.awt.BorderLayout.NORTH);

        jpDpsEntriesInfo.setLayout(new java.awt.BorderLayout());

        jpDpsEntriesInfo1.setLayout(new java.awt.GridLayout(1, 2));

        jpDpsEntriesInfo11.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantityBase.setText("+ Cant. original:");
        jlQuantityBase.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel4.add(jlQuantityBase);

        jtfQuantityBase.setEditable(false);
        jtfQuantityBase.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfQuantityBase.setText("0.00");
        jtfQuantityBase.setFocusable(false);
        jtfQuantityBase.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel4.add(jtfQuantityBase);

        jtfQuantityBaseUnit.setEditable(false);
        jtfQuantityBaseUnit.setText("UNIT");
        jtfQuantityBaseUnit.setFocusable(false);
        jtfQuantityBaseUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel4.add(jtfQuantityBaseUnit);

        jpDpsEntriesInfo11.add(jPanel4);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantityReturned.setText("– Cant. devuelta:");
        jlQuantityReturned.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel5.add(jlQuantityReturned);

        jtfQuantityReturned.setEditable(false);
        jtfQuantityReturned.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfQuantityReturned.setText("0.00");
        jtfQuantityReturned.setFocusable(false);
        jtfQuantityReturned.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel5.add(jtfQuantityReturned);

        jtfQuantityReturnedUnit.setEditable(false);
        jtfQuantityReturnedUnit.setText("UNIT");
        jtfQuantityReturnedUnit.setFocusable(false);
        jtfQuantityReturnedUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel5.add(jtfQuantityReturnedUnit);

        jpDpsEntriesInfo11.add(jPanel5);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantityPending.setText("= Cant. pendiente:");
        jlQuantityPending.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel6.add(jlQuantityPending);

        jtfQuantityPending.setBackground(java.awt.Color.pink);
        jtfQuantityPending.setEditable(false);
        jtfQuantityPending.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfQuantityPending.setText("0.00");
        jtfQuantityPending.setFocusable(false);
        jtfQuantityPending.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel6.add(jtfQuantityPending);

        jtfQuantityPendingUnit.setEditable(false);
        jtfQuantityPendingUnit.setBackground(java.awt.Color.pink);
        jtfQuantityPendingUnit.setText("UNIT");
        jtfQuantityPendingUnit.setFocusable(false);
        jtfQuantityPendingUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel6.add(jtfQuantityPendingUnit);

        jpDpsEntriesInfo11.add(jPanel6);

        jpDpsEntriesInfo1.add(jpDpsEntriesInfo11);

        jpDpsEntriesInfo12.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));
        jpDpsEntriesInfo12.add(jPanel8);

        jPanel9.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));
        jpDpsEntriesInfo12.add(jPanel9);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));
        jpDpsEntriesInfo12.add(jPanel2);

        jpDpsEntriesInfo1.add(jpDpsEntriesInfo12);

        jpDpsEntriesInfo.add(jpDpsEntriesInfo1, java.awt.BorderLayout.WEST);

        jpDpsEntriesInfo2.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jpDpsEntriesInfo21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlStock.setText("+ Existencias:");
        jlStock.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDpsEntriesInfo21.add(jlStock);

        jtfStock.setEditable(false);
        jtfStock.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfStock.setText("0.00");
        jtfStock.setFocusable(false);
        jtfStock.setPreferredSize(new java.awt.Dimension(120, 23));
        jpDpsEntriesInfo21.add(jtfStock);

        jtfStockUnit.setEditable(false);
        jtfStockUnit.setText("UNIT");
        jtfStockUnit.setFocusable(false);
        jtfStockUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jpDpsEntriesInfo21.add(jtfStockUnit);

        jbViewLots.setText("Ver lotes");
        jbViewLots.setMargin(new java.awt.Insets(2, 0, 2, 0));
        jbViewLots.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDpsEntriesInfo21.add(jbViewLots);

        jpDpsEntriesInfo2.add(jpDpsEntriesInfo21);

        jpDpsEntriesInfo22.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCurrentlyUsed.setText("– Uso actual:");
        jlCurrentlyUsed.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDpsEntriesInfo22.add(jlCurrentlyUsed);

        jtfCurrentlyUsed.setEditable(false);
        jtfCurrentlyUsed.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfCurrentlyUsed.setText("0.00");
        jtfCurrentlyUsed.setFocusable(false);
        jtfCurrentlyUsed.setPreferredSize(new java.awt.Dimension(120, 23));
        jpDpsEntriesInfo22.add(jtfCurrentlyUsed);

        jtfCurrentlyUsedUnit.setEditable(false);
        jtfCurrentlyUsedUnit.setText("UNIT");
        jtfCurrentlyUsedUnit.setFocusable(false);
        jtfCurrentlyUsedUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jpDpsEntriesInfo22.add(jtfCurrentlyUsedUnit);

        jpDpsEntriesInfo2.add(jpDpsEntriesInfo22);

        jpDpsEntriesInfo23.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlAvailable.setText("= Disponible:");
        jlAvailable.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDpsEntriesInfo23.add(jlAvailable);

        jtfAvailable.setBackground(new java.awt.Color(153, 204, 255));
        jtfAvailable.setEditable(false);
        jtfAvailable.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfAvailable.setText("0.00");
        jtfAvailable.setFocusable(false);
        jtfAvailable.setPreferredSize(new java.awt.Dimension(120, 23));
        jpDpsEntriesInfo23.add(jtfAvailable);

        jtfAvailableUnit.setBackground(new java.awt.Color(153, 204, 255));
        jtfAvailableUnit.setEditable(false);
        jtfAvailableUnit.setText("UNIT");
        jtfAvailableUnit.setFocusable(false);
        jtfAvailableUnit.setPreferredSize(new java.awt.Dimension(40, 23));
        jpDpsEntriesInfo23.add(jtfAvailableUnit);

        jlYear.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlYear.setText("Año:");
        jlYear.setPreferredSize(new java.awt.Dimension(35, 23));
        jpDpsEntriesInfo23.add(jlYear);

        jtfYear.setBackground(new java.awt.Color(153, 204, 255));
        jtfYear.setEditable(false);
        jtfYear.setHorizontalAlignment(javax.swing.JTextField.CENTER);
        jtfYear.setText("2000");
        jtfYear.setFocusable(false);
        jtfYear.setPreferredSize(new java.awt.Dimension(40, 23));
        jpDpsEntriesInfo23.add(jtfYear);

        jpDpsEntriesInfo2.add(jpDpsEntriesInfo23);

        jpDpsEntriesInfo.add(jpDpsEntriesInfo2, java.awt.BorderLayout.CENTER);

        jpDpsEntries.add(jpDpsEntriesInfo, java.awt.BorderLayout.SOUTH);

        getContentPane().add(jpDpsEntries, java.awt.BorderLayout.CENTER);

        jpControls.setLayout(new java.awt.BorderLayout());

        jPanel1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel1.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setToolTipText("[Escape]");
        jPanel1.add(jbCancel);

        jpControls.add(jPanel1, java.awt.BorderLayout.EAST);

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));
        jpControls.add(jPanel7, java.awt.BorderLayout.CENTER);

        getContentPane().add(jpControls, java.awt.BorderLayout.SOUTH);

        setSize(new java.awt.Dimension(928, 609));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    private void initComponentsExtra() {
        int col = 0;
        STableColumnForm[] columns = null;

        moPanelDps = new SPanelDps(miClient, "a devolver");
        remove(jlPanelDps);
        add(moPanelDps, BorderLayout.NORTH);

        col = 0;
        columns = new STableColumnForm[10];
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_INTEGER, "#", STableConstants.WIDTH_NUM_TINYINT);
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Clave", STableConstants.WIDTH_ITEM_KEY);
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Concepto", STableConstants.WIDTH_ITEM_3X);
        columns[col] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Cant. pendiente", STableConstants.WIDTH_QUANTITY_2X);
        columns[col++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererQuantity());
        columns[col] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Cant. a devolver", STableConstants.WIDTH_QUANTITY_2X);
        columns[col].setEditable(true);
        columns[col++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererQuantity());
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Unidad", STableConstants.WIDTH_UNIT_SYMBOL);
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Tipo doc.", STableConstants.WIDTH_CODE_DOC);
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Folio doc.", STableConstants.WIDTH_DOC_NUM);
        columns[col++] = new STableColumnForm(SLibConstants.DATA_TYPE_DATE, "Fecha doc.", STableConstants.WIDTH_DATE);   
        columns[col] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Precio Unitario", STableConstants.WIDTH_QUANTITY_2X);
        columns[col].setEditable(true);

        moPaneDpsEntries = new STablePane(miClient);
        jpDpsEntries.add(moPaneDpsEntries, BorderLayout.CENTER);

        for (STableColumnForm column : columns) {
            moPaneDpsEntries.addTableColumn(column);
        }

        moPaneDpsEntries.createTable();
        moPaneDpsEntries.getTable().getSelectionModel().addListSelectionListener(this);
        moPaneDpsEntries.getTable().getTableHeader().setReorderingAllowed(false);
        moPaneDpsEntries.getTable().getTableHeader().setResizingAllowed(false);

        moPickerStockLots = new SDialogPickerStockLots(miClient, false);

        jbOk.addActionListener(this);
        jbCancel.addActionListener(this);
        jbSupplyAll.addActionListener(this);
        jbCleanAll.addActionListener(this);
        jbViewLots.addActionListener(this);

        SFormUtilities.createActionMap(rootPane, this, "actionOk", "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);
        SFormUtilities.createActionMap(rootPane, this, "actionCancel", "cancel", KeyEvent.VK_ESCAPE, SLibConstants.UNDEFINED);
    }

    private void windowActivated() {
        if (mbFirstTime) {
            mbFirstTime = false;
            moPaneDpsEntries.getTable().requestFocus();
        }
    }

    private void computePaneEdition() {
        int decs = miClient.getSessionXXX().getParamsErp().getDecimalsQuantity();
        double factor = 0;
        STrnDpsStockReturnRow stockReturnRow = null;

        for (STableRow row : moPaneDpsEntries.getTableModel().getTableRows()) {
            stockReturnRow = (STrnDpsStockReturnRow) row;

            factor = ((SSessionCustom) miClient.getSession().getSessionCustom()).getUnitsFactorForQuantity(stockReturnRow.getFkItemId(), stockReturnRow.getFkOriginalUnitId(), stockReturnRow.getFkUnitId());

            stockReturnRow.setOriginalQuantityToReturn((Double) row.getValues().get(COL_QTY));
            stockReturnRow.setPriceUnitary((Double) row.getValues().get(COL_PRI));
            stockReturnRow.setQuantityToReturn(SLibUtilities.round(factor * stockReturnRow.getOriginalQuantityToReturn(), decs));
        }
    }

    private void computeClose() {
        if (moPaneDpsEntries.getTable().isEditing()) {
            moPaneDpsEntries.getTable().getCellEditor().cancelCellEditing();
        }
    }

    private void valueChangedPaneDpsEntries() {
        double stock = 0;
        double used = 0;
        STrnDpsStockReturnRow stockReturnRow = (STrnDpsStockReturnRow) moPaneDpsEntries.getSelectedTableRow();

        if (stockReturnRow == null) {
            jtfQuantityBase.setText("");
            jtfQuantityBaseUnit.setText("");
            jtfQuantityReturned.setText("");
            jtfQuantityReturnedUnit.setText("");
            jtfQuantityPending.setText("");
            jtfQuantityPendingUnit.setText("");
          
            jtfStock.setText("");
            jtfStockUnit.setText("");
            jtfCurrentlyUsed.setText("");
            jtfCurrentlyUsedUnit.setText("");
            jtfAvailable.setText("");
            jtfAvailableUnit.setText("");

            jbViewLots.setEnabled(false);
        }
        else {
            // Document stock return is processed in original units:
        
            jtfQuantityBase.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stockReturnRow.getOriginalQuantityBase()));
            jtfQuantityBaseUnit.setText(stockReturnRow.getAuxOriginalUnitSymbol());
            jtfQuantityReturned.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stockReturnRow.getOriginalQuantityReturned()));
            jtfQuantityReturnedUnit.setText(stockReturnRow.getAuxOriginalUnitSymbol());
            jtfQuantityPending.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stockReturnRow.getOriginalQuantityPending()));
            jtfQuantityPendingUnit.setText(stockReturnRow.getAuxOriginalUnitSymbol());
            
            // Available stock is processed in inventory units:

            try {
                stock = STrnUtilities.obtainStock(miClient, mnYear, stockReturnRow.getFkItemId(), stockReturnRow.getFkUnitId(), SLibConstants.UNDEFINED, manWarehouseKey[0], manWarehouseKey[1], SLibConstants.UNDEFINED, null, (int[]) moParamDiog.getPrimaryKey());
            }
            catch (Exception e) {
                SLibUtilities.printOutException(this, e);
            }

            for (SDataDiogEntry entry : moParamDiog.getDbmsEntries()) {
                for (STrnStockMove move : entry.getAuxStockMoves()) {
                    if (move.getPkItemId() == stockReturnRow.getFkItemId() && move.getPkUnitId() == stockReturnRow.getFkUnitId()) {
                        if (entry.getIsDeleted()) {
                            stock += move.getQuantity();
                        }
                        else {
                            used += move.getQuantity();
                        }
                    }
                }
            }
           
            jtfStock.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stock));
            jtfStockUnit.setText(stockReturnRow.getAuxUnitSymbol());
            jtfCurrentlyUsed.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(used));
            jtfCurrentlyUsedUnit.setText(stockReturnRow.getAuxUnitSymbol());
            jtfAvailable.setText(miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stock - used));
            jtfAvailableUnit.setText(stockReturnRow.getAuxUnitSymbol());

            jbViewLots.setEnabled(true);
        }
    }

    public void actionSupplyAll() {
        STrnDpsStockReturnRow stockReturnRow = null;

        if (jbCleanAll.isEnabled()) {
            computeClose();

            for (STableRow row : moPaneDpsEntries.getTableModel().getTableRows()) {
                stockReturnRow = (STrnDpsStockReturnRow) row;
                stockReturnRow.setQuantityToReturn(stockReturnRow.getQuantityPending());
                stockReturnRow.setPriceUnitary(stockReturnRow.getPriceUnitary());
                
                stockReturnRow.setOriginalQuantityToReturn(stockReturnRow.getOriginalQuantityPending());
                stockReturnRow.prepareTableRow();
            }

            moPaneDpsEntries.renderTableRows();
            moPaneDpsEntries.setTableRowSelection(0);
        }
    }

    public void actionCleanAll() {
        STrnDpsStockReturnRow stockReturnRow = null;

        if (jbCleanAll.isEnabled()) {
            computeClose();

            for (STableRow row : moPaneDpsEntries.getTableModel().getTableRows()) {
                stockReturnRow = (STrnDpsStockReturnRow) row;
                stockReturnRow.setQuantityToReturn(0);
                stockReturnRow.setOriginalQuantityToReturn(0);
                stockReturnRow.prepareTableRow();
            }

            moPaneDpsEntries.renderTableRows();
            moPaneDpsEntries.setTableRowSelection(0);
        }
    }

    public void actionViewLots() {
        STrnDpsStockReturnRow stockSupplyRow = (STrnDpsStockReturnRow) moPaneDpsEntries.getSelectedTableRow();

        if (stockSupplyRow == null) {
            miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_ROW_UNDEF);
        }
        else {
            moPickerStockLots.formReset();
            moPickerStockLots.setFormParams(mnYear, stockSupplyRow.getFkItemId(), stockSupplyRow.getFkUnitId(), moParamDiog.getWarehouseKey(), (int[]) moParamDiog.getPrimaryKey());
            moPickerStockLots.setVisible(true);
        }
    }

    public void actionOk() {
        SFormValidation validation = formValidate();

        if (validation.getIsError()) {
            if (validation.getComponent() != null) {
                validation.getComponent().requestFocus();
            }
            miClient.showMsgBoxWarning(validation.getMessage());
        }
        else {
            computeClose();
            mnFormResult = SLibConstants.FORM_RESULT_OK;
            setVisible(false);
        }
    }

    public void actionCancel() {
        computeClose();
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbCleanAll;
    private javax.swing.JButton jbOk;
    private javax.swing.JButton jbSupplyAll;
    private javax.swing.JButton jbViewLots;
    private javax.swing.JLabel jlAvailable;
    private javax.swing.JLabel jlCurrentlyUsed;
    private javax.swing.JLabel jlPanelDps;
    private javax.swing.JLabel jlQuantityBase;
    private javax.swing.JLabel jlQuantityPending;
    private javax.swing.JLabel jlQuantityReturned;
    private javax.swing.JLabel jlStock;
    private javax.swing.JLabel jlWarehouse;
    private javax.swing.JLabel jlYear;
    private javax.swing.JPanel jpControls;
    private javax.swing.JPanel jpDpsEntries;
    private javax.swing.JPanel jpDpsEntriesControls;
    private javax.swing.JPanel jpDpsEntriesControls1;
    private javax.swing.JPanel jpDpsEntriesControls2;
    private javax.swing.JPanel jpDpsEntriesInfo;
    private javax.swing.JPanel jpDpsEntriesInfo1;
    private javax.swing.JPanel jpDpsEntriesInfo11;
    private javax.swing.JPanel jpDpsEntriesInfo12;
    private javax.swing.JPanel jpDpsEntriesInfo2;
    private javax.swing.JPanel jpDpsEntriesInfo21;
    private javax.swing.JPanel jpDpsEntriesInfo22;
    private javax.swing.JPanel jpDpsEntriesInfo23;
    private javax.swing.JTextField jtfAvailable;
    private javax.swing.JTextField jtfAvailableUnit;
    private javax.swing.JTextField jtfCompanyBranch;
    private javax.swing.JTextField jtfCompanyBranchCode;
    private javax.swing.JTextField jtfCurrentlyUsed;
    private javax.swing.JTextField jtfCurrentlyUsedUnit;
    private javax.swing.JTextField jtfQuantityBase;
    private javax.swing.JTextField jtfQuantityBaseUnit;
    private javax.swing.JTextField jtfQuantityPending;
    private javax.swing.JTextField jtfQuantityPendingUnit;
    private javax.swing.JTextField jtfQuantityReturned;
    private javax.swing.JTextField jtfQuantityReturnedUnit;
    private javax.swing.JTextField jtfStock;
    private javax.swing.JTextField jtfStockUnit;
    private javax.swing.JTextField jtfWarehouse;
    private javax.swing.JTextField jtfWarehouseCode;
    private javax.swing.JTextField jtfYear;
    // End of variables declaration//GEN-END:variables

    @SuppressWarnings("unchecked")
    public void setFormParams(final SDataDps dps, final SDataDiog diog) {
        int[] dpsAdjustmentEntryKey = null;
        int[] dpsEntryKey = null;
        String sql = "";
        ResultSet resulSet = null;

        moPaneDpsEntries.clearTableRows();

        try {
            if (dps == null || diog == null) {
                moParamDps = null;
                moParamDiog = null;
                moPanelDps.setDps(null, null);

                mnYear = 0;
                manWarehouseKey = null;
                moParamCompanyBranch = null;
                moParamWarehouse = null;

                jtfCompanyBranch.setText("");
                jtfCompanyBranchCode.setText("");
                jtfWarehouse.setText("");
                jtfWarehouseCode.setText("");
                jtfYear.setText("");
            }
            else {
                moParamDps = dps;
                moParamDiog = diog;
                moPanelDps.setDps(moParamDps, moParamDiog.getDate());

                mnYear = SLibTimeUtilities.digestYear(moParamDiog.getDate())[0];
                manWarehouseKey = moParamDiog.getWarehouseKey();
                moParamCompanyBranch = (SDataBizPartnerBranch) SDataUtilities.readRegistry(miClient, SDataConstants.BPSU_BPB, new int[] { manWarehouseKey[0] }, SLibConstants.EXEC_MODE_VERBOSE);
                moParamWarehouse = (SDataCompanyBranchEntity) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_COB_ENT, manWarehouseKey, SLibConstants.EXEC_MODE_VERBOSE);

                jtfCompanyBranch.setText(moParamCompanyBranch.getBizPartnerBranch());
                jtfCompanyBranchCode.setText(moParamCompanyBranch.getCode());
                jtfWarehouse.setText(moParamWarehouse.getEntity());
                jtfWarehouseCode.setText(moParamWarehouse.getCode());
                jtfYear.setText(miClient.getSessionXXX().getFormatters().getYearFormat().format(mnYear));

                jtfCompanyBranch.setCaretPosition(0);
                jtfCompanyBranchCode.setCaretPosition(0);
                jtfWarehouse.setCaretPosition(0);
                jtfWarehouseCode.setCaretPosition(0);
                jtfYear.setCaretPosition(0);

                sql = "SELECT de.id_year, de.id_doc, de.id_ety, de.sort_pos, de.fid_item, de.fid_unit, de.fid_orig_unit, d.b_close, " + // 07
                        "i.item_key, i.item, u.symbol AS f_unit, uo.symbol AS f_orig_unit, " +                                          // 11
                        "de.qty AS f_qty, " +                                                                                           // 12
                        "de.orig_qty AS f_orig_qty, " +                                                                                 // 13
                        "COALESCE((SELECT SUM(ge.qty) FROM trn_diog_ety AS ge, trn_diog AS g WHERE " +
                        "ge.fid_dps_adj_year_n = de.id_year AND ge.fid_dps_adj_doc_n = de.id_doc AND ge.fid_dps_adj_ety_n = de.id_ety AND " +
                        "ge.id_year = g.id_year AND ge.id_doc = g.id_doc AND " +
                        "ge.b_del = 0 AND g.b_del = 0 AND " +
                        "NOT (g.id_year = " + moParamDiog.getPkYearId() + " AND g.id_doc = " + moParamDiog.getPkDocId() + ")), 0) AS f_ret_qty, " +     // 14
                        "COALESCE((SELECT SUM(ge.orig_qty) FROM trn_diog_ety AS ge, trn_diog AS g WHERE " +
                        "ge.fid_dps_adj_year_n = de.id_year AND ge.fid_dps_adj_doc_n = de.id_doc AND ge.fid_dps_adj_ety_n = de.id_ety AND " +
                        "ge.id_year = g.id_year AND ge.id_doc = g.id_doc AND " +
                        "ge.b_del = 0 AND g.b_del = 0 AND " +
                        "NOT (g.id_year = " + moParamDiog.getPkYearId() + " AND g.id_doc = " + moParamDiog.getPkDocId() + ")), 0) AS f_ret_orig_qty, " + // 15
                        "di.num_ser, di.num, di.dt, dit.code " +    // 19
                        "FROM trn_dps AS d " +
                        "INNER JOIN trn_dps_ety AS de ON d.id_year = de.id_year AND d.id_doc = de.id_doc AND " +
                        "de.b_del = 0 AND de.b_inv = 1 AND de.qty > 0 AND de.orig_qty > 0 AND de.fid_tp_dps_adj = " + SDataConstantsSys.TRNS_TP_DPS_ADJ_RET + " AND " +
                        "d.id_year = " + moParamDps.getPkYearId() + " AND d.id_doc = " + moParamDps.getPkDocId() + " " +
                        "INNER JOIN erp.itmu_item AS i ON de.fid_item = i.id_item " +
                        "INNER JOIN erp.itmu_unit AS u ON de.fid_unit = u.id_unit " +
                        "INNER JOIN erp.itmu_unit AS uo ON de.fid_orig_unit = uo.id_unit " +
                        "INNER JOIN trn_dps_dps_adj AS dda ON de.id_year = dda.id_adj_year AND de.id_doc = dda.id_adj_doc AND de.id_ety = dda.id_adj_ety " +
                        "INNER JOIN trn_dps AS di ON dda.id_dps_year = di.id_year AND dda.id_dps_doc = di.id_doc " +
                        "INNER JOIN erp.trnu_tp_dps AS dit ON di.fid_ct_dps = dit.id_ct_dps AND di.fid_cl_dps = dit.id_cl_dps AND di.fid_tp_dps = dit.id_tp_dps " +
                        "GROUP BY de.id_year, de.id_doc, de.id_ety, de.sort_pos, de.fid_item, de.fid_unit, de.fid_orig_unit, d.b_close, " +
                        "i.item_key, i.item, u.symbol, uo.symbol, de.qty, de.orig_qty, " +
                        "di.num_ser, di.num, di.dt, dit.tp_dps " +
                        "HAVING (f_orig_qty - f_ret_orig_qty) <> 0 AND d.b_close = 0 " +
                        "ORDER BY de.sort_pos; ";

                resulSet = miClient.getSession().getStatement().executeQuery(sql);
                while (resulSet.next()) {
                    STrnDpsStockReturnRow stockReturnRow = null;

                    dpsAdjustmentEntryKey = new int[] { resulSet.getInt(1), resulSet.getInt(2), resulSet.getInt(3) };
                    dpsEntryKey = moParamDps.getDbmsDpsEntry(dpsAdjustmentEntryKey).getDbmsDpsAdjustmentsAsAdjustment().firstElement().getDbmsDpsEntryKey();

                    stockReturnRow = new STrnDpsStockReturnRow(dpsAdjustmentEntryKey, dpsEntryKey);
                    stockReturnRow.setSortingPosition(resulSet.getInt(4));
                    stockReturnRow.setQuantityBase(resulSet.getInt(13));
                    stockReturnRow.setOriginalQuantityBase(resulSet.getDouble(14));
                    stockReturnRow.setQuantityReturned(resulSet.getDouble(15));
                    stockReturnRow.setOriginalQuantityReturned(resulSet.getDouble(16));
                    stockReturnRow.setQuantityToReturn(0);
                    stockReturnRow.setOriginalQuantityToReturn(0);
                    stockReturnRow.setFkItemId(resulSet.getInt(5));
                    stockReturnRow.setFkUnitId(resulSet.getInt(6));
                    stockReturnRow.setFkOriginalUnitId(resulSet.getInt(7));
                    stockReturnRow.setAuxItem(resulSet.getString(10));
                    stockReturnRow.setAuxItemKey(resulSet.getString(9));
                    stockReturnRow.setAuxUnitSymbol(resulSet.getString(11));
                    stockReturnRow.setAuxOriginalUnitSymbol(resulSet.getString(12));
                    stockReturnRow.setAuxDocNumberSeries(resulSet.getString(17));
                    stockReturnRow.setAuxDocNumber(resulSet.getString(18));
                    stockReturnRow.setAuxDocType(resulSet.getString(20));
                    stockReturnRow.setAuxDocDate(resulSet.getDate(19));
                    stockReturnRow.setPriceUnitary(0);                    
                    
                    for (SDataDiogEntry diogEntry : moParamDiog.getDbmsEntries()) {
                        if (!diogEntry.getIsDeleted()) {
                            if (SLibUtilities.compareKeys(stockReturnRow.getDpsAdjustmentEntryKey(), diogEntry.getLinkedDpsAdjustmentEntryKey_n())) {
                                stockReturnRow.setQuantityReturned(stockReturnRow.getQuantityReturned() + diogEntry.getQuantity());
                                stockReturnRow.setOriginalQuantityReturned(stockReturnRow.getOriginalQuantityReturned() + diogEntry.getOriginalQuantity());
                            }
                        }
                    }

                    stockReturnRow.prepareTableRow();
                    moPaneDpsEntries.addTableRow(stockReturnRow);
                }

                if (moPaneDpsEntries.getTableGuiRowCount() > 0) {
                    moPaneDpsEntries.renderTableRows();
                    moPaneDpsEntries.setTableRowSelection(0);
                    moPaneDpsEntries.setTableColumnSelection(COL_QTY);
                }
            }
        }
        catch (Exception e) {
           SLibUtilities.renderException(this, e);
       }
    }

    public java.util.Vector<erp.mtrn.data.STrnDpsStockReturnRow> obtainDpsStockReturnRows() {
        Vector<STrnDpsStockReturnRow> stockReturnRows = new Vector<STrnDpsStockReturnRow>();

        computePaneEdition();   // updates user edition into internal pane data objects

        for (STableRow row : moPaneDpsEntries.getTableModel().getTableRows()) {
            if (((STrnDpsStockReturnRow) row).getOriginalQuantityToReturn() > 0) {
                stockReturnRows.add((STrnDpsStockReturnRow) row);
            }
        }

        return stockReturnRows;
    }

    public int getFormResult() {
        return mnFormResult;
    }

    public int getFormStatus() {
        return mnFormStatus;
    }

    public void formReset() {
        mnFormResult = SLibConstants.UNDEFINED;
        mnFormStatus = SLibConstants.UNDEFINED;
        mbFirstTime = true;
    }

    public erp.lib.form.SFormValidation formValidate() {
        int supplies = 0;
        STrnDpsStockReturnRow stockReturnRow = null;
        SFormValidation validation = new SFormValidation();

        computePaneEdition();   // updates user edition into internal pane data objects

        for (int row = 0; row < moPaneDpsEntries.getTableModel().getTableRows().size(); row++) {
            stockReturnRow = (STrnDpsStockReturnRow) moPaneDpsEntries.getTableRow(row);

            if (stockReturnRow.getOriginalQuantityToReturn() < 0) {
                validation.setMessage(SLibConstants.MSG_ERR_GUI_FIELD_VALUE_DIF + "'" + moPaneDpsEntries.getTableColumn(COL_QTY).getColumnTitle() + "' en la fila " + (row + 1) + ".\n" +
                        "El valor no puede ser negativo.");
                validation.setComponent(moPaneDpsEntries.getTable());
                break;
            }
            else if (stockReturnRow.getOriginalQuantityToReturn() > stockReturnRow.getOriginalQuantityPending()) {
                validation.setMessage(SLibConstants.MSG_ERR_GUI_FIELD_VALUE_DIF + "'" + moPaneDpsEntries.getTableColumn(COL_QTY).getColumnTitle() + "' en la fila " + (row + 1) + ".\n" +
                        "El valor no puede ser mayor a " + miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stockReturnRow.getOriginalQuantityPending()) + ".");
                validation.setComponent(moPaneDpsEntries.getTable());
                break;
            }
            else if (stockReturnRow.getOriginalQuantityToReturn() > 0 && stockReturnRow.getQuantityToReturn() <= 0) {
                validation.setMessage("No se pudo calcular la equivalencia en unidades de inventario del valor '" + moPaneDpsEntries.getTableColumn(COL_QTY).getColumnTitle() + "' en la fila " + (row + 1) + ".\n" +
                        "El valor calculado es " + miClient.getSessionXXX().getFormatters().getDecimalsQuantityFormat().format(stockReturnRow.getQuantityToReturn()) + ".");
                validation.setComponent(moPaneDpsEntries.getTable());
                break;
            }
            else if (stockReturnRow.getOriginalQuantityToReturn() > 0) {
                supplies++;
            }
        }

        if (!validation.getIsError()) {
            if (supplies == 0) {
                validation.setMessage("No se ha especificado el surtido al menos para una de las partidas.");
                validation.setComponent(moPaneDpsEntries.getTable());
            }
        }
        else if (! SStockValuationUtils.canCreateDiogByValuation(miClient.getSession(), moParamDiog.getDate())) {
            validation.setMessage("No se puede crear el movimiento porque hay una valuación de inventarios para la fecha " + "'" + SLibUtils.DateFormatDate.format(moParamDiog.getDate()) + "'");
        }

        return validation;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbOk) {
                actionOk();
            }
            else if (button == jbCancel) {
                actionCancel();
            }
            else if (button == jbSupplyAll) {
                actionSupplyAll();
            }
            else if (button == jbCleanAll) {
                actionCleanAll();
            }
            else if (button == jbViewLots) {
                actionViewLots();
            }
        }
    }

    @Override
    public void valueChanged(ListSelectionEvent e) {
        if (!e.getValueIsAdjusting()) {
            valueChangedPaneDpsEntries();
        }
    }
}
