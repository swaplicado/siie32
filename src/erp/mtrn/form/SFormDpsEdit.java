/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * SFormDpsEdit.java
 *
 * Created on 08/09/2020, 04:48:00 PM
 */

package erp.mtrn.form;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataUtilities;
import erp.form.SFormOptionPicker;
import erp.form.SFormOptionPickerItems;
import erp.lib.SLibConstants;
import erp.lib.SLibUtilities;
import erp.lib.data.SDataRegistry;
import erp.lib.form.SFormUtilities;
import erp.lib.form.SFormValidation;
import erp.lib.table.STableColumnForm;
import erp.lib.table.STableConstants;
import erp.lib.table.STablePane;
import erp.mfin.data.SDataCostCenter;
import erp.mitm.data.SDataItem;
import erp.mod.fin.db.SFinUtils;
import erp.mtrn.data.SDataDps;
import erp.mtrn.data.SDataDpsEntry;
import erp.mtrn.data.SDataDpsEntryEdit;
import erp.mtrn.data.SRowDpsEdit;
import erp.redis.SLockUtils;
import erp.server.SServerConstants;
import erp.server.SServerRequest;
import erp.server.SServerResponse;
import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.KeyEvent;
import java.sql.ResultSet;
import java.text.DecimalFormat;
import java.util.ArrayList;
import javax.swing.AbstractAction;
import javax.swing.JLabel;
import sa.lib.SLibUtils;
import sa.lib.srv.SLock;
import sa.lib.srv.SSrvConsts;

/**
 * Modificar el ítem de referencia y el centro de costo de un documento y de todos los documentos asociados a este, sin necesidad de editar cada documento de forma manual.
 * @author Isabel Servín, Adrián Avilés
 */
public class SFormDpsEdit extends javax.swing.JDialog implements erp.lib.form.SFormInterface, java.awt.event.ActionListener {
    
    private final erp.client.SClientInterface miClient;
    private int mnFormResult;
    private boolean mbFirstTime;
    private boolean mbDocumentsLockedError;
    private erp.lib.table.STablePane moDocEntriesTablePane; 
    
    private SDataDps moDps;
    private SDataDpsEntryEdit moDpsEntryEdit;
    
    private SPanelDps moPanelDps;
    private SFormDpsEditQty moFormDpsEditQty;
    private SFormOptionPicker moPickerCostCenter;
    private SFormOptionPickerItems moPickerItems;
    
    private int mnFormStatus;
    private final int mnFormType;
    
    private ArrayList<SDataDps> moDocuments;
    private ArrayList<int[]> moUpdateDocumentEntryKeys;
    
    private double mdTotalDpsOld;
    
    private DecimalFormat moAmountFormat;

    /** Creates new form SFormCfdiChangeItem
     * @param client
     */
    public SFormDpsEdit(erp.client.SClientInterface client) {
        super(client.getFrame(), true);
        mnFormType = SDataConstants.TRNX_DPS_EDIT;
        miClient = client;
        initComponents();
     
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jpCfdiChangeItem = new javax.swing.JPanel();
        jpDpsData = new javax.swing.JPanel();
        jpHeader = new javax.swing.JPanel();
        jlPanelDps = new javax.swing.JLabel();
        jpDpsConcepts = new javax.swing.JPanel();
        jpConceptsGrid = new javax.swing.JPanel();
        jpConceptsDataNorth = new javax.swing.JPanel();
        jpConceptSetup = new javax.swing.JPanel();
        jbEditQty = new javax.swing.JButton();
        jbSelectCostCenter = new javax.swing.JButton();
        jbSelectReferenceItem = new javax.swing.JButton();
        jbDeleteReferenceItem = new javax.swing.JButton();
        jpDpsTotal = new javax.swing.JPanel();
        jlTotalDpsOld = new javax.swing.JLabel();
        jtfTotalDpsOld = new javax.swing.JTextField();
        jtfCurrencyDpsOld = new javax.swing.JTextField();
        jlTotalDpsNew = new javax.swing.JLabel();
        jtfTotalDpsNew = new javax.swing.JTextField();
        jtfCurrencyDpsNew = new javax.swing.JTextField();
        jlDiff = new javax.swing.JLabel();
        jtfDiff = new javax.swing.JTextField();
        jtfDiffCurrencyKey = new javax.swing.JTextField();
        jpControls = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Cambiar ítem de documento de compras-ventas.");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jpCfdiChangeItem.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del registro:"));
        jpCfdiChangeItem.setLayout(new java.awt.BorderLayout());

        jpDpsData.setLayout(new java.awt.BorderLayout());

        jpHeader.setLayout(new java.awt.BorderLayout());

        jlPanelDps.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jlPanelDps.setText("[Panel de documento de compras-ventas]");
        jlPanelDps.setPreferredSize(new java.awt.Dimension(100, 200));
        jpHeader.add(jlPanelDps, java.awt.BorderLayout.CENTER);

        jpDpsData.add(jpHeader, java.awt.BorderLayout.CENTER);

        jpCfdiChangeItem.add(jpDpsData, java.awt.BorderLayout.NORTH);

        jpDpsConcepts.setBorder(javax.swing.BorderFactory.createTitledBorder("Partidas del documento:"));
        jpDpsConcepts.setLayout(new java.awt.BorderLayout(0, 5));

        jpConceptsGrid.setName(""); // NOI18N
        jpConceptsGrid.setLayout(new java.awt.BorderLayout());
        jpDpsConcepts.add(jpConceptsGrid, java.awt.BorderLayout.CENTER);

        jpConceptsDataNorth.setLayout(new java.awt.BorderLayout());

        jpConceptSetup.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jbEditQty.setText("Cambiar cantidad");
        jbEditQty.setPreferredSize(new java.awt.Dimension(180, 23));
        jpConceptSetup.add(jbEditQty);

        jbSelectCostCenter.setText("Cambiar centro costo");
        jbSelectCostCenter.setPreferredSize(new java.awt.Dimension(180, 23));
        jpConceptSetup.add(jbSelectCostCenter);

        jbSelectReferenceItem.setText("Cambiar ítem referencia");
        jbSelectReferenceItem.setPreferredSize(new java.awt.Dimension(180, 23));
        jpConceptSetup.add(jbSelectReferenceItem);

        jbDeleteReferenceItem.setText("Eliminar ítem referencia");
        jbDeleteReferenceItem.setPreferredSize(new java.awt.Dimension(180, 23));
        jpConceptSetup.add(jbDeleteReferenceItem);

        jpConceptsDataNorth.add(jpConceptSetup, java.awt.BorderLayout.CENTER);

        jpDpsConcepts.add(jpConceptsDataNorth, java.awt.BorderLayout.NORTH);

        jpCfdiChangeItem.add(jpDpsConcepts, java.awt.BorderLayout.CENTER);

        jpDpsTotal.setBorder(javax.swing.BorderFactory.createTitledBorder("Totales del documento:"));
        jpDpsTotal.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlTotalDpsOld.setText("Total anterior:");
        jlTotalDpsOld.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsTotal.add(jlTotalDpsOld);

        jtfTotalDpsOld.setEditable(false);
        jtfTotalDpsOld.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfTotalDpsOld.setText("0,000,000.0000");
        jtfTotalDpsOld.setPreferredSize(new java.awt.Dimension(125, 23));
        jpDpsTotal.add(jtfTotalDpsOld);

        jtfCurrencyDpsOld.setEditable(false);
        jtfCurrencyDpsOld.setText("CUR");
        jtfCurrencyDpsOld.setFocusable(false);
        jtfCurrencyDpsOld.setPreferredSize(new java.awt.Dimension(35, 23));
        jpDpsTotal.add(jtfCurrencyDpsOld);

        jlTotalDpsNew.setText("     Total nuevo:");
        jlTotalDpsNew.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsTotal.add(jlTotalDpsNew);

        jtfTotalDpsNew.setEditable(false);
        jtfTotalDpsNew.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jtfTotalDpsNew.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfTotalDpsNew.setText("0,000,000,000.00");
        jtfTotalDpsNew.setFocusable(false);
        jtfTotalDpsNew.setPreferredSize(new java.awt.Dimension(125, 23));
        jpDpsTotal.add(jtfTotalDpsNew);

        jtfCurrencyDpsNew.setEditable(false);
        jtfCurrencyDpsNew.setText("CUR");
        jtfCurrencyDpsNew.setFocusable(false);
        jtfCurrencyDpsNew.setPreferredSize(new java.awt.Dimension(35, 23));
        jpDpsTotal.add(jtfCurrencyDpsNew);

        jlDiff.setText("     Diferencia:");
        jlDiff.setPreferredSize(new java.awt.Dimension(100, 23));
        jpDpsTotal.add(jlDiff);

        jtfDiff.setEditable(false);
        jtfDiff.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfDiff.setText("0,000,000.0000");
        jtfDiff.setPreferredSize(new java.awt.Dimension(125, 23));
        jpDpsTotal.add(jtfDiff);

        jtfDiffCurrencyKey.setEditable(false);
        jtfDiffCurrencyKey.setText("CUR");
        jtfDiffCurrencyKey.setFocusable(false);
        jtfDiffCurrencyKey.setPreferredSize(new java.awt.Dimension(35, 23));
        jpDpsTotal.add(jtfDiffCurrencyKey);

        jpCfdiChangeItem.add(jpDpsTotal, java.awt.BorderLayout.PAGE_END);

        getContentPane().add(jpCfdiChangeItem, java.awt.BorderLayout.CENTER);

        jpControls.setPreferredSize(new java.awt.Dimension(392, 33));
        jpControls.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jpControls.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setToolTipText("[Escape]");
        jbCancel.setPreferredSize(new java.awt.Dimension(75, 23));
        jpControls.add(jbCancel);

        getContentPane().add(jpControls, java.awt.BorderLayout.SOUTH);

        setSize(new java.awt.Dimension(1040, 708));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    private void windowActivated() {
        if (mbFirstTime) {
            mbFirstTime = false;
            moDocEntriesTablePane.getTable().requestFocus();
        }
        
        if (mbDocumentsLockedError) {
            /* Bloque de codigo de respaldo correspondiente a la version antigua sin Redis de candado de acceso exclusivo a registro
            releaseDpsUserLock();
            */
            /* Bloque de codigo de respaldo correspondiente a la version con Redis de candado de acceso exclusivo a registro
            releaseDpsUserRedisLock();
            */
            releaseDpsUserSLock();
            setVisible(false);
        }
        else if (! SDataUtilities.isPeriodOpen(miClient, moDps.getDateDoc())) {
            miClient.showMsgBoxWarning("¡El periodo contable de la fecha del documento está cerrado!");
            releaseDpsUserSLock();
            setVisible(false);
        }
    }
    
    private void initComponentsExtra() {
        moAmountFormat = miClient.getSessionXXX().getFormatters().getDecimalsValueFormat();
        
        // Tabla general (conceptos):
        int i = 0;
        STableColumnForm[] columns;
        
        moDocEntriesTablePane = new STablePane(miClient);
        jpConceptsGrid.add(moDocEntriesTablePane, BorderLayout.CENTER);

        columns = new STableColumnForm[19];
      
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_INTEGER, "#", STableConstants.WIDTH_NUM_TINYINT);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Clave concepto", STableConstants.WIDTH_ITEM_KEY);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Concepto", 250);
        columns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Precio u. $", STableConstants.WIDTH_VALUE_UNITARY);
        columns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValueUnitaryFixed4());
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Moneda", STableConstants.WIDTH_UNIT_SYMBOL);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Cantidad anterior", STableConstants.WIDTH_QUANTITY);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Unidad", STableConstants.WIDTH_UNIT_SYMBOL);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Total partida anterior $", STableConstants.WIDTH_VALUE_2X);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Cantidad nueva", STableConstants.WIDTH_QUANTITY);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Unidad", STableConstants.WIDTH_UNIT_SYMBOL);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Total partida nuevo $", STableConstants.WIDTH_VALUE_2X);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "No. centro costo anterior", STableConstants.WIDTH_ACCOUNT_ID);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Centro costo anterior", STableConstants.WIDTH_ACCOUNT);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "No. centro costo nuevo", STableConstants.WIDTH_ACCOUNT_ID);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Centro costo nuevo", STableConstants.WIDTH_ACCOUNT);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Código ítem referencia anterior", STableConstants.WIDTH_ITEM_KEY);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Ítem referencia anterior", 250);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Código ítem referencia nuevo", STableConstants.WIDTH_ITEM_KEY);
        columns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Ítem referencia nuevo", 250);
        
        for (i = 0; i < columns.length; i++) {
            moDocEntriesTablePane.addTableColumn(columns[i]);
        }
        
        // Listeners:
        
        jbOk.addActionListener(this);
        jbCancel.addActionListener(this);
        jbEditQty.addActionListener(this);
        jbSelectCostCenter.addActionListener(this);
        jbSelectReferenceItem.addActionListener(this);
        jbDeleteReferenceItem.addActionListener(this);
        
        AbstractAction actionOk = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionOk(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionOk, "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);

        AbstractAction actionCancel = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionCancel(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionCancel, "cancel", KeyEvent.VK_ESCAPE, 0);
        
        // Activar o desactivar componentes:
        
        jbSelectReferenceItem.setEnabled(true);
        jbSelectCostCenter.setEnabled(true); 
        jbDeleteReferenceItem.setEnabled(true); 
        
        moPanelDps = new SPanelDps(miClient);
        jpHeader.remove(jlPanelDps); 
        jpHeader.add(moPanelDps, BorderLayout.CENTER);
    }
    
    private void getAssociatedDocuments(SDataDps dps) {
        boolean contains = false;
        for (SDataDps document : moDocuments) {
            if (SLibUtilities.compareKeys((int[]) document.getPrimaryKey(), (int[]) dps.getPrimaryKey())){
                contains = true;
                break;
            }
        }
        if (!contains) {
            moDocuments.add(dps);
            ArrayList<int[]> assocDocs = new ArrayList<>();
            try {
                for (int i = 0; i < dps.getDbmsDpsEntries().size(); i++) {
                    int dpsClass = dps.getDpsClassKey()[1];
                    int[] entryKey = (int[]) dps.getDbmsDpsEntries().get(i).getPrimaryKey(); 
                    
                    String sql;
                    
                    // Busqueda hacia arriba (trn_dps_dps_supply):
                    if (dpsClass != SDataConstantsSys.TRNS_CL_DPS_EST && dpsClass != SDataConstantsSys.TRNS_CL_DPS_ADJ) {
                        sql = "SELECT id_src_year AS year, id_src_doc AS doc FROM trn_dps_dps_supply AS tdds "
                                + "WHERE id_des_year = " + entryKey[0] + " AND id_des_doc = " + entryKey[1] + " AND id_des_ety = " + entryKey[2] + "";    
                        assocDocs = getDocuments(sql, assocDocs, false);
                    }
                    
                    // Busqueda hacia abajo (trn_dps_dps_supply): 
                    if (dpsClass != SDataConstantsSys.TRNS_CL_DPS_DOC && dpsClass != SDataConstantsSys.TRNS_CL_DPS_ADJ) {
                        sql = "SELECT id_des_year AS year, id_des_doc AS doc FROM trn_dps_dps_supply AS tdds "
                                + "WHERE id_src_year = " + entryKey[0] + " AND id_src_doc = " + entryKey[1] + " AND id_src_ety = " + entryKey[2] + "";  
                        assocDocs = getDocuments(sql, assocDocs, false);
                    }
                    
                    // Busqueda hacia arriba (trn_dps_dps_adj):
                    if (dpsClass == SDataConstantsSys.TRNS_CL_DPS_ADJ) {
                        sql = "SELECT id_dps_year AS year, id_dps_doc AS doc FROM trn_dps_dps_adj AS tdda " 
                                + "WHERE id_adj_year = " + entryKey[0] + " AND id_adj_doc = " + entryKey[1] + " AND id_adj_ety = " + entryKey[2] + "";
                        assocDocs = getDocuments(sql, assocDocs, false);
                    }
                    
                    // Busqueda hacia abajo (trn_dps_dps_adj):
                    if (dpsClass == SDataConstantsSys.TRNS_CL_DPS_DOC) {
                        sql = "SELECT id_adj_year AS year, id_adj_doc AS doc FROM trn_dps_dps_adj AS tdda " 
                                + "WHERE id_dps_year = " + entryKey[0] + " AND id_dps_doc = " + entryKey[1] + " AND id_dps_ety = " + entryKey[2] + "";
                        assocDocs = getDocuments(sql, assocDocs, false);
                    }
                
                assocDocs.stream().map((assocDoc) -> (SDataDps) SDataUtilities.readRegistry(miClient,
                        SDataConstants.TRN_DPS, assocDoc, SLibConstants.EXEC_MODE_SILENT)).forEach((dpsAux) -> {
                            getAssociatedDocuments(dpsAux);
                        });
                }
            }
            catch (Exception e) {
                miClient.showMsgBoxWarning(e.getMessage());
            }
        }
    }
    
    private ArrayList<int[]> getDocuments(String sql, ArrayList<int[]> docs, boolean isToUpdate) throws Exception {
        try (ResultSet resultSet = miClient.getSession().getStatement().executeQuery(sql)) {
            while (resultSet.next()) {
                int auxKey[];
                if (isToUpdate) {
                    auxKey = new int[] { resultSet.getInt("year"), resultSet.getInt("doc"), resultSet.getInt("ety") };
                }
                else {
                    auxKey = new int[] { resultSet.getInt("year"), resultSet.getInt("doc") };
                }
                boolean insert = true;
                for (int[] doc : docs) {
                    if (SLibUtilities.compareKeys(doc, auxKey)) {
                        insert = false;
                        break;
                    }
                }
                if (insert) {
                    docs.add(auxKey);
                }
            }
        }
        return docs;
    }
    
    private boolean lockDocuments() {
        boolean error = false;
        for (SDataDps document : moDocuments) {
            error = readDpsUser(document);
            if (error) {
                return error;
            }
        }
        return error;
    }
    
    private boolean readDpsUser(SDataDps dps) {
        boolean error = true;

        if (dps != moDps) {
            if (dps != null) { 
                /* Bloque de codigo de respaldo correspondiente a la version antigua sin Redis de candado de acceso exclusivo a registro
                SSrvLock lock = gainDpsUserLock(dps);
                if (lock != null) {
                    dps.setAuxUserLock(lock);
                    error = false;
                }
                */
                /* Bloque de codigo de respaldo correspondiente a la version con Redis de candado de acceso exclusivo a registro
                SRedisLock rlock = gainDpsUserRedisLock(dps);
                if (rlock != null) {
                    dps.setAuxUserRedisLock(rlock);
                    error = false;
                }
                */
                SLock slock = gainDpsUserSLock(dps);
                if (slock != null) {
                    dps.setAuxUserSLock(slock);
                    error = false;
                }
            }
        }
        else error = false;

        return error;
    }

    /* Bloque de codigo de respaldo correspondiente a la version antigua sin Redis de candado de acceso exclusivo a registro
    private sa.lib.srv.SSrvLock gainDpsUserLock(SDataDps dps) {
        SSrvLock lock;

        try {
            lock = SSrvUtils.gainLock(miClient.getSession(), miClient.getSessionXXX().getCompany().getPkCompanyId(), SDataConstants.TRN_DPS, dps.getPrimaryKey(), dps.getRegistryTimeout());
        }
        catch (Exception e) {
            lock = null;
            miClient.showMsgBoxWarning("No fue posible obtener el acceso exclusivo al registro '" + 
                    SLibUtils.DateFormatDateYearMonth.format(dps.getDateDoc()) + " " + dps.getNumberSeries() + dps.getNumber() + "'.\n" + e);
        }

        return lock;
    }
    
    private void releaseDpsUserLock() {
        moDocuments.stream().forEach((document) -> {
            sa.lib.srv.SSrvLock lock = document.getAuxUserLock();
            if (lock != null) {
                try {
                    SSrvUtils.releaseLock(miClient.getSession(), lock);
                    document.setAuxUserLock(null);
                }
                catch (Exception e) {
                    miClient.showMsgBoxWarning("No fue posible liberar el acceso exclusivo del registro '" + 
                            SLibUtils.DateFormatDateYearMonth.format(document.getDateDoc()) + " " + document.getNumberSeries() + document.getNumber() + "'.\n" + e);
                }
            }
        });
    }
    */
    
    /* Bloque de codigo de respaldo correspondiente a la version con Redis de candado de acceso exclusivo a registro
    private sa.lib.srv.redis.SRedisLock gainDpsUserRedisLock(SDataDps dps) {
        SRedisLock rlock;

        try {
            rlock = SRedisLockUtils.gainLock(miClient, SDataConstants.TRN_DPS, dps.getPrimaryKey(), dps.getRegistryTimeout() / 1000);
        }
        catch (Exception e) {
            rlock = null;
            miClient.showMsgBoxWarning("No fue posible obtener el acceso exclusivo al registro '" + 
                    SLibUtils.DateFormatDateYearMonth.format(dps.getDateDoc()) + " " + dps.getNumberSeries() + dps.getNumber() + "'.\n" + e);
        }

        return rlock;
    }
    
    private void releaseDpsUserRedisLock() {
        moDocuments.stream().forEach((document) -> {
            sa.lib.srv.redis.SRedisLock rlock = document.getAuxUserRedisLock();
            if (rlock != null) {
                try {
                    SRedisLockUtils.releaseLock(miClient, rlock);
                    document.setAuxUserRedisLock(null);
                }
                catch (Exception e) {
                    miClient.showMsgBoxWarning("No fue posible liberar el acceso exclusivo del registro '" + 
                            SLibUtils.DateFormatDateYearMonth.format(document.getDateDoc()) + " " + document.getNumberSeries() + document.getNumber() + "'.\n" + e);
                }
            }
        });
    }
    */
    
    private sa.lib.srv.SLock gainDpsUserSLock(SDataDps dps) {
        SLock slock;

        try {
            slock = SLockUtils.gainLock(miClient, SDataConstants.TRN_DPS, dps.getPrimaryKey(), dps.getRegistryTimeout());
        }
        catch (Exception e) {
            slock = null;
            miClient.showMsgBoxWarning("No fue posible obtener el acceso exclusivo al registro '" + 
                    SLibUtils.DateFormatDateYearMonth.format(dps.getDateDoc()) + " " + dps.getNumberSeries() + dps.getNumber() + "'.\n" + e);
        }

        return slock;
    }
    
    private void releaseDpsUserSLock() {
        moDocuments.stream().forEach((document) -> {
            sa.lib.srv.SLock slock = document.getAuxUserSLock();
            if (slock != null) {
                try {
                    SLockUtils.releaseLock(miClient, slock);
                    document.setAuxUserSLock(null);
                }
                catch (Exception e) {
                    miClient.showMsgBoxWarning("No fue posible liberar el acceso exclusivo del registro '" + 
                            SLibUtils.DateFormatDateYearMonth.format(document.getDateDoc()) + " " + document.getNumberSeries() + document.getNumber() + "'.\n" + e);
                }
            }
        });
    }
    
    private void populateTable() {
        moDocEntriesTablePane.createTable();
        
        for (int i = 0; i < moDps.getDbmsDpsEntries().size(); i++) {
            SRowDpsEdit row = new SRowDpsEdit(miClient, moDps.getDbmsDpsEntries().get(i), moDps.getDbmsCurrencyKey());
            moDocEntriesTablePane.addTableRow(row);
        }
        
        moDocEntriesTablePane.renderTableRows();
        moDocEntriesTablePane.setTableRowSelection(0);
        moDocEntriesTablePane.getTable().getTableHeader().setReorderingAllowed(false);
    }
    
    private void actionEditQty() {
        if (jbEditQty.isEnabled()) {
            int selectedRow = moDocEntriesTablePane.getTable().getSelectedRow();
            if (selectedRow == -1) {
                miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_ROW_UNDEF); 
            }
            else {
                SRowDpsEdit rowDpsEdit = (SRowDpsEdit) moDocEntriesTablePane.getSelectedTableRow();
                SDataDpsEntry dpsEty = moDps.getDbmsDpsEntry((int[]) rowDpsEdit.getDpsEntryPK());
                if (moFormDpsEditQty == null) {        
                    moFormDpsEditQty = new SFormDpsEditQty(miClient);
                }
                moFormDpsEditQty.formReset();
                moFormDpsEditQty.setValue(SDataConstants.TRN_DPS, new Object[] { moDps, rowDpsEdit.getDpsEntryPK() });
                moFormDpsEditQty.setFormVisible(true);
                
                if (moFormDpsEditQty.getFormResult() == SLibConstants.FORM_RESULT_OK) {
                    double newQty = (double) moFormDpsEditQty.getValue(SFormDpsEditQty.TRN_DPS_QTY_VALUE);
                    dpsEty.setOriginalQuantity(newQty);
                    dpsEty.calculateTotal(
                            miClient, moDps.getDate(), 
                            moDps.getFkTaxIdentityEmisorTypeId(), moDps.getFkTaxIdentityReceptorTypeId(), 
                            moDps.getIsDiscountDocPercentage(), moDps.getDiscountDocPercentage(), moDps.getExchangeRate());
                    rowDpsEdit.setDpsEntry(dpsEty);
                    try {
                        moDps.calculateTotal(miClient);
                        jtfTotalDpsNew.setText(moAmountFormat.format(moDps.getTotalCy_r()));
                        jtfDiff.setText(moAmountFormat.format(mdTotalDpsOld - moDps.getTotalCy_r()));
                        jtfDiffCurrencyKey.setText(moDps.getDbmsCurrencyKey());
                    }
                    catch (Exception e) {
                        SLibUtils.printException(this, e);
                    }
                    rowDpsEdit.setOriginalQuantityNew(newQty);
                    rowDpsEdit.prepareTableRow();
                    moDocEntriesTablePane.renderTableRows();
                    moDocEntriesTablePane.setTableRowSelection(selectedRow);
                }
            }
        }
    }

    private void actionSelectCostCenter() {
        if (jbSelectCostCenter.isEnabled()) {
            int selectedRow = moDocEntriesTablePane.getTable().getSelectedRow();
            if (selectedRow == -1) {
                miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_ROW_UNDEF); 
            }
            else {
                SRowDpsEdit rowDpsEdit = (SRowDpsEdit) moDocEntriesTablePane.getSelectedTableRow();
                if (moPickerCostCenter == null) {        
                    moPickerCostCenter = SFormOptionPicker.createOptionPicker(miClient, SDataConstants.FIN_CC, moPickerCostCenter);
                }
                moPickerCostCenter.formReset();
                moPickerCostCenter.formRefreshOptionPane();
                try {
                    moPickerCostCenter.setSelectedPrimaryKey(SDataUtilities.obtainCostCenterItem(miClient.getSession(), rowDpsEdit.getItemRefNew() == null ? 
                            rowDpsEdit.getItemRefOld().getPkItemId() : rowDpsEdit.getItemRefNew().getPkItemId()));
                }
                catch (Exception e){
                    SLibUtils.printException(this, e);
                }
                moPickerCostCenter.setFormVisible(true); 

                Object key;
                if (moPickerCostCenter.getFormResult() == SLibConstants.FORM_RESULT_OK) {
                    key = moPickerCostCenter.getSelectedPrimaryKey();
                    SDataCostCenter costCenter = (SDataCostCenter) SDataUtilities.readRegistry(miClient,
                            SDataConstants.FIN_CC, key, SLibConstants.EXEC_MODE_SILENT);
                    if (costCenter != null && SFinUtils.isCostCenterMaxLevel(miClient.getSession(), costCenter.getPkCostCenterIdXXX())) {
                        rowDpsEdit.setCostCenterNew(costCenter);
                        rowDpsEdit.prepareTableRow();
                        moDocEntriesTablePane.renderTableRows();
                        moDocEntriesTablePane.setTableRowSelection(selectedRow);
                    }
                    else {
                        miClient.showMsgBoxInformation("No se puede seleccionar el centro de costo elegido debido a que no tiene la profundidad necesaria.");
                    }
                }
            }
        }
    }
    
    private void actionSelectItemReference() { 
        if (jbSelectReferenceItem.isEnabled()) {
            int selectedRow = moDocEntriesTablePane.getTable().getSelectedRow();
            
            if (selectedRow == -1) {
                miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_ROW_UNDEF); 
            }
            else {
                SRowDpsEdit rowDpsEdit = (SRowDpsEdit) moDocEntriesTablePane.getSelectedTableRow();

                if (moPickerItems == null) {
                    moPickerItems = SFormOptionPickerItems.createOptionPicker(miClient, SDataConstants.ITMX_ITEM_IOG, moPickerItems);
                }
                moPickerItems.formReset();
                
                moPickerItems.formRefreshOptionPane();
                moPickerItems.setSelectedPrimaryKey(rowDpsEdit.getItemRefNew() == null ? 
                        (new int [] { rowDpsEdit.getItemRefOld() != null ? rowDpsEdit.getItemRefOld().getPkItemId() : 0 }) : new int [] { rowDpsEdit.getItemRefNew().getPkItemId() });
                moPickerItems.setFormVisible(true); 

                if (moPickerItems.getFormResult() == SLibConstants.FORM_RESULT_OK) {
                    SDataItem item = (SDataItem) SDataUtilities.readRegistry(miClient,
                        SDataConstants.ITMU_ITEM, (int[]) moPickerItems.getSelectedPrimaryKey(), SLibConstants.EXEC_MODE_SILENT);

                    rowDpsEdit.setItemRefNew(item);
                    
                    rowDpsEdit.prepareTableRow();
                    moDocEntriesTablePane.renderTableRows();
                    moDocEntriesTablePane.setTableRowSelection(selectedRow);
                }
            }
        }
    }
    
    private void actionDeleteItemReference() {
        if (jbDeleteReferenceItem.isEnabled()) {
            int selectedRow = moDocEntriesTablePane.getTable().getSelectedRow();
            
            if (selectedRow == -1) {
                miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_ROW_UNDEF); 
            }
            else {
                SRowDpsEdit rowDpsEdit = (SRowDpsEdit) moDocEntriesTablePane.getSelectedTableRow();
                SDataItem item = new SDataItem();
                item.setItem("(REMOVIDO)");
                rowDpsEdit.setItemRefNew(item);
                
                rowDpsEdit.prepareTableRow();
                moDocEntriesTablePane.renderTableRows();
                moDocEntriesTablePane.setTableRowSelection(selectedRow);
            }
        }
    }
    
    private void updateAssocDocuments(Object primaryKey, SRowDpsEdit rowDpsEdit) {
        int[] entryKey = (int[]) primaryKey;
        moUpdateDocumentEntryKeys = new ArrayList<>();
        getUpdateEntryKeys(entryKey);
        moUpdateDocumentEntryKeys.stream().forEach((int[] updateDocumentEntryKey) -> {
            for (SDataDps document : moDocuments) {
                SDataDpsEntry entry = document.getDbmsDpsEntry(updateDocumentEntryKey);
                if (entry != null) {
                    if (rowDpsEdit.getOriginalQuantityNew() != 0) {
                        entry.setOriginalQuantity(rowDpsEdit.getOriginalQuantityNew());
                        entry.setIsRegistryEdited(true);
                    }
                    if (rowDpsEdit.getItemRefNew() != null) {
                        entry.setFkItemRefId_n(rowDpsEdit.getItemRefNew().getPkItemId());
                        entry.setIsRegistryEdited(true);
                    }
                    if (rowDpsEdit.getCostCenterNew() != null) {
                        entry.setFkCostCenterId_n(rowDpsEdit.getCostCenterNew().getPkCostCenterIdXXX());
                        entry.setDbmsCostCenterCode(rowDpsEdit.getCostCenterNew().getCode());
                        entry.setDbmsCostCenter_n(rowDpsEdit.getCostCenterNew().getCostCenter());
                        entry.setIsRegistryEdited(true);
                    }
                    break;
                }
            }
        });
    }
    
    private void getUpdateEntryKeys(int[] entryKey){
        boolean contains = false; 
        for (int[] key : moUpdateDocumentEntryKeys) {
            if (SLibUtilities.compareKeys(key, entryKey)) {
                contains = true;
                break;
            }
        }
        if (!contains) {
            moUpdateDocumentEntryKeys.add(entryKey);
            ArrayList<int[]> assocKeys = new ArrayList<>(); 
            String sql;
            try {
                // Busqueda hacia arriba (trn_dps_dps_supply):
                sql = "SELECT id_src_year AS year, id_src_doc AS doc, id_src_ety AS ety FROM trn_dps_dps_supply AS tdds "
                            + "WHERE id_des_year = " + entryKey[0] + " AND id_des_doc = " + entryKey[1] + " AND id_des_ety = " + entryKey[2] + "";    
                assocKeys = getDocuments(sql, assocKeys, true);

                // Busqueda hacia abajo (trn_dps_dps_supply): 
                sql = "SELECT id_des_year AS year, id_des_doc AS doc, id_des_ety AS ety FROM trn_dps_dps_supply AS tdds "
                        + "WHERE id_src_year = " + entryKey[0] + " AND id_src_doc = " + entryKey[1] + " AND id_src_ety = " + entryKey[2] + "";  
                assocKeys = getDocuments(sql, assocKeys, true);

                // Busqueda hacia arriba (trn_dps_dps_adj):
                sql = "SELECT id_dps_year AS year, id_dps_doc AS doc, id_dps_ety AS ety FROM trn_dps_dps_adj AS tdda " 
                        + "WHERE id_adj_year = " + entryKey[0] + " AND id_adj_doc = " + entryKey[1] + " AND id_adj_ety = " + entryKey[2] + "";
                assocKeys = getDocuments(sql, assocKeys, true);

                // Busqueda hacia abajo (trn_dps_dps_adj):
                sql = "SELECT id_adj_year AS year, id_adj_doc AS doc, id_adj_ety AS ety FROM trn_dps_dps_adj AS tdda " 
                        + "WHERE id_dps_year = " + entryKey[0] + " AND id_dps_doc = " + entryKey[1] + " AND id_dps_ety = " + entryKey[2] + "";
                assocKeys = getDocuments(sql, assocKeys, true);

                assocKeys.stream().forEach((assocKey) -> {
                    getUpdateEntryKeys(assocKey);
                });
            }
            catch (Exception e) {
                miClient.showMsgBoxWarning(e.getMessage());
            }
        }
    }
       
    private void actionOk() {
        SFormValidation validation = formValidate();
        if (validation.getIsError()){
            miClient.showMsgBoxWarning(validation.getMessage());
        }
        else {
            mnFormResult = SLibConstants.FORM_RESULT_OK;
            setVisible(false);
        }
    }

    private void actionCancel() {
        /* Bloque de codigo de respaldo correspondiente a la version antigua sin Redis de candado de acceso exclusivo a registro
        releaseDpsUserLock();
        */
        /* Bloque de codigo de respaldo correspondiente a la version con Redis de candado de acceso exclusivo a registro
        releaseDpsUserRedisLock();
        */
        releaseDpsUserSLock();
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbDeleteReferenceItem;
    private javax.swing.JButton jbEditQty;
    private javax.swing.JButton jbOk;
    private javax.swing.JButton jbSelectCostCenter;
    private javax.swing.JButton jbSelectReferenceItem;
    private javax.swing.JLabel jlDiff;
    private javax.swing.JLabel jlPanelDps;
    private javax.swing.JLabel jlTotalDpsNew;
    private javax.swing.JLabel jlTotalDpsOld;
    private javax.swing.JPanel jpCfdiChangeItem;
    private javax.swing.JPanel jpConceptSetup;
    private javax.swing.JPanel jpConceptsDataNorth;
    private javax.swing.JPanel jpConceptsGrid;
    private javax.swing.JPanel jpControls;
    private javax.swing.JPanel jpDpsConcepts;
    private javax.swing.JPanel jpDpsData;
    private javax.swing.JPanel jpDpsTotal;
    private javax.swing.JPanel jpHeader;
    private javax.swing.JTextField jtfCurrencyDpsNew;
    private javax.swing.JTextField jtfCurrencyDpsOld;
    private javax.swing.JTextField jtfDiff;
    private javax.swing.JTextField jtfDiffCurrencyKey;
    private javax.swing.JTextField jtfTotalDpsNew;
    private javax.swing.JTextField jtfTotalDpsOld;
    // End of variables declaration//GEN-END:variables

    @Override
    public void setFormVisible(boolean visible) {
        setVisible(visible);
    }
    
    @Override
    public erp.lib.form.SFormValidation formValidate() { 
        boolean isAnyEntryChanged = false;
        SFormValidation validation = new SFormValidation();
        
        for (int i = 0; i < moDocEntriesTablePane.getTableGuiRowCount(); i++) {
            SRowDpsEdit row = (SRowDpsEdit) moDocEntriesTablePane.getTableRow(i); 
            
            if (row.getOriginalQuantityNew() != 0 || row.getItemRefNew() != null || row.getCostCenterNew() != null) {
                isAnyEntryChanged = true;
            }
        }
        if (!isAnyEntryChanged) {
            validation.setMessage("Ninguna entrada tiene una cantidad nueva o item de referencia o un centro de costo nuevo seleccionado.");
        }
        if (!validation.getIsError()) {
            SDataDps dps = comprobateRegistry();
            SServerRequest request = new SServerRequest(SServerConstants.REQ_DB_CAN_SAVE);
            SServerResponse response;

            request.setPacket(dps);
            response = miClient.getSessionXXX().request(request);

            if (response.getResponseType() != SSrvConsts.RESP_TYPE_OK || response.getResultType() != SLibConstants.DB_CAN_SAVE_YES) {
                validation.setMessage(response.getMessage().isEmpty() ? SLibConstants.MSG_ERR_UTIL_UNKNOWN_ERR : response.getMessage());
            }
        }
        
        return validation;
    }
    
    private SDataDps comprobateRegistry(){
        for (int i = 0; i < moDocEntriesTablePane.getTableGuiRowCount(); i++) {
            SRowDpsEdit row = (SRowDpsEdit) moDocEntriesTablePane.getTableRow(i);
            SDataDpsEntry entry = moDps.getDbmsDpsEntry((int[]) row.getDpsEntryPK());
            if (row.getOriginalQuantityNew() != 0) {
                entry.setOriginalQuantity(row.getOriginalQuantityNew());
                entry.setIsRegistryEdited(true);
            }
            if (row.getItemRefNew() != null) {
                entry.setFkItemRefId_n(row.getItemRefNew().getPkItemId());
                entry.setIsRegistryEdited(true);
            }
            if (row.getCostCenterNew() != null) {
                entry.setFkCostCenterId_n(row.getCostCenterNew().getPkCostCenterIdXXX());
                entry.setDbmsCostCenterCode(row.getCostCenterNew().getCode());
                entry.setDbmsCostCenter_n(row.getCostCenterNew().getCostCenter());
                entry.setIsRegistryEdited(true);
            }
        }
        return moDps;
    }
        
    @Override
    public void formClearRegistry() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public void formReset() {
        mnFormResult = SLibConstants.UNDEFINED;
        mnFormStatus = SLibConstants.UNDEFINED;
        mbFirstTime = true;
        mbDocumentsLockedError = false;
        
        moDps = null;
        moDocuments = null;
        moUpdateDocumentEntryKeys = null;
        moDocEntriesTablePane.clearTableRows();
        
        mdTotalDpsOld = 0;
    }

    @Override
    public void formRefreshCatalogues() {
    }

    @Override
    public void setFormStatus(int status) {
        mnFormStatus = status;
    }

    @Override
    public int getFormStatus() {
        return mnFormStatus;
    }

    @Override
    public int getFormResult() {
        return mnFormResult;
    }

    @Override
    public void setRegistry(SDataRegistry registry) {
        moDps = (SDataDps) registry;
        
        moDocuments = new ArrayList<>();
        getAssociatedDocuments(moDps);
        
        mbDocumentsLockedError = lockDocuments();
        
        moPanelDps.setDps(moDps, null);
        
        mdTotalDpsOld = moDps.getTotalCy_r();
        jtfTotalDpsOld.setText(moAmountFormat.format(mdTotalDpsOld));
        jtfCurrencyDpsOld.setText(moDps.getDbmsCurrencyKey());
        jtfTotalDpsNew.setText(moAmountFormat.format(mdTotalDpsOld));
        jtfCurrencyDpsNew.setText(moDps.getDbmsCurrencyKey());
        jtfDiff.setText("");
        jtfDiffCurrencyKey.setText("");
        
        populateTable();
    }

    @Override
    public SDataRegistry getRegistry() {
        for (int i = 0; i < moDocEntriesTablePane.getTableGuiRowCount(); i++) {
            SRowDpsEdit row = (SRowDpsEdit) moDocEntriesTablePane.getTableRow(i);
            SDataDpsEntry entry = moDps.getDbmsDpsEntry((int[]) row.getDpsEntryPK());
            if (row.getItemRefNew() != null || row.getCostCenterNew() != null) {
                updateAssocDocuments(entry.getPrimaryKey(), row);
            }
        }
        moDpsEntryEdit = new SDataDpsEntryEdit();
        
        moDpsEntryEdit.getDocuments().clear();
        moDocuments.forEach((document) -> {
            moDpsEntryEdit.getDocuments().add(document);
        });
        moDpsEntryEdit.setUserEditId(miClient.getSession().getUser().getPkUserId());
        
        return moDpsEntryEdit;
    }

    @Override
    public Object getValue(int type) {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }
    
    @Override
    public void setValue(int type, Object value) {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public JLabel getTimeoutLabel() {
        return null;
    }
    
    @Override
    public void actionPerformed(java.awt.event.ActionEvent e) {
        if (e.getSource() instanceof javax.swing.JButton) {
            javax.swing.JButton button = (javax.swing.JButton) e.getSource();

            if (button == jbOk) {
                actionOk();
            }
            else if (button == jbCancel) {
                actionCancel();
            }
            else if (button == jbEditQty) {
                actionEditQty();
            }
            else if (button == jbSelectCostCenter) {
                actionSelectCostCenter();
            }
            else if (button == jbSelectReferenceItem) {
                actionSelectItemReference();
            }
            else if (button == jbDeleteReferenceItem) {
                actionDeleteItemReference();
            }
        }
    }
}
