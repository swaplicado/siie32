/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mbps.form;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataUtilities;
import erp.data.SProcConstants;
import erp.lib.SLibConstants;
import erp.lib.SLibTimeUtilities;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormComponentItem;
import erp.lib.form.SFormField;
import erp.lib.form.SFormUtilities;
import erp.lib.form.SFormValidation;
import erp.mbps.data.SDataBizPartner;
import erp.mbps.data.SDataBizPartnerBranch;
import erp.mbps.data.SDataBizPartnerBranchAddress;
import erp.mbps.data.SDataBizPartnerBranchContact;
import erp.mbps.data.SDataBizPartnerCategory;
import erp.mmkt.data.SDataConfigurationSalesAgent;
import erp.mod.SModSysConsts;
import java.awt.event.ActionEvent;
import java.awt.event.ItemEvent;
import java.awt.event.KeyEvent;
import java.util.HashSet;
import java.util.Vector;
import javax.swing.AbstractAction;
import javax.swing.JComboBox;
import javax.swing.JOptionPane;
import sa.lib.SLibConsts;
import sa.lib.gui.SGuiConsts;

/**
 *
 * @author Juan Barajas, Sergio Flores
 */
public class SFormBizPartnerAttribute extends javax.swing.JDialog implements erp.lib.form.SFormInterface, java.awt.event.ActionListener, java.awt.event.ItemListener {

    private int mnFormType;
    private int mnFormResult;
    private int mnFormStatus;
    private boolean mbFirstTime;
    private boolean mbResetingForm;
    private java.util.Vector<erp.lib.form.SFormField> mvFields;
    private erp.client.SClientInterface miClient;

    private erp.mbps.data.SDataBizPartner moBizPartner;
    private erp.lib.form.SFormField moFieldFkBizPartnerIdentityTypeId;
    private erp.lib.form.SFormField moFieldFirstName;
    private erp.lib.form.SFormField moFieldLastName;
    private erp.lib.form.SFormField moFieldBizPartner;
    private erp.lib.form.SFormField moFieldBizPartnerCommercial;
    private erp.lib.form.SFormField moFieldFiscalId;
    private erp.lib.form.SFormField moFieldAlternativeId;
    private erp.lib.form.SFormField moFieldEmail;
    private erp.lib.form.SFormField moFieldCodeBankSantander;
    private erp.lib.form.SFormField moFieldCodeBankBanBajio;
    private erp.lib.form.SFormField moFieldFkFiscalBankId;
    private erp.lib.form.SFormField moFieldFkSalesAgentTypeId;
    private erp.lib.form.SFormField moFieldIsDeleted;

    private int mnParamBizPartnerType;

    private int mnFormTypeExport;

    /** Creates new form SFormBizPartnerAttribute */
    public SFormBizPartnerAttribute(erp.client.SClientInterface client) {
        super(client.getFrame(), true);
        miClient =  client;

        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */

    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel2 = new javax.swing.JPanel();
        jPanel19 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jlFkBizPartnerIdentityTypeId = new javax.swing.JLabel();
        jcbFkBizPartnerIdentityTypeId = new javax.swing.JComboBox<SFormComponentItem>();
        jPanel22 = new javax.swing.JPanel();
        jlFirstName = new javax.swing.JLabel();
        jtfFirstName = new javax.swing.JTextField();
        jPanel25 = new javax.swing.JPanel();
        jlLastName = new javax.swing.JLabel();
        jtfLastName = new javax.swing.JTextField();
        jPanel26 = new javax.swing.JPanel();
        jlBizPartner = new javax.swing.JLabel();
        jtfBizPartner = new javax.swing.JTextField();
        jPanel27 = new javax.swing.JPanel();
        jlBizPartnerCommercial = new javax.swing.JLabel();
        jtfBizPartnerCommercial = new javax.swing.JTextField();
        jbSetBizPartnerCommercial = new javax.swing.JButton();
        jPanel29 = new javax.swing.JPanel();
        jlFiscalId = new javax.swing.JLabel();
        jtfFiscalId = new javax.swing.JTextField();
        jlAlternativeId = new javax.swing.JLabel();
        jftAlternativeId = new javax.swing.JFormattedTextField();
        jPanel24 = new javax.swing.JPanel();
        jlEmail = new javax.swing.JLabel();
        jtfEmail = new javax.swing.JTextField();
        jPanel28 = new javax.swing.JPanel();
        jlCodeBankSantander = new javax.swing.JLabel();
        jtfCodeBankSantander = new javax.swing.JTextField();
        jPanel30 = new javax.swing.JPanel();
        jlCodeBankBanBajio = new javax.swing.JLabel();
        jtfCodeBankBanBajio = new javax.swing.JTextField();
        jPanel11 = new javax.swing.JPanel();
        jlFkFiscalBankId = new javax.swing.JLabel();
        jcbFkFiscalBankId = new javax.swing.JComboBox<SFormComponentItem>();
        jbFkFiscalBankId = new javax.swing.JButton();
        jPanel10 = new javax.swing.JPanel();
        jlFkSalesAgentTypeId = new javax.swing.JLabel();
        jcbFkSalesAgentTypeId = new javax.swing.JComboBox<SFormComponentItem>();
        jbFkSalesAgentTypeId = new javax.swing.JButton();
        jckIsDeleted = new javax.swing.JCheckBox();
        jPanel5 = new javax.swing.JPanel();
        jPanel41 = new javax.swing.JPanel();
        jtfPkBizPartnerId_Ro = new javax.swing.JTextField();
        jPanel1 = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Asociado de negocios");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del registro:"));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jPanel19.setLayout(new java.awt.GridLayout(12, 1, 0, 5));

        jPanel6.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlFkBizPartnerIdentityTypeId.setForeground(new java.awt.Color(0, 0, 255));
        jlFkBizPartnerIdentityTypeId.setText("Tipo de identidad: *");
        jlFkBizPartnerIdentityTypeId.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel6.add(jlFkBizPartnerIdentityTypeId);

        jcbFkBizPartnerIdentityTypeId.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel6.add(jcbFkBizPartnerIdentityTypeId);

        jPanel19.add(jPanel6);

        jPanel22.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlFirstName.setText("Nombre(s): *");
        jlFirstName.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel22.add(jlFirstName);

        jtfFirstName.setText("NOMBRES");
        jtfFirstName.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel22.add(jtfFirstName);

        jPanel19.add(jPanel22);

        jPanel25.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlLastName.setText("Apellido(s): *");
        jlLastName.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel25.add(jlLastName);

        jtfLastName.setText("APELLIDOS");
        jtfLastName.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel25.add(jtfLastName);

        jPanel19.add(jPanel25);

        jPanel26.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlBizPartner.setText("Nombre: *");
        jlBizPartner.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel26.add(jlBizPartner);

        jtfBizPartner.setText("ASOCIADO DE NEGOCIOS");
        jtfBizPartner.setPreferredSize(new java.awt.Dimension(354, 23));
        jPanel26.add(jtfBizPartner);

        jPanel19.add(jPanel26);

        jPanel27.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlBizPartnerCommercial.setText("Nombre comercial:");
        jlBizPartnerCommercial.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel27.add(jlBizPartnerCommercial);

        jtfBizPartnerCommercial.setText("NOMBRE COMERCIAL");
        jtfBizPartnerCommercial.setPreferredSize(new java.awt.Dimension(354, 23));
        jPanel27.add(jtfBizPartnerCommercial);

        jbSetBizPartnerCommercial.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_action.gif"))); // NOI18N
        jbSetBizPartnerCommercial.setToolTipText("Crear nombre comercial");
        jbSetBizPartnerCommercial.setFocusable(false);
        jbSetBizPartnerCommercial.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel27.add(jbSetBizPartnerCommercial);

        jPanel19.add(jPanel27);

        jPanel29.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlFiscalId.setText("RFC: *");
        jlFiscalId.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel29.add(jlFiscalId);

        jtfFiscalId.setText("RFC");
        jtfFiscalId.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel29.add(jtfFiscalId);

        jlAlternativeId.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlAlternativeId.setText("CURP:");
        jlAlternativeId.setPreferredSize(new java.awt.Dimension(54, 23));
        jPanel29.add(jlAlternativeId);

        jftAlternativeId.setText("CURP");
        jftAlternativeId.setFocusLostBehavior(javax.swing.JFormattedTextField.PERSIST);
        jftAlternativeId.setPreferredSize(new java.awt.Dimension(125, 23));
        jftAlternativeId.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                jftAlternativeIdFocusLost(evt);
            }
        });
        jPanel29.add(jftAlternativeId);

        jPanel19.add(jPanel29);

        jPanel24.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlEmail.setText("E-mail:");
        jlEmail.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel24.add(jlEmail);

        jtfEmail.setText("E-MAIL");
        jtfEmail.setPreferredSize(new java.awt.Dimension(240, 23));
        jPanel24.add(jtfEmail);

        jPanel19.add(jPanel24);

        jPanel28.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlCodeBankSantander.setText("Código Santander:");
        jlCodeBankSantander.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel28.add(jlCodeBankSantander);

        jtfCodeBankSantander.setText("CODE BANK");
        jtfCodeBankSantander.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel28.add(jtfCodeBankSantander);

        jPanel19.add(jPanel28);

        jPanel30.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlCodeBankBanBajio.setText("Código BanBajío:");
        jlCodeBankBanBajio.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel30.add(jlCodeBankBanBajio);

        jtfCodeBankBanBajio.setText("CODE BANK");
        jtfCodeBankBanBajio.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel30.add(jtfCodeBankBanBajio);

        jPanel19.add(jPanel30);

        jPanel11.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlFkFiscalBankId.setText("Banco SAT: *");
        jlFkFiscalBankId.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel11.add(jlFkFiscalBankId);

        jcbFkFiscalBankId.setPreferredSize(new java.awt.Dimension(354, 23));
        jPanel11.add(jcbFkFiscalBankId);

        jbFkFiscalBankId.setText("jButton1");
        jbFkFiscalBankId.setToolTipText("Seleccionar banco SAT");
        jbFkFiscalBankId.setFocusable(false);
        jbFkFiscalBankId.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel11.add(jbFkFiscalBankId);

        jPanel19.add(jPanel11);

        jPanel10.setLayout(new java.awt.FlowLayout(0, 5, 0));

        jlFkSalesAgentTypeId.setText("Tipo de agente ventas:");
        jlFkSalesAgentTypeId.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel10.add(jlFkSalesAgentTypeId);

        jcbFkSalesAgentTypeId.setPreferredSize(new java.awt.Dimension(354, 23));
        jPanel10.add(jcbFkSalesAgentTypeId);

        jbFkSalesAgentTypeId.setText("jButton1");
        jbFkSalesAgentTypeId.setToolTipText("Seleccionar tipo agente de ventas");
        jbFkSalesAgentTypeId.setFocusable(false);
        jbFkSalesAgentTypeId.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel10.add(jbFkSalesAgentTypeId);

        jPanel19.add(jPanel10);

        jckIsDeleted.setText("Asociado de negocios eliminado");
        jPanel19.add(jckIsDeleted);

        jPanel2.add(jPanel19, java.awt.BorderLayout.NORTH);

        getContentPane().add(jPanel2, java.awt.BorderLayout.CENTER);

        jPanel5.setLayout(new java.awt.GridLayout(1, 2));

        jPanel41.setLayout(new java.awt.FlowLayout(0));

        jtfPkBizPartnerId_Ro.setEditable(false);
        jtfPkBizPartnerId_Ro.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfPkBizPartnerId_Ro.setToolTipText("ID del asociado de negocios");
        jtfPkBizPartnerId_Ro.setFocusable(false);
        jtfPkBizPartnerId_Ro.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel41.add(jtfPkBizPartnerId_Ro);

        jPanel5.add(jPanel41);

        jPanel1.setPreferredSize(new java.awt.Dimension(392, 33));
        jPanel1.setLayout(new java.awt.FlowLayout(2));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel1.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setToolTipText("[Escape]");
        jPanel1.add(jbCancel);

        jPanel5.add(jPanel1);

        getContentPane().add(jPanel5, java.awt.BorderLayout.SOUTH);

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-656)/2, (screenSize.height-438)/2, 656, 438);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivate();
    }//GEN-LAST:event_formWindowActivated

    private void jftAlternativeIdFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jftAlternativeIdFocusLost
        focusLostAlternativeId();
    }//GEN-LAST:event_jftAlternativeIdFocusLost

    private void initComponentsExtra() {
        mvFields = new Vector<SFormField>();

        moFieldFkBizPartnerIdentityTypeId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbFkBizPartnerIdentityTypeId, jlFkBizPartnerIdentityTypeId);
        moFieldFirstName = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, true, jtfFirstName, jlFirstName);
        moFieldFirstName.setLengthMax(100);
        moFieldLastName = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, true, jtfLastName, jlLastName);
        moFieldLastName.setLengthMax(100);
        moFieldBizPartner = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, true, jtfBizPartner, jlBizPartner);
        moFieldBizPartner.setLengthMax(202);
        moFieldBizPartnerCommercial = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfBizPartnerCommercial, jlBizPartnerCommercial);
        moFieldBizPartnerCommercial.setLengthMax(202);
        moFieldFiscalId = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, true, jtfFiscalId, jlFiscalId);
        moFieldFiscalId.setLengthMin(12);
        moFieldFiscalId.setLengthMax(13);
        moFieldAlternativeId = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jftAlternativeId, jlAlternativeId);
        moFieldAlternativeId.setLengthMin(18);
        moFieldAlternativeId.setLengthMax(18);
        moFieldEmail = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfEmail, jlEmail);
        moFieldEmail.setLengthMax(50);
        moFieldEmail.setAutoCaseType(SLibConsts.UNDEFINED);
        moFieldCodeBankSantander = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfCodeBankSantander, jlCodeBankSantander);
        moFieldCodeBankSantander.setLengthMin(5);
        moFieldCodeBankSantander.setLengthMax(5);
        moFieldCodeBankBanBajio = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfCodeBankBanBajio, jlCodeBankBanBajio);
        moFieldCodeBankBanBajio.setLengthMin(5);
        moFieldCodeBankBanBajio.setLengthMax(5);
        moFieldFkFiscalBankId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbFkFiscalBankId, jlFkFiscalBankId);
        moFieldFkFiscalBankId.setPickerButton(jbFkFiscalBankId);
        moFieldFkSalesAgentTypeId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbFkSalesAgentTypeId, jlFkSalesAgentTypeId);
        moFieldFkSalesAgentTypeId.setPickerButton(jbFkSalesAgentTypeId);
        moFieldIsDeleted = new SFormField(miClient, SLibConstants.DATA_TYPE_BOOLEAN, false, jckIsDeleted);

        mvFields.add(moFieldFkBizPartnerIdentityTypeId);
        mvFields.add(moFieldFirstName);
        mvFields.add(moFieldLastName);
        mvFields.add(moFieldBizPartner);
        mvFields.add(moFieldBizPartnerCommercial);
        mvFields.add(moFieldFiscalId);
        mvFields.add(moFieldAlternativeId);
        mvFields.add(moFieldEmail);
        mvFields.add(moFieldCodeBankSantander);
        mvFields.add(moFieldCodeBankBanBajio);
        mvFields.add(moFieldFkFiscalBankId);
        mvFields.add(moFieldFkSalesAgentTypeId);
        mvFields.add(moFieldIsDeleted);

        jbOk.addActionListener(this);
        jbCancel.addActionListener(this);
        jbSetBizPartnerCommercial.addActionListener(this);
        jbFkFiscalBankId.addActionListener(this);
        jbFkSalesAgentTypeId.addActionListener(this);
        jcbFkBizPartnerIdentityTypeId.addItemListener(this);

        moFieldAlternativeId.setMaskFormatter("UUUU######XXXXXXXX");

        AbstractAction actionOk = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionOk(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionOk, "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);

        AbstractAction action = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionCancel(); }
        };

        SFormUtilities.putActionMap(getRootPane(), action, "cancel", KeyEvent.VK_ESCAPE, 0);
    }

    private void windowActivate() {
        if (mbFirstTime) {
            mbFirstTime = false;
            if (jcbFkBizPartnerIdentityTypeId.isEnabled()) {
                jcbFkBizPartnerIdentityTypeId.requestFocus();
            }
            else if (jtfFirstName.isEnabled()) {
                jtfFirstName.requestFocus();
            }
            else if (jtfBizPartner.isEnabled()) {
                jtfBizPartner.requestFocus();
            }
            else {
                jtfBizPartnerCommercial.requestFocus();
            }
        }
    }

    private void focusLostAlternativeId() {
        if (jftAlternativeId.getText().trim().length() > 0) {
            jftAlternativeId.setText(jftAlternativeId.getText().toUpperCase());
        }
        else {
            jftAlternativeId.setText("");
        }
    }

    private void actionFkFiscalBankId() {
        miClient.pickOption(SDataConstants.FINS_FISCAL_BANK, moFieldFkFiscalBankId, new int[] { moFieldFkFiscalBankId.getKeyAsIntArray()[0] });
    }

    private void actionFkSalesAgentTypeId() {
        miClient.pickOption(SDataConstants.MKTU_TP_SAL_AGT, moFieldFkSalesAgentTypeId, new int[] { moFieldFkSalesAgentTypeId.getKeyAsIntArray()[0] });
    }

    private void itemStateChangedBizPartnerIdentityType() {
        updateStatusBizPartner();
    }

    private void updateStatusBizPartner() {
        switch (moFieldFkBizPartnerIdentityTypeId.getKeyAsIntArray()[0]) {
            case SDataConstantsSys.BPSS_TP_BP_IDY_PER:
                jtfFirstName.setEnabled(true);
                jtfLastName.setEnabled(true);
                jtfBizPartner.setEnabled(false);
                jtfBizPartnerCommercial.setEnabled(true);
                jbSetBizPartnerCommercial.setEnabled(true);
                jtfFiscalId.setEnabled(true);
                jftAlternativeId.setEnabled(true);
                break;
            case SDataConstantsSys.BPSS_TP_BP_IDY_ORG:
                jtfFirstName.setEnabled(false);
                jtfLastName.setEnabled(false);
                jtfBizPartner.setEnabled(true);
                jtfBizPartnerCommercial.setEnabled(true);
                jbSetBizPartnerCommercial.setEnabled(true);
                jtfFiscalId.setEnabled(true);
                jftAlternativeId.setEnabled(false);
                break;
            default:
                jtfFirstName.setEnabled(false);
                jtfLastName.setEnabled(false);
                jtfBizPartner.setEnabled(false);
                jtfBizPartnerCommercial.setEnabled(false);
                jbSetBizPartnerCommercial.setEnabled(false);
                jtfFiscalId.setEnabled(false);
                jftAlternativeId.setEnabled(false);
        }
    }

    private SDataBizPartnerCategory createBizPartnerCategory(final int categoryId) {
        SDataBizPartnerCategory category = null;

        if (categoryId >= SModSysConsts.BPSS_CT_BP_SUP && categoryId <= SModSysConsts.BPSS_CT_BP_DBR) {
            category = new SDataBizPartnerCategory();

            //category.setPkBizPartnerId();
            category.setPkBizPartnerCategoryId(categoryId);
            category.setKey("");
            category.setCompanyKey("");
            category.setCreditLimit(0);
            category.setDaysOfCredit(0);
            category.setDaysOfGrace(0);
            category.setDateStart(SLibTimeUtilities.getBeginOfYear(miClient.getSession().getCurrentDate()));
            category.setDateEnd_n(null);
            category.setIsCreditByUser(true);
            category.setIsDeleted(false);
            category.setFkBizPartnerCategoryId(categoryId);
            category.setFkBizPartnerTypeId(SModSysConsts.BPSU_TP_BP_DEF);
            category.setFkCreditTypeId_n(SModSysConsts.BPSS_TP_CRED_CRED_NO);
            category.setFkRiskTypeId_n(SLibConsts.UNDEFINED);
            category.setFkCfdAddendaTypeId(SModSysConsts.BPSS_TP_CFD_ADD_CFD_ADD_NA);
            category.setFkLanguageId_n(SLibConsts.UNDEFINED);
            category.setFkCurrencyId_n(SLibConsts.UNDEFINED);
            category.setFkUserNewId(miClient.getSession().getUser().getPkUserId());
        }

        return category;
    }

    private SDataBizPartnerBranch createBizPartnerBranch() {
        SDataBizPartnerBranch branch = null;
        SDataBizPartnerBranchAddress address = null;

        branch = new SDataBizPartnerBranch();
        //branch.setPkBizPartnerBranchId();
        branch.setBizPartnerBranch(SModSysConsts.TXT_HQ);
        branch.setCode("");
        branch.setIsAddressPrintable(true);
        branch.setIsDeleted(false);
        //branch.setFkBizPartnerId();
        branch.setFkBizPartnerBranchTypeId(SDataConstantsSys.BPSS_TP_BPB_HQ);
        branch.setFkTaxRegionId_n(SLibConsts.UNDEFINED);
        branch.setFkAddressFormatTypeId_n(SLibConsts.UNDEFINED);
        branch.setFkUserNewId(miClient.getSession().getUser().getPkUserId());

        address = new SDataBizPartnerBranchAddress();
        //address.setPkBizPartnerBranchId();
        //address.setPkAddressId();
        address.setAddress(SModSysConsts.TXT_OFFICIAL);
        address.setStreet("");
        address.setStreetNumberExt("");
        address.setStreetNumberInt("");
        address.setNeighborhood("");
        address.setReference("");
        address.setLocality("");
        address.setCounty("");
        address.setState("");
        address.setZipCode("");
        address.setPoBox("");
        address.setIsDefault(true);
        address.setIsDeleted(false);
        address.setFkAddressTypeId(SDataConstantsSys.BPSS_TP_ADD_OFF);
        address.setFkCountryId_n(SLibConsts.UNDEFINED);
        address.setFkUserNewId(miClient.getSession().getUser().getPkUserId());

        branch.getDbmsBizPartnerBranchAddresses().add(address);

        return branch;
    }

    public SDataBizPartnerBranchContact createBizPartnerBranchContact() {
        SDataBizPartnerBranchContact contact = null;

        contact = new SDataBizPartnerBranchContact();
        //contact.setPkBizPartnerBranchId();
        //contact.setPkContactId();
        contact.setContact("");
        contact.setContactPrefix("");
        contact.setContactSuffix("");
        contact.setLastname("");
        contact.setFirstname("");
        contact.setCharge("");
        contact.setTelAreaCode01("");
        contact.setTelNumber01("");
        contact.setTelExt01("");
        contact.setTelAreaCode02("");
        contact.setTelNumber02("");
        contact.setTelExt02("");
        contact.setTelAreaCode03("");
        contact.setTelNumber03("");
        contact.setTelExt03("");
        contact.setNextelId01("");
        contact.setNextelId02("");
        contact.setEmail01("");
        contact.setEmail02("");
        contact.setSkype01("");
        contact.setSkype02("");
        contact.setIsDeleted(false);
        contact.setPkContactTypeId(SDataConstantsSys.BPSS_TP_CON_ADM);
        contact.setPkTelephoneType01Id(SDataConstantsSys.BPSS_TP_TEL_NA);
        contact.setPkTelephoneType02Id(SDataConstantsSys.BPSS_TP_TEL_NA);
        contact.setPkTelephoneType03Id(SDataConstantsSys.BPSS_TP_TEL_NA);
        contact.setFkUserNewId(miClient.getSession().getUser().getPkUserId());

        return contact;
    }

    public SDataConfigurationSalesAgent createConfigurationSalesAgent() {
        SDataConfigurationSalesAgent config = new SDataConfigurationSalesAgent();

        config = new SDataConfigurationSalesAgent();
        //config.setPkSalesAgentId();
        config.setIsDeleted(false);
        config.setFkSalesAgentTypeId(SLibConsts.UNDEFINED);
        config.setFkUserNewId(miClient.getSession().getUser().getPkUserId());

        return config;
    }

    private void actionRecreateBizPartnerCommercial() {
        jtfBizPartnerCommercial.setText("");

        if (moFieldFkBizPartnerIdentityTypeId.getKeyAsIntArray()[0] == SDataConstantsSys.BPSS_TP_BP_IDY_PER) {
            jtfBizPartnerCommercial.setText(jtfLastName.getText() + ", " + jtfFirstName.getText());
        }
        else {
            jtfBizPartnerCommercial.setText(jtfBizPartner.getText());
        }

        jtfBizPartnerCommercial.requestFocus();
    }

    private void actionOk() {
        SFormValidation validation = formValidate();

        if (validation.getIsError()) {
            if (validation.getComponent() != null) {
                validation.getComponent().requestFocus();
            }
            if (validation.getMessage().length() > 0) {
                miClient.showMsgBoxWarning(validation.getMessage());
            }
        }
        else {
            mnFormResult = SLibConstants.FORM_RESULT_OK;
            setVisible(false);
        }
    }

    private void actionCancel() {
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel19;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel22;
    private javax.swing.JPanel jPanel24;
    private javax.swing.JPanel jPanel25;
    private javax.swing.JPanel jPanel26;
    private javax.swing.JPanel jPanel27;
    private javax.swing.JPanel jPanel28;
    private javax.swing.JPanel jPanel29;
    private javax.swing.JPanel jPanel30;
    private javax.swing.JPanel jPanel41;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbFkFiscalBankId;
    private javax.swing.JButton jbFkSalesAgentTypeId;
    private javax.swing.JButton jbOk;
    private javax.swing.JButton jbSetBizPartnerCommercial;
    private javax.swing.JComboBox<SFormComponentItem> jcbFkBizPartnerIdentityTypeId;
    private javax.swing.JComboBox<SFormComponentItem> jcbFkFiscalBankId;
    private javax.swing.JComboBox<SFormComponentItem> jcbFkSalesAgentTypeId;
    private javax.swing.JCheckBox jckIsDeleted;
    private javax.swing.JFormattedTextField jftAlternativeId;
    private javax.swing.JLabel jlAlternativeId;
    private javax.swing.JLabel jlBizPartner;
    private javax.swing.JLabel jlBizPartnerCommercial;
    private javax.swing.JLabel jlCodeBankBanBajio;
    private javax.swing.JLabel jlCodeBankSantander;
    private javax.swing.JLabel jlEmail;
    private javax.swing.JLabel jlFirstName;
    private javax.swing.JLabel jlFiscalId;
    private javax.swing.JLabel jlFkBizPartnerIdentityTypeId;
    private javax.swing.JLabel jlFkFiscalBankId;
    private javax.swing.JLabel jlFkSalesAgentTypeId;
    private javax.swing.JLabel jlLastName;
    private javax.swing.JTextField jtfBizPartner;
    private javax.swing.JTextField jtfBizPartnerCommercial;
    private javax.swing.JTextField jtfCodeBankBanBajio;
    private javax.swing.JTextField jtfCodeBankSantander;
    private javax.swing.JTextField jtfEmail;
    private javax.swing.JTextField jtfFirstName;
    private javax.swing.JTextField jtfFiscalId;
    private javax.swing.JTextField jtfLastName;
    private javax.swing.JTextField jtfPkBizPartnerId_Ro;
    // End of variables declaration//GEN-END:variables

    @Override
    public void formClearRegistry() {

    }

    @Override
    public void formReset() {
        mnFormResult = SLibConsts.UNDEFINED;
        mnFormStatus = SLibConsts.UNDEFINED;
        mbFirstTime = true;

        moBizPartner = null;

        mnFormTypeExport = SLibConsts.UNDEFINED;

        for (int i = 0; i < mvFields.size(); i++) {
            ((erp.lib.form.SFormField) mvFields.get(i)).resetField();
        }

        moFieldFkBizPartnerIdentityTypeId.setFieldValue(new int[] { SLibConsts.UNDEFINED });
        moFieldFkFiscalBankId.setFieldValue(new int[] { SModSysConsts.FINS_FISCAL_BANK_NA });

        updateStatusBizPartner();

        jtfCodeBankSantander.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_BANK);
        jtfCodeBankBanBajio.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_BANK);
        jcbFkFiscalBankId.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_BANK);
        jbFkFiscalBankId.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_BANK);
        jcbFkSalesAgentTypeId.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_SAL_AGT);
        jbFkSalesAgentTypeId.setEnabled(mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_SAL_AGT);

        jckIsDeleted.setSelected(false);

        jcbFkBizPartnerIdentityTypeId.setEnabled(true);
        jckIsDeleted.setEnabled(false);
    }

    @Override
    public void formRefreshCatalogues() {
        SFormUtilities.populateComboBox(miClient, jcbFkBizPartnerIdentityTypeId, SDataConstants.BPSS_TP_BP_IDY);
        SFormUtilities.populateComboBox(miClient, jcbFkFiscalBankId, SDataConstants.FINS_FISCAL_BANK);
        SFormUtilities.populateComboBox(miClient, jcbFkSalesAgentTypeId, SDataConstants.MKTU_TP_SAL_AGT);
    }

    @Override
    public erp.lib.form.SFormValidation formValidate() {
        String msg = "";
        Object[] paramsValidation = null;
        SFormValidation validation = new SFormValidation();

        for (int i = 0; i < mvFields.size(); i++) {
            if (!((erp.lib.form.SFormField) mvFields.get(i)).validateField()) {
                validation.setIsError(true);
                validation.setComponent(((erp.lib.form.SFormField) mvFields.get(i)).getComponent());
                break;
            }
        }

        if (!validation.getIsError()) {
            paramsValidation = new Object[] { moBizPartner == null ? SLibConsts.UNDEFINED : moBizPartner.getPkBizPartnerId(), moFieldBizPartner.getString() };
            if (SDataUtilities.callProcedureVal(miClient, SProcConstants.BPSU_BP, paramsValidation, SLibConstants.EXEC_MODE_VERBOSE) > 0) {
                if (miClient.showMsgBoxConfirm("El valor del campo '" + jlBizPartner.getText() + "' ya existe, ¿desea conservalo?") == JOptionPane.NO_OPTION) {
                    validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + jlBizPartner.getText() + "'.");
                    validation.setComponent(jtfBizPartner);
                }
            }

            if (!validation.getIsError()) {
                paramsValidation = new Object[] { moBizPartner == null ? SLibConsts.UNDEFINED : moBizPartner.getPkBizPartnerId(), moFieldFiscalId.getString() };
                if (SDataUtilities.callProcedureVal(miClient, SProcConstants.BPSU_BP_FISCAL_ID, paramsValidation, SLibConstants.EXEC_MODE_VERBOSE) > 0) {
                    if (miClient.showMsgBoxConfirm("El valor del campo '" + jlFiscalId.getText() + "' ya existe, ¿desea conservalo?") == JOptionPane.NO_OPTION) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + jlFiscalId.getText() + "'.");
                        validation.setComponent(jtfFiscalId);
                    }
                }

                if (!validation.getIsError()) {
                    if (!moFieldEmail.getString().isEmpty()) {
                        msg = SLibUtilities.validateEmail(moFieldEmail.getString());
                        if (!msg.isEmpty()) {
                            validation.setMessage(msg);
                            validation.setComponent(jtfEmail);
                        }
                    }
                }
            }
        }

        return validation;
    }

    @Override
    public void setFormStatus(int status) {
        mnFormStatus = status;
    }

    @Override
    public void setFormVisible(boolean visible) {
        setVisible(visible);
    }

    @Override
    public int getFormStatus() {
        return mnFormStatus;
    }

    @Override
    public int getFormResult() {
        return mnFormResult;
    }

    @Override
    public void setRegistry(erp.lib.data.SDataRegistry registry) {
        moBizPartner = (SDataBizPartner) registry;

        moFieldFkBizPartnerIdentityTypeId.setFieldValue(new int[] { moBizPartner.getFkBizPartnerIdentityTypeId() });
        updateStatusBizPartner();

        moFieldFirstName.setFieldValue(moBizPartner.getFirstname());
        moFieldLastName.setFieldValue(moBizPartner.getLastname());
        moFieldBizPartner.setFieldValue(moBizPartner.getBizPartner());
        moFieldBizPartnerCommercial.setFieldValue(moBizPartner.getBizPartner().compareTo(moBizPartner.getBizPartnerCommercial()) == 0 ? "" : moBizPartner.getBizPartnerCommercial());
        moFieldFiscalId.setFieldValue(moBizPartner.getFiscalId());
        moFieldAlternativeId.setFieldValue(moBizPartner.getAlternativeId());

        if (!moBizPartner.getDbmsHqBranch().getDbmsBizPartnerBranchContacts().isEmpty()) {
            moFieldEmail.setFieldValue(moBizPartner.getDbmsHqBranch().getDbmsBizPartnerBranchContacts().get(0).getEmail01());
        }

        moFieldCodeBankSantander.setFieldValue(moBizPartner.getCodeBankSantander());
        moFieldCodeBankBanBajio.setFieldValue(moBizPartner.getCodeBankBanBajio());
        moFieldFkFiscalBankId.setFieldValue(new int[] { moBizPartner.getFkFiscalBankId() });

        if (moBizPartner.getDbmsDataConfigurationSalesAgent() != null) {
            moFieldFkSalesAgentTypeId.setFieldValue(new int[] { moBizPartner.getDbmsDataConfigurationSalesAgent().getFkSalesAgentTypeId() });
        }

        jckIsDeleted.setSelected(moBizPartner.getIsDeleted());

        jtfPkBizPartnerId_Ro.setText("" + moBizPartner.getPkBizPartnerId());

        jcbFkBizPartnerIdentityTypeId.setEnabled(false);
        jckIsDeleted.setEnabled(moBizPartner.getDbmsDataEmployee() == null);
    }

    @Override
    public erp.lib.data.SDataRegistry getRegistry() {
        HashSet<Integer> requiredCategories = new HashSet<>();

        if (moBizPartner == null) {
            moBizPartner = new SDataBizPartner();
            moBizPartner.setFkUserNewId(miClient.getSession().getUser().getPkUserId());

            moBizPartner.setFkBizPartnerIdentityTypeId(moFieldFkBizPartnerIdentityTypeId.getKeyAsIntArray()[0]);
            moBizPartner.setFkTaxIdentityId(moFieldFkBizPartnerIdentityTypeId.getKeyAsIntArray()[0]);
            moBizPartner.setFkBizAreaId(SDataConstantsSys.BPSU_BA_DEFAULT);

            moBizPartner.getDbmsBizPartnerBranches().add(createBizPartnerBranch());
            moBizPartner.getDbmsHqBranch().getDbmsBizPartnerBranchContacts().add(createBizPartnerBranchContact());
        }
        else {
            moBizPartner.setFkUserEditId(miClient.getSession().getUser().getPkUserId());
        }

        //moBizPartner.setPkBizPartnerId();

        if (moFieldFkBizPartnerIdentityTypeId.getKeyAsIntArray()[0] == SDataConstantsSys.BPSS_TP_BP_IDY_PER) {
            moBizPartner.setBizPartner(moFieldLastName.getString() + ", " + moFieldFirstName.getString());
            moBizPartner.setFirstname(moFieldFirstName.getString());
            moBizPartner.setLastname(moFieldLastName.getString());
            moBizPartner.setAlternativeId(moFieldAlternativeId.getString());
        }
        else {
            moBizPartner.setBizPartner(moFieldBizPartner.getString());
            moBizPartner.setFirstname("");
            moBizPartner.setLastname("");
            moBizPartner.setAlternativeId("");
        }

        moBizPartner.setBizPartnerCommercial(moFieldBizPartnerCommercial.getString().isEmpty() ? moBizPartner.getBizPartner() : moFieldBizPartnerCommercial.getString());

        moBizPartner.setFiscalId(moFieldFiscalId.getString());
        //moBizPartner.setFiscalFrgId();
        moBizPartner.setCodeBankSantander(moFieldCodeBankSantander.getString());
        moBizPartner.setCodeBankBanBajio(moFieldCodeBankBanBajio.getString());
        //moBizPartner.setWeb();

        //moBizPartner.setIsCompany();

        if (SLibUtilities.belongsTo(mnParamBizPartnerType, new int[] { SDataConstants.BPSX_BP_ATT_BANK, SDataConstants.BPSX_BP_ATT_CARR, SDataConstants.BPSX_BP_ATT_SAL_AGT })) {
            requiredCategories.add(SDataConstantsSys.BPSS_CT_BP_SUP);
            requiredCategories.add(SDataConstantsSys.BPSS_CT_BP_CDR);
        }

        for (Integer category : requiredCategories) {
            switch (category) {
                case SModSysConsts.BPSS_CT_BP_SUP:
                    if (!moBizPartner.getIsSupplier()) {
                        moBizPartner.setIsSupplier(true);
                        moBizPartner.setDbmsCategorySettingsSup(createBizPartnerCategory(category));
                    }
                    break;
                case SModSysConsts.BPSS_CT_BP_CUS:
                    if (!moBizPartner.getIsCustomer()) {
                        moBizPartner.setIsCustomer(true);
                        moBizPartner.setDbmsCategorySettingsCus(createBizPartnerCategory(category));
                    }
                    break;
                case SModSysConsts.BPSS_CT_BP_CDR:
                    if (!moBizPartner.getIsCreditor()) {
                        moBizPartner.setIsCreditor(true);
                        moBizPartner.setDbmsCategorySettingsCdr(createBizPartnerCategory(category));
                    }
                    break;
                case SModSysConsts.BPSS_CT_BP_DBR:
                    if (!moBizPartner.getIsDebtor()) {
                        moBizPartner.setIsDebtor(true);
                        moBizPartner.setDbmsCategorySettingsDbr(createBizPartnerCategory(category));
                    }
                    break;
                default:
            }
        }

        switch (mnParamBizPartnerType) {
            case SDataConstants.BPSX_BP_ATT_BANK:
                moBizPartner.setIsAttributeBank(true);
                break;
            case SDataConstants.BPSX_BP_ATT_CARR:
                moBizPartner.setIsAttributeCarrier(true);
                break;
            case SDataConstants.BPSX_BP_ATT_SAL_AGT:
                moBizPartner.setIsAttributeSalesAgent(true);
                break;
            default:
        }

        //moBizPartner.setIsAttributePartnerShareholder();
        //moBizPartner.setIsAttributeRelatedParty();
        moBizPartner.setIsDeleted(moFieldIsDeleted.getBoolean());
        //moBizPartner.setFkBizPartnerIdentityTypeId();
        //moBizPartner.setFkTaxIdentityId()
        moBizPartner.setFkFiscalBankId(moFieldFkFiscalBankId.getKeyAsIntArray()[0]);
        //moBizPartner.setFkBizAreaId()

        // Update business partner children data:

        moBizPartner.getDbmsHqBranch().getDbmsBizPartnerBranchContacts().get(0).setEmail01(moFieldEmail.getString());

        if (!moBizPartner.getIsRegistryNew()) {
            moBizPartner.getDbmsHqBranch().getDbmsBizPartnerBranchContacts().get(0).setFkUserEditId(miClient.getSession().getUser().getPkUserId());
        }

        if (mnParamBizPartnerType == SDataConstants.BPSX_BP_ATT_SAL_AGT) {
            if (moBizPartner.getDbmsDataConfigurationSalesAgent() == null) {
                moBizPartner.setDbmsDataConfigurationSalesAgent(createConfigurationSalesAgent());
            }

            moBizPartner.getDbmsDataConfigurationSalesAgent().setFkSalesAgentTypeId(moFieldFkSalesAgentTypeId.getKeyAsIntArray()[0]);

            if (!moBizPartner.getIsRegistryNew()) {
                if (!moBizPartner.getDbmsDataConfigurationSalesAgent().getIsRegistryNew()) {
                    moBizPartner.getDbmsDataConfigurationSalesAgent().setFkUserEditId(miClient.getSession().getUser().getPkUserId());
                }
            }
        }

        return moBizPartner;
    }

    @Override
    public void setValue(int type, java.lang.Object value) {
        switch (type) {
            case SDataConstantsSys.VALUE_BIZ_PARTNER_TYPE:
                mnParamBizPartnerType = ((int[]) value)[0];

                switch (mnParamBizPartnerType) {
                    case SDataConstants.BPSX_BP_ATT_BANK:
                        setTitle("Banco");
                        break;
                    case SDataConstants.BPSX_BP_ATT_CARR:
                        setTitle("Transportista");
                        break;
                    case SDataConstants.BPSX_BP_ATT_SAL_AGT:
                        setTitle("Agente ventas");
                        break;
                    default:
                        setTitle("Asociado negocios");
                }
                break;
            default:
        }
    }

    @Override
    public java.lang.Object getValue(int type) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public javax.swing.JLabel getTimeoutLabel() {
        return null;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof javax.swing.JButton) {
            javax.swing.JButton button = (javax.swing.JButton) e.getSource();

            if (button == jbOk) {
                actionOk();
            }
            else if (button == jbCancel) {
                actionCancel();
            }
            else if (button == jbSetBizPartnerCommercial) {
                actionRecreateBizPartnerCommercial();
            }
            else if (button == jbFkFiscalBankId) {
                actionFkFiscalBankId();
            }
            else if (button == jbFkSalesAgentTypeId) {
                actionFkSalesAgentTypeId();
            }
        }
    }

    @Override
    public void itemStateChanged(ItemEvent e) {
        if (e.getSource() instanceof JComboBox) {
            if (e.getStateChange() == ItemEvent.SELECTED) {
                JComboBox comboBox = (JComboBox) e.getSource();

                if (comboBox == jcbFkBizPartnerIdentityTypeId) {
                    itemStateChangedBizPartnerIdentityType();
                }
            }
        }
    }
}
