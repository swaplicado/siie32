/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * SFormMoneyInOutBizPartner.java
 *
 * Created on 21/10/2010, 06:17:12 PM
 */

package erp.mfin.form;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataReadDescriptions;
import erp.data.SDataUtilities;
import erp.data.SProcConstants;
import erp.lib.SLibConstants;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormComponentItem;
import erp.lib.form.SFormField;
import erp.lib.form.SFormUtilities;
import erp.lib.form.SFormValidation;
import erp.mbps.data.SDataBizPartner;
import erp.mbps.data.SDataBizPartnerBranch;
import erp.mcfg.data.SDataCurrency;
import erp.mfin.data.SDataCheck;
import erp.mfin.data.SDataRecord;
import erp.mfin.data.SDataRecordEntry;
import erp.mod.SModSysConsts;
import java.awt.event.ActionEvent;
import java.awt.event.ItemEvent;
import java.awt.event.KeyEvent;
import java.util.Vector;
import javax.swing.AbstractAction;
import javax.swing.JOptionPane;
import javax.swing.JTextField;

/**
 *
 * @author Alfonso Flores
 */
public class SFormMoneyInOutBizPartner extends javax.swing.JDialog implements erp.lib.form.SFormInterface, java.awt.event.ActionListener, java.awt.event.FocusListener {

    private int mnFormType;
    private int mnFormResult;
    private int mnFormStatus;
    private boolean mbFirstTime;
    private boolean mbResetingForm;
    private java.util.Vector<erp.lib.form.SFormField> mvFields;
    private erp.client.SClientInterface miClient;

    private erp.mfin.data.SDataCheck moCheck;
    private erp.lib.form.SFormField moFieldConcept;
    private erp.lib.form.SFormField moFieldFkBizPartnerId;
    private erp.lib.form.SFormField moFieldFkCurrencyBizPartnerId;
    private erp.lib.form.SFormField moFieldValueCy;
    private erp.lib.form.SFormField moFieldExchangeRateSystem;
    private erp.lib.form.SFormField moFieldValue;
    private erp.lib.form.SFormField moFieldExchangeRate;
    private erp.lib.form.SFormField moFieldFkCheckId_n;

    private Vector<erp.mfin.data.SDataCheck> mvParamCheckVector;

    private erp.mfin.data.SDataRecord moParamRecord;
    private erp.mfin.data.SDataRecordEntry moRecordEntry;
    private erp.mcfg.data.SDataCurrency moCurrency;
    private erp.mcfg.data.SDataCurrency moCurrencyBizPartner;
    private int mnParamBizPartnerCategory;
    private int[] manParamAccountingMove;

    private int mnFkUser;
    private int mnFkBizPartnerCurrencyId;

    /** Creates new form SFormMoneyInOutBizPartner */
    public SFormMoneyInOutBizPartner(erp.client.SClientInterface client) {
        super(client.getFrame(), true);
        miClient =  client;

        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jlAccountCash = new javax.swing.JLabel();
        jtfCompanyBranch = new javax.swing.JTextField();
        jtfAccountCash = new javax.swing.JTextField();
        jtfCode = new javax.swing.JTextField();
        jPanel8 = new javax.swing.JPanel();
        jlCurrency = new javax.swing.JLabel();
        jtfCurrency = new javax.swing.JTextField();
        jPanel9 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jlFkBizPartnerId = new javax.swing.JLabel();
        jcbFkBizPartnerId = new javax.swing.JComboBox();
        jbFkBizPartnerId = new javax.swing.JButton();
        jPanel13 = new javax.swing.JPanel();
        jlCurrencyBizPartner = new javax.swing.JLabel();
        jtfCurrencyBizPartner = new javax.swing.JTextField();
        jPanel5 = new javax.swing.JPanel();
        jlFkCurrencyBizPartnerId = new javax.swing.JLabel();
        jcbFkCurrencyBizPartnerId = new javax.swing.JComboBox();
        jbFkCurrencyBizPartnerId = new javax.swing.JButton();
        jPanel10 = new javax.swing.JPanel();
        jlValueCy = new javax.swing.JLabel();
        jtfValueCy = new javax.swing.JTextField();
        jbValueCy = new javax.swing.JButton();
        jlExchangeRateSystem = new javax.swing.JLabel();
        jtfExchangeRateSystem = new javax.swing.JTextField();
        jbExchangeRateSystem = new javax.swing.JButton();
        jbExchangeRateAccountCashView = new javax.swing.JButton();
        jPanel11 = new javax.swing.JPanel();
        jlValue = new javax.swing.JLabel();
        jtfValue = new javax.swing.JTextField();
        jbValue = new javax.swing.JButton();
        jlExchangeRate = new javax.swing.JLabel();
        jtfExchangeRate = new javax.swing.JTextField();
        jbExchangeRate = new javax.swing.JButton();
        jbExchangeRateAccountCash = new javax.swing.JButton();
        jPanel7 = new javax.swing.JPanel();
        jckIsCheckApplying = new javax.swing.JCheckBox();
        jcbFkCheckId_n = new javax.swing.JComboBox();
        jPanel12 = new javax.swing.JPanel();
        jlConcept = new javax.swing.JLabel();
        jtfConcept = new javax.swing.JTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Egreso por anticipo pago cliente");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jPanel1.setPreferredSize(new java.awt.Dimension(492, 33));
        jPanel1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel1.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setToolTipText("[Escape]");
        jPanel1.add(jbCancel);

        getContentPane().add(jPanel1, java.awt.BorderLayout.SOUTH);

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del registro:"));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jPanel3.setLayout(new java.awt.GridLayout(11, 1, 0, 1));

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlAccountCash.setText("Cuenta de efectivo: ");
        jlAccountCash.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel4.add(jlAccountCash);

        jtfCompanyBranch.setEditable(false);
        jtfCompanyBranch.setText("COMPANY BRANCH");
        jtfCompanyBranch.setFocusable(false);
        jtfCompanyBranch.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel4.add(jtfCompanyBranch);

        jtfAccountCash.setEditable(false);
        jtfAccountCash.setText("ACCOUNT CASH");
        jtfAccountCash.setFocusable(false);
        jtfAccountCash.setPreferredSize(new java.awt.Dimension(170, 23));
        jPanel4.add(jtfAccountCash);

        jtfCode.setEditable(false);
        jtfCode.setText("CODE");
        jtfCode.setFocusable(false);
        jtfCode.setPreferredSize(new java.awt.Dimension(73, 23));
        jPanel4.add(jtfCode);

        jPanel3.add(jPanel4);

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlCurrency.setText("Moneda cuenta de efectivo:");
        jlCurrency.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel8.add(jlCurrency);

        jtfCurrency.setEditable(false);
        jtfCurrency.setText("CURRENCY");
        jtfCurrency.setFocusable(false);
        jtfCurrency.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel8.add(jtfCurrency);

        jPanel3.add(jPanel8);
        jPanel3.add(jPanel9);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlFkBizPartnerId.setText("Asociado de negocios: *");
        jlFkBizPartnerId.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel6.add(jlFkBizPartnerId);

        jcbFkBizPartnerId.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jcbFkBizPartnerId.setPreferredSize(new java.awt.Dimension(372, 23));
        jcbFkBizPartnerId.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jcbFkBizPartnerIdItemStateChanged(evt);
            }
        });
        jPanel6.add(jcbFkBizPartnerId);

        jbFkBizPartnerId.setText("jButton1");
        jbFkBizPartnerId.setToolTipText("Seleccionar asociado de negocios");
        jbFkBizPartnerId.setFocusable(false);
        jbFkBizPartnerId.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel6.add(jbFkBizPartnerId);

        jPanel3.add(jPanel6);

        jPanel13.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlCurrencyBizPartner.setText("Moneda asociado de negocios:");
        jlCurrencyBizPartner.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel13.add(jlCurrencyBizPartner);

        jtfCurrencyBizPartner.setEditable(false);
        jtfCurrencyBizPartner.setText("CURRENCY BIZ PARTNER");
        jtfCurrencyBizPartner.setFocusable(false);
        jtfCurrencyBizPartner.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel13.add(jtfCurrencyBizPartner);

        jPanel3.add(jPanel13);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlFkCurrencyBizPartnerId.setText("Moneda del movimiento:");
        jlFkCurrencyBizPartnerId.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel5.add(jlFkCurrencyBizPartnerId);

        jcbFkCurrencyBizPartnerId.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jcbFkCurrencyBizPartnerId.setPreferredSize(new java.awt.Dimension(200, 23));
        jcbFkCurrencyBizPartnerId.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jcbFkCurrencyBizPartnerIdItemStateChanged(evt);
            }
        });
        jPanel5.add(jcbFkCurrencyBizPartnerId);

        jbFkCurrencyBizPartnerId.setText("jButton1");
        jbFkCurrencyBizPartnerId.setToolTipText("Seleccionar moneda");
        jbFkCurrencyBizPartnerId.setFocusable(false);
        jbFkCurrencyBizPartnerId.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel5.add(jbFkCurrencyBizPartnerId);

        jPanel3.add(jPanel5);

        jPanel10.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlValueCy.setText("Monto: *");
        jlValueCy.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel10.add(jlValueCy);

        jtfValueCy.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfValueCy.setText("1,000,000,000.00");
        jtfValueCy.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel10.add(jtfValueCy);

        jbValueCy.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_action.gif"))); // NOI18N
        jbValueCy.setToolTipText("Calcular monto");
        jbValueCy.setFocusable(false);
        jbValueCy.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel10.add(jbValueCy);

        jlExchangeRateSystem.setText("Tipo de cambio sistema:");
        jlExchangeRateSystem.setPreferredSize(new java.awt.Dimension(118, 23));
        jPanel10.add(jlExchangeRateSystem);

        jtfExchangeRateSystem.setEditable(false);
        jtfExchangeRateSystem.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfExchangeRateSystem.setText("1,000,000,000.00");
        jtfExchangeRateSystem.setFocusable(false);
        jtfExchangeRateSystem.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel10.add(jtfExchangeRateSystem);

        jbExchangeRateSystem.setText("jButton5");
        jbExchangeRateSystem.setToolTipText("Seleccionar tipo de cambio sistema");
        jbExchangeRateSystem.setFocusable(false);
        jbExchangeRateSystem.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel10.add(jbExchangeRateSystem);

        jbExchangeRateAccountCashView.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_look.gif"))); // NOI18N
        jbExchangeRateAccountCashView.setToolTipText("Ver tipo de cambio acumulado");
        jbExchangeRateAccountCashView.setFocusable(false);
        jbExchangeRateAccountCashView.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel10.add(jbExchangeRateAccountCashView);

        jPanel3.add(jPanel10);

        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlValue.setText("Monto moneda local (ML): *");
        jlValue.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel11.add(jlValue);

        jtfValue.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfValue.setText("1,000,000,000.00");
        jtfValue.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel11.add(jtfValue);

        jbValue.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_action.gif"))); // NOI18N
        jbValue.setToolTipText("Calcular monto moneda local");
        jbValue.setFocusable(false);
        jbValue.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel11.add(jbValue);

        jlExchangeRate.setText("Tipo de cambio: *");
        jlExchangeRate.setPreferredSize(new java.awt.Dimension(118, 23));
        jPanel11.add(jlExchangeRate);

        jtfExchangeRate.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfExchangeRate.setText("1,000,000,000.00");
        jtfExchangeRate.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel11.add(jtfExchangeRate);

        jbExchangeRate.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_action.gif"))); // NOI18N
        jbExchangeRate.setToolTipText("Calcular tipo de cambio");
        jbExchangeRate.setFocusable(false);
        jbExchangeRate.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel11.add(jbExchangeRate);

        jbExchangeRateAccountCash.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_std_money.gif"))); // NOI18N
        jbExchangeRateAccountCash.setToolTipText("Asignar tipo de cambio acumulado");
        jbExchangeRateAccountCash.setFocusable(false);
        jbExchangeRateAccountCash.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel11.add(jbExchangeRateAccountCash);

        jPanel3.add(jPanel11);

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jckIsCheckApplying.setText("Cheque del movimiento");
        jckIsCheckApplying.setPreferredSize(new java.awt.Dimension(150, 23));
        jckIsCheckApplying.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jckIsCheckApplyingItemStateChanged(evt);
            }
        });
        jPanel7.add(jckIsCheckApplying);

        jcbFkCheckId_n.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jcbFkCheckId_n.setPreferredSize(new java.awt.Dimension(200, 23));
        jcbFkCheckId_n.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                jcbFkCheckId_nFocusLost(evt);
            }
        });
        jPanel7.add(jcbFkCheckId_n);

        jPanel3.add(jPanel7);

        jPanel12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 2, 0));

        jlConcept.setText("Concepto de la partida: *");
        jlConcept.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel12.add(jlConcept);

        jtfConcept.setText("CONCEPT");
        jtfConcept.setPreferredSize(new java.awt.Dimension(397, 23));
        jPanel12.add(jtfConcept);

        jPanel3.add(jPanel12);

        jPanel2.add(jPanel3, java.awt.BorderLayout.PAGE_START);

        getContentPane().add(jPanel2, java.awt.BorderLayout.CENTER);

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-575)/2, (screenSize.height-375)/2, 575, 375);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    private void jckIsCheckApplyingItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_jckIsCheckApplyingItemStateChanged
        if (!mbResetingForm) {
            itemStateChangedIsCheckApplying();
        }
    }//GEN-LAST:event_jckIsCheckApplyingItemStateChanged

    private void jcbFkBizPartnerIdItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_jcbFkBizPartnerIdItemStateChanged
        if (!mbResetingForm) {
            if (evt.getStateChange() == ItemEvent.SELECTED) {
                itemStateChangedBizPartner();
            }
        }
    }//GEN-LAST:event_jcbFkBizPartnerIdItemStateChanged

    private void jcbFkCurrencyBizPartnerIdItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_jcbFkCurrencyBizPartnerIdItemStateChanged
        if (!mbResetingForm) {
            if (evt.getStateChange() == ItemEvent.SELECTED) {
                itemStateChangedFkCurrencyBizPartnerId();
            }
        }
    }//GEN-LAST:event_jcbFkCurrencyBizPartnerIdItemStateChanged

    private void jcbFkCheckId_nFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jcbFkCheckId_nFocusLost
        focusLostFkCheckId_n();
    }//GEN-LAST:event_jcbFkCheckId_nFocusLost

    private void initComponentsExtra() {
        mvFields = new Vector<SFormField>();

        moFieldConcept = new SFormField(miClient, SLibConstants.DATA_TYPE_STRING, true, jtfConcept, jlConcept);
        moFieldConcept.setLengthMax(100);
        moFieldFkBizPartnerId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbFkBizPartnerId, jlFkBizPartnerId);
        moFieldFkBizPartnerId.setPickerButton(jbFkBizPartnerId);
        moFieldFkCurrencyBizPartnerId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbFkCurrencyBizPartnerId, jlFkCurrencyBizPartnerId);
        moFieldFkCurrencyBizPartnerId.setPickerButton(jbFkCurrencyBizPartnerId);
        moFieldValueCy = new SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, true, jtfValueCy, jlValueCy);
        moFieldValueCy.setDecimalFormat(miClient.getSessionXXX().getFormatters().getDecimalsValueFormat());
        moFieldExchangeRateSystem = new SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, false, jtfExchangeRateSystem, jlExchangeRateSystem);
        moFieldExchangeRateSystem.setDecimalFormat(miClient.getSessionXXX().getFormatters().getDecimalsExchangeRateFormat());
        moFieldValue = new SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, true, jtfValue, jlValue);
        moFieldValue.setDecimalFormat(miClient.getSessionXXX().getFormatters().getDecimalsValueFormat());
        moFieldExchangeRate = new SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, true, jtfExchangeRate, jlExchangeRate);
        moFieldExchangeRate.setDecimalFormat(miClient.getSessionXXX().getFormatters().getDecimalsExchangeRateFormat());
        moFieldFkCheckId_n = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, false, jcbFkCheckId_n, jckIsCheckApplying);

        mvFields.add(moFieldConcept);
        mvFields.add(moFieldFkBizPartnerId);
        mvFields.add(moFieldFkCurrencyBizPartnerId);
        mvFields.add(moFieldValueCy);
        mvFields.add(moFieldValue);
        mvFields.add(moFieldExchangeRateSystem);
        mvFields.add(moFieldExchangeRate);
        mvFields.add(moFieldFkCheckId_n);

        jbOk.addActionListener(this);
        jbCancel.addActionListener(this);
        jbFkBizPartnerId.addActionListener(this);
        jbFkCurrencyBizPartnerId.addActionListener(this);
        jbExchangeRate.addActionListener(this);
        jbExchangeRateSystem.addActionListener(this);
        jbValueCy.addActionListener(this);
        jbValue.addActionListener(this);
        jbExchangeRateAccountCash.addActionListener(this);
        jbExchangeRateAccountCashView.addActionListener(this);

        jtfValueCy.addFocusListener(this);
        jtfValue.addFocusListener(this);
        jtfExchangeRate.addFocusListener(this);

        moParamRecord = null;
        mvParamCheckVector = new Vector<SDataCheck>();
        mvParamCheckVector.clear();

        mnFkUser = 0;
        mnFkBizPartnerCurrencyId = 0;

        AbstractAction actionOk = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionOk(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionOk, "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);

        AbstractAction action = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionCancel(); }
        };

        SFormUtilities.putActionMap(getRootPane(), action, "cancel", KeyEvent.VK_ESCAPE, 0);
    }

    private void windowActivated() {
        if (mbFirstTime) {
            mbFirstTime = false;
            readAccountCashInformation();
            jcbFkBizPartnerId.requestFocus();
        }

        setFormTitle();
    }

    private void actionOk() {
        SFormValidation validation = formValidate();

        if (validation.getIsError()) {
            if (validation.getComponent() != null) {
                validation.getComponent().requestFocus();
            }
            if (validation.getMessage().length() > 0) {
                miClient.showMsgBoxWarning(validation.getMessage());
            }
        }
        else {
            mnFormResult = SLibConstants.FORM_RESULT_OK;
            setVisible(false);
        }
    }

    private void actionCancel() {
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        setVisible(false);
    }

    private double obtainTodayExchangeRate() {
        double rate = 0;

        try {
            rate = SDataUtilities.obtainExchangeRate(miClient,
                moFieldFkCurrencyBizPartnerId.getKeyAsIntArray()[0], moParamRecord.getDate());
        }
        catch (Exception e) {
            SLibUtilities.printOutException(this, e);
        }

        return rate;
    }

    private double obtainExchangeRateAccountCash() {
        double rate = 0;
        double[] balance = null;

        try {
            balance = obtainCurrentAccountCashBalance();
            rate = balance[0] == 0d ? 0d : balance[0] / balance[1];
        }
        catch (Exception e) {
            SLibUtilities.printOutException(this, e);
        }

        return rate;
    }

    private double[] obtainCurrentAccountCashBalance() {
        double[] balance = new double[2];

        try {
            balance = SDataUtilities.obtainAccountCashBalanceUpdated(miClient,
                moParamRecord.getDbmsDataAccountCash().getFkCurrencyId(), moParamRecord.getDate(),
                moParamRecord.getDbmsDataAccountCash().getPrimaryKey(),
                moParamRecord.getDbmsDataAccountCash().getFkAccountCashCategoryId() == SDataConstantsSys.FINS_CT_ACC_CASH_CASH ?
                    SDataConstantsSys.FINS_TP_SYS_MOV_CASH_CASH : SDataConstantsSys.FINS_TP_SYS_MOV_CASH_BANK,
                moParamRecord, moRecordEntry);
        }
        catch (Exception e) {
            SLibUtilities.printOutException(this, e);
        }

        return balance;
    }

    private void renderCurrencySettings() {
        if (moCurrencyBizPartner.getPkCurrencyId() != miClient.getSessionXXX().getParamsErp().getFkCurrencyId()) {
            jtfValue.setEnabled(true);
            jbValue.setEnabled(true);
            jtfExchangeRate.setEnabled(true);
            jbExchangeRate.setEnabled(true);
            jbExchangeRateSystem.setEnabled(true);
            jbExchangeRateAccountCashView.setEnabled(true);
            jbExchangeRateAccountCash.setEnabled(true);

            moFieldExchangeRate.setFieldValue(obtainTodayExchangeRate());

            if (moCurrency.getPkCurrencyId() == miClient.getSessionXXX().getParamsErp().getFkCurrencyId()) {
                jbExchangeRateAccountCashView.setEnabled(false);
                jbExchangeRateAccountCash.setEnabled(false);
            }
            else {
                jbExchangeRateAccountCashView.setEnabled(true);
                jbExchangeRateAccountCash.setEnabled(true);
            }
        }
        else {
            jtfValue.setEnabled(false);
            jbValue.setEnabled(false);
            jtfExchangeRate.setEnabled(false);
            jbExchangeRateSystem.setEnabled(false);
            jbExchangeRate.setEnabled(false);
            jbExchangeRateAccountCashView.setEnabled(false);
            jbExchangeRateAccountCash.setEnabled(false);

            moFieldExchangeRateSystem.setFieldValue(1);
            moFieldExchangeRate.setFieldValue(1);
        }
    }

    private void itemStateChangedIsCheckApplying() {
        if (!jckIsCheckApplying.isSelected()) {
            jcbFkCheckId_n.setEnabled(false);
        }
        else {
            jcbFkCheckId_n.setEnabled(true);
            jcbFkCheckId_n.requestFocus();
        }
    }

    private void itemStateChangedBizPartner() {
        if (moFieldFkBizPartnerId.getKeyAsIntArray()[0] > 0) {
            jcbFkCurrencyBizPartnerId.setEnabled(true);
            jbFkCurrencyBizPartnerId.setEnabled(true);
            readBizPartnerCurrency();
        }
        else {
            jcbFkCurrencyBizPartnerId.setEnabled(false);
            jbFkCurrencyBizPartnerId.setEnabled(false);
            renderCurrencySettings();
        }
    }

    private void itemStateChangedFkCurrencyBizPartnerId() {
        if (moFieldFkCurrencyBizPartnerId.getKeyAsIntArray()[0] > 0) {
            moCurrencyBizPartner = (SDataCurrency) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_CUR,
                new int[] { moFieldFkCurrencyBizPartnerId.getKeyAsIntArray()[0] }, SLibConstants.EXEC_MODE_SILENT);
        }
        else {
            moCurrencyBizPartner = miClient.getSessionXXX().getParamsErp().getDbmsDataCurrency();
        }

        renderCurrencySettings();
    }

    private void actionExchangeRateSystem() {
        double rate = miClient.pickExchangeRate(moCurrencyBizPartner.getPkCurrencyId(), miClient.getSessionXXX().getWorkingDate());

        if (rate != 0d) {
            moFieldExchangeRateSystem.setFieldValue(rate);
            if (moFieldExchangeRate.getDouble() == 0) {
                moFieldExchangeRate.setFieldValue(rate);
            }
            jtfExchangeRate.requestFocus();
        }
    }

    private void actionValueCy() {
        if (moFieldExchangeRate.getDouble() == 0) {
            jtfExchangeRate.requestFocus();
        }
        else {
            moFieldValueCy.setFieldValue(SLibUtilities.round(moFieldValue.getDouble() / moFieldExchangeRate.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsValue()));
            jtfValueCy.requestFocus();
        }
    }

    private void actionValue() {
        if (moFieldExchangeRate.getDouble() == 0) {
            jtfExchangeRate.requestFocus();
        }
        else {
            moFieldValue.setFieldValue(SLibUtilities.round(moFieldValueCy.getDouble() * moFieldExchangeRate.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsValue()));
            jtfValue.requestFocus();
        }
    }

    private void actionExchangeRate() {
        if (moFieldValueCy.getDouble() != 0) {

            if (moFieldValue.getDouble() == 0) {
                jtfValueCy.requestFocus();
            }
            else {
                moFieldExchangeRate.setFieldValue(moFieldValue.getDouble() / moFieldValueCy.getDouble());
                jtfExchangeRate.requestFocus();
            }
        }
        else if (moFieldValue.getDouble() != 0) {
            jtfValue.requestFocus();
        }
        else {
            jtfExchangeRate.requestFocus();
        }
    }

    private void actionExchangeRateAccountCash() {
        moFieldExchangeRate.setFieldValue(obtainExchangeRateAccountCash());
        jtfExchangeRate.requestFocus();
    }

    private void actionExchangeRateAccountCashView() {
        double[] balance = null;

        try {
            balance = obtainCurrentAccountCashBalance();

            miClient.showMsgBoxInformation(
                    "Tipo de cambio acumulado al dÃ­a: " + miClient.getSessionXXX().getFormatters().getDateFormat().format(moParamRecord.getDate()) + "\n" +
                    "Saldo " + miClient.getSessionXXX().getParamsErp().getDbmsDataCurrency().getKey() + ": $ " +
                    miClient.getSessionXXX().getFormatters().getDecimalsValueFormat().format(balance[0]) + ".\n" +
                    "Saldo " + moCurrency.getKey() + ": $ " +
                    miClient.getSessionXXX().getFormatters().getDecimalsValueFormat().format(balance[1]) + ".\n" +
                    "Tipo de cambio acumulado: " + miClient.getSessionXXX().getFormatters().getDecimalsExchangeRateFormat().format(balance[1] == 0d ? 0d : balance[0] / balance[1]) + ".");
        }
        catch (Exception e) {
            SLibUtilities.renderException(this, e);
        }
    }

    private void focusLostValueCy() {
        if (moFieldValueCy.getDouble() != 0) {

            if (!jtfValue.isEnabled() || moFieldValue.getDouble() == 0) {
                moFieldValue.setFieldValue(SLibUtilities.round(moFieldValueCy.getDouble() * moFieldExchangeRate.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsValue()));
            }
            else if (moFieldExchangeRate.getDouble() == 0) {
                moFieldExchangeRate.setFieldValue(SLibUtilities.round(moFieldValue.getDouble() / moFieldValueCy.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsExchangeRate()));
            }
        }
    }

    private void focusLostValue() {
        if (moFieldValue.getDouble() != 0) {

            if (moFieldValueCy.getDouble() == 0 && moFieldExchangeRate.getDouble() != 0) {
                moFieldValueCy.setFieldValue(SLibUtilities.round(moFieldValue.getDouble() / moFieldExchangeRate.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsValue()));
            }
            else if (moFieldValueCy.getDouble() != 0 && moFieldExchangeRate.getDouble() == 0) {
                moFieldExchangeRate.setFieldValue(SLibUtilities.round(moFieldValue.getDouble() / moFieldValueCy.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsExchangeRate()));
            }
        }
    }

    private void focusLostExchangeRate() {
        if (moFieldValueCy.getDouble() != 0 && moFieldValue.getDouble() == 0) {
            moFieldValue.setFieldValue(SLibUtilities.round(moFieldValueCy.getDouble() * moFieldExchangeRate.getDouble(),
                    miClient.getSessionXXX().getParamsErp().getDecimalsValue()));
        }
    }

    private void focusLostFkCheckId_n() {
        if (jcbFkCheckId_n.getSelectedIndex() > 0 && moFieldConcept.getString().length() == 0) {
            jtfConcept.setText("CH " + ((Integer) ((SFormComponentItem) jcbFkCheckId_n.getSelectedItem()).getComplement()) + "; " + moParamRecord.getDbmsDataAccountCash().getAuxCode() + " ");
        }
    }

    private boolean isMoneyIn() {
        return
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_CUS_ADV) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_SUP_ADV_REF) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_EXT_CDR) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_EXT_DBR);
    }

    private boolean isDebit() {
        return
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_CUS_ADV_REF) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_SUP_ADV) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_EXT_CDR) ||
                SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_EXT_DBR);
    }

    private void actionjbFkBizPartnerId() {
        miClient.pickOption(mnParamBizPartnerCategory, moFieldFkBizPartnerId, null);
    }

    private void actionjbFkCurrencyBizPartnerId() {
        miClient.pickOption(SDataConstants.CFGU_CUR, moFieldFkCurrencyBizPartnerId, null);
    }

    private void readAccountCashInformation() {
        SDataBizPartnerBranch oBranch = null;

        oBranch = (SDataBizPartnerBranch) SDataUtilities.readRegistry(miClient,
                SDataConstants.BPSU_BPB, new int[] { moParamRecord.getDbmsDataAccountCash().getPkCompanyBranchId() }, SLibConstants.EXEC_MODE_SILENT);
        moCurrency = (SDataCurrency) SDataUtilities.readRegistry(miClient,
                SDataConstants.CFGU_CUR, new int[] { moParamRecord.getDbmsDataAccountCash().getFkCurrencyId() }, SLibConstants.EXEC_MODE_SILENT);

        jtfCompanyBranch.setText(oBranch.getBizPartnerBranch());
        jtfAccountCash.setText(moParamRecord.getDbmsDataAccountCash().getDbmsCompanyBranchEntity().getEntity());
        jtfCode.setText(moParamRecord.getDbmsDataAccountCash().getDbmsCompanyBranchEntity().getCode());
        jtfCurrency.setText(moCurrency.getCurrency());
    }

    private void readBizPartnerCurrency() {
        moCurrencyBizPartner = null;
        SDataBizPartner oBizPartner = null;

        oBizPartner = (SDataBizPartner) SDataUtilities.readRegistry(miClient, SDataConstants.BPSU_BP, moFieldFkBizPartnerId.getKeyAsIntArray(), SLibConstants.EXEC_MODE_SILENT);

        switch(mnParamBizPartnerCategory) {
            case SDataConstants.BPSX_BP_SUP:
                if (oBizPartner.getDbmsCategorySettingsSup().getFkCurrencyId_n() > 0) {
                    moCurrencyBizPartner = (SDataCurrency) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_CUR,
                                new int[] { oBizPartner.getDbmsCategorySettingsSup().getFkCurrencyId_n() }, SLibConstants.EXEC_MODE_SILENT);
                }
                break;
            case SDataConstants.BPSX_BP_CUS:
                if (oBizPartner.getDbmsCategorySettingsCus().getFkCurrencyId_n() > 0) {
                    moCurrencyBizPartner = (SDataCurrency) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_CUR,
                                new int[] { oBizPartner.getDbmsCategorySettingsCus().getFkCurrencyId_n() }, SLibConstants.EXEC_MODE_SILENT);
                }
                break;
            case SDataConstants.BPSX_BP_CDR:
                if (oBizPartner.getDbmsCategorySettingsCdr().getFkCurrencyId_n() > 0) {
                    moCurrencyBizPartner = (SDataCurrency) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_CUR,
                                new int[] { oBizPartner.getDbmsCategorySettingsCdr().getFkCurrencyId_n() }, SLibConstants.EXEC_MODE_SILENT);
                }
                break;
            case SDataConstants.BPSX_BP_DBR:
                if (oBizPartner.getDbmsCategorySettingsDbr().getFkCurrencyId_n() > 0) {
                moCurrencyBizPartner = (SDataCurrency) SDataUtilities.readRegistry(miClient, SDataConstants.CFGU_CUR,
                            new int[] { oBizPartner.getDbmsCategorySettingsDbr().getFkCurrencyId_n() }, SLibConstants.EXEC_MODE_SILENT);
                }
                break;
            default:
        }

        if (moCurrencyBizPartner == null) {
            moCurrencyBizPartner = miClient.getSessionXXX().getParamsErp().getDbmsDataCurrency();
        }

        jtfCurrencyBizPartner.setText(moCurrencyBizPartner.getCurrency());
        moFieldFkCurrencyBizPartnerId.setKey(new int[] { moCurrencyBizPartner.getPkCurrencyId() });

        renderCurrencySettings();
    }

    private java.lang.String getBizPartnerAccountId() {
        String sBpAccount = "";
        String sMsg = "";
        Vector<Object> mvParams = new Vector<Object>();
        SDataBizPartner oBizPartner = null;

        mvParams.clear();

        oBizPartner = (SDataBizPartner) SDataUtilities.readRegistry(miClient, SDataConstants.BPSU_BP, moFieldFkBizPartnerId.getKeyAsIntArray(), SLibConstants.EXEC_MODE_SILENT);

        if (oBizPartner != null) {
            mvParams.add(oBizPartner.getPkBizPartnerId());

            switch(mnParamBizPartnerCategory) {
                case SDataConstants.BPSX_BP_SUP:
                    mvParams.add(oBizPartner.getDbmsCategorySettingsSup().getPkBizPartnerCategoryId());
                    mnFkBizPartnerCurrencyId = oBizPartner.getDbmsCategorySettingsSup().getFkCurrencyId_n();
                    break;
                case SDataConstants.BPSX_BP_CUS:
                    mvParams.add(oBizPartner.getDbmsCategorySettingsCus().getPkBizPartnerCategoryId());
                    mnFkBizPartnerCurrencyId = oBizPartner.getDbmsCategorySettingsCus().getFkCurrencyId_n();
                    break;
                case SDataConstants.BPSX_BP_CDR:
                    mvParams.add(oBizPartner.getDbmsCategorySettingsCdr().getPkBizPartnerCategoryId());
                    mnFkBizPartnerCurrencyId = oBizPartner.getDbmsCategorySettingsCdr().getFkCurrencyId_n();
                    break;
                case SDataConstants.BPSX_BP_DBR:
                    mvParams.add(oBizPartner.getDbmsCategorySettingsDbr().getPkBizPartnerCategoryId());
                    mnFkBizPartnerCurrencyId = oBizPartner.getDbmsCategorySettingsDbr().getFkCurrencyId_n();
                    break;
                default:
            }

            mvParams.add(miClient.getSessionXXX().getCompany().getDbmsDataCompany().getDbmsHqBranch().getDbmsDataCompanyBranchBkc().getPkBookkepingCenterId());
            mvParams.add(SDataConstantsSys.FINS_TP_ACC_BP_PAY);
            mvParams.add(moParamRecord.getDate());
            mvParams = SDataUtilities.callProcedure(miClient, SProcConstants.FIN_ACC_BP_GET,  mvParams, SLibConstants.EXEC_MODE_SILENT);

            if (mvParams.size() > 0) {
                if (SLibUtilities.parseInt(mvParams.get(1).toString()) > 0) {
                    sMsg = mvParams.get(2).toString();
                }
                sBpAccount = mvParams.get(0).toString();
            }
        }

        return sBpAccount;
    }

    private erp.mfin.data.SDataRecordEntry prepareRecordEntry() {
        int[] keySystemMoveType = null;
        int[] keySystemAccountType = null;
        SDataRecordEntry oEntry = new SDataRecordEntry();

        oEntry.setConcept(moFieldConcept.getString());
        oEntry.setDebit(isDebit() ? moFieldValue.getDouble() : 0d);
        oEntry.setCredit(isDebit() ? 0d : moFieldValue.getDouble());
        oEntry.setExchangeRate(moFieldExchangeRate.getDouble());
        oEntry.setExchangeRateSystem(moFieldExchangeRateSystem.getDouble());
        oEntry.setDebitCy(isDebit() ? moFieldValueCy.getDouble() : 0d);
        oEntry.setCreditCy(isDebit() ? 0d : moFieldValueCy.getDouble());
        oEntry.setFkAccountIdXXX(getBizPartnerAccountId());
        oEntry.setFkAccountingMoveTypeId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[0]);
        oEntry.setFkAccountingMoveClassId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[1]);
        oEntry.setFkAccountingMoveSubclassId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[2]);

        switch (mnParamBizPartnerCategory) {
            case SDataConstants.BPSX_BP_SUP:
                keySystemAccountType = SModSysConsts.FINS_TP_SYS_ACC_BPR_SUP_BAL;
                keySystemMoveType = isDebit() ? SModSysConsts.FINS_TP_SYS_MOV_MO_SUP_PAY : SModSysConsts.FINS_TP_SYS_MOV_MI_SUP_PAY;
                break;
            case SDataConstants.BPSX_BP_CUS:
                keySystemAccountType = SModSysConsts.FINS_TP_SYS_ACC_BPR_CUS_BAL;
                keySystemMoveType = isDebit() ? SModSysConsts.FINS_TP_SYS_MOV_MO_CUS_PAY : SModSysConsts.FINS_TP_SYS_MOV_MI_CUS_PAY;
                break;
            case SDataConstants.BPSX_BP_CDR:
                keySystemAccountType = SModSysConsts.FINS_TP_SYS_ACC_BPR_CDR_BAL;
                keySystemMoveType = isDebit() ? SModSysConsts.FINS_TP_SYS_MOV_MO_CDR_PAY : SModSysConsts.FINS_TP_SYS_MOV_MI_CDR_PAY;
                break;
            case SDataConstants.BPSX_BP_DBR:
                keySystemAccountType = SModSysConsts.FINS_TP_SYS_ACC_BPR_DBR_BAL;
                keySystemMoveType = isDebit() ? SModSysConsts.FINS_TP_SYS_MOV_MO_DBR_PAY : SModSysConsts.FINS_TP_SYS_MOV_MI_DBR_PAY;
                break;
            default:
        }

        oEntry.setFkSystemMoveClassId(keySystemMoveType[0]);
        oEntry.setFkSystemMoveTypeId(keySystemMoveType[1]);
        oEntry.setFkSystemAccountClassId(keySystemAccountType[0]);
        oEntry.setFkSystemAccountTypeId(keySystemAccountType[1]);

        oEntry.setFkSystemMoveCategoryIdXXX(SDataConstantsSys.FINS_CT_SYS_MOV_BPS);
        oEntry.setFkSystemMoveTypeIdXXX(
                mnParamBizPartnerCategory == SDataConstants.BPSX_BP_SUP ? SDataConstantsSys.FINS_TP_SYS_MOV_BPS_SUP[1] :
                mnParamBizPartnerCategory == SDataConstants.BPSX_BP_CUS ? SDataConstantsSys.FINS_TP_SYS_MOV_BPS_CUS[1] :
                mnParamBizPartnerCategory == SDataConstants.BPSX_BP_CDR ? SDataConstantsSys.FINS_TP_SYS_MOV_BPS_CDR[1] :
                SDataConstantsSys.FINS_TP_SYS_MOV_BPS_DBR[1]);
        oEntry.setFkCurrencyId(moFieldFkCurrencyBizPartnerId.getKeyAsIntArray()[0]);
        oEntry.setFkBizPartnerId_nr(moFieldFkBizPartnerId.getKeyAsIntArray()[0]);
        oEntry.setFkCompanyBranchId_n(moParamRecord.getDbmsDataAccountCash().getPkCompanyBranchId());
        oEntry.setFkEntityId_n(moParamRecord.getDbmsDataAccountCash().getPkAccountCashId());
        oEntry.setDbmsAccount(SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FIN_ACC, new Object[] { oEntry.getFkAccountIdXXX() }));
        oEntry.setDbmsAccountComplement(moFieldFkBizPartnerId.getString());
        oEntry.setDbmsAccountingMoveSubclass(SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CLS_ACC_MOV, SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL));
        oEntry.setDbmsCurrencyKey((String) ((SFormComponentItem) jcbFkCurrencyBizPartnerId.getSelectedItem()).getComplement());

        if (!jckIsCheckApplying.isSelected()) {
            oEntry.setFkCheckWalletId_n(0);
            oEntry.setFkCheckId_n(0);
            oEntry.setAuxCheckNumber(0);
        }
        else {
            oEntry.setFkCheckWalletId_n(moFieldFkCheckId_n.getKeyAsIntArray()[0]);
            oEntry.setFkCheckId_n(moFieldFkCheckId_n.getKeyAsIntArray()[1]);
            oEntry.setAuxCheckNumber(((Integer) ((SFormComponentItem) jcbFkCheckId_n.getSelectedItem()).getComplement()).intValue());
        }

        oEntry.setFkUserNewId(miClient.getSession().getUser().getPkUserId());
        oEntry.setFkUserEditId(mnFkUser > 0 ? miClient.getSession().getUser().getPkUserId() : SDataConstantsSys.USRX_USER_NA);
        return oEntry;
    }

    public void setFormTitle() {
        if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_CUS_ADV)) {
            setTitle("Ingreso anticipo cobro a clientes");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_CUS_ADV_REF)) {
            setTitle("Egreso reembolso anticipo cobro a clientes");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_SUP_ADV)) {
            setTitle("Egreso anticipo pago a proveedores");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_SUP_ADV_REF)) {
            setTitle("Ingreso reembolso anticipo pago a proveedores");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_EXT_DBR)) {
            setTitle("Ingreso por deudores diversos");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_EXT_DBR)) {
            setTitle("Egreso por deudores diversos");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_IN_EXT_CDR)) {
            setTitle("Ingreso por acreedores diversos");
        }
        else if (SLibUtilities.compareKeys(manParamAccountingMove, SDataConstantsSys.FINS_CLS_ACC_MOV_CASH_OUT_EXT_CDR)) {
            setTitle("Egreso por acreedores diversos");
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JPanel jPanel13;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbExchangeRate;
    private javax.swing.JButton jbExchangeRateAccountCash;
    private javax.swing.JButton jbExchangeRateAccountCashView;
    private javax.swing.JButton jbExchangeRateSystem;
    private javax.swing.JButton jbFkBizPartnerId;
    private javax.swing.JButton jbFkCurrencyBizPartnerId;
    private javax.swing.JButton jbOk;
    private javax.swing.JButton jbValue;
    private javax.swing.JButton jbValueCy;
    private javax.swing.JComboBox jcbFkBizPartnerId;
    private javax.swing.JComboBox jcbFkCheckId_n;
    private javax.swing.JComboBox jcbFkCurrencyBizPartnerId;
    private javax.swing.JCheckBox jckIsCheckApplying;
    private javax.swing.JLabel jlAccountCash;
    private javax.swing.JLabel jlConcept;
    private javax.swing.JLabel jlCurrency;
    private javax.swing.JLabel jlCurrencyBizPartner;
    private javax.swing.JLabel jlExchangeRate;
    private javax.swing.JLabel jlExchangeRateSystem;
    private javax.swing.JLabel jlFkBizPartnerId;
    private javax.swing.JLabel jlFkCurrencyBizPartnerId;
    private javax.swing.JLabel jlValue;
    private javax.swing.JLabel jlValueCy;
    private javax.swing.JTextField jtfAccountCash;
    private javax.swing.JTextField jtfCode;
    private javax.swing.JTextField jtfCompanyBranch;
    private javax.swing.JTextField jtfConcept;
    private javax.swing.JTextField jtfCurrency;
    private javax.swing.JTextField jtfCurrencyBizPartner;
    private javax.swing.JTextField jtfExchangeRate;
    private javax.swing.JTextField jtfExchangeRateSystem;
    private javax.swing.JTextField jtfValue;
    private javax.swing.JTextField jtfValueCy;
    // End of variables declaration//GEN-END:variables

    @Override
    public void formClearRegistry() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void formReset() {
        mnFormResult = SLibConstants.UNDEFINED;
        mnFormStatus = SLibConstants.UNDEFINED;
        mbFirstTime = true;

        moCheck = null;
        moRecordEntry = null;

        for (int i = 0; i < mvFields.size(); i++) {
            ((erp.lib.form.SFormField) mvFields.get(i)).resetField();
        }

        moCurrencyBizPartner = null;
        jtfCurrencyBizPartner.setText("");
        jckIsCheckApplying.setEnabled(isMoneyIn() ? false : true);
        jckIsCheckApplying.setSelected(false);
        jcbFkCurrencyBizPartnerId.setEnabled(false);
        jtfValue.setEnabled(false);
        jbValue.setEnabled(false);
        jtfExchangeRate.setEnabled(false);
        jbExchangeRateSystem.setEnabled(false);
        jbExchangeRate.setEnabled(false);
        jbExchangeRateAccountCashView.setEnabled(false);
        jbExchangeRateAccountCash.setEnabled(false);
        itemStateChangedIsCheckApplying();
        mbResetingForm = false;
    }

    @Override
    public void formRefreshCatalogues() {
        mbResetingForm = true;
        SFormUtilities.populateComboBox(miClient, jcbFkBizPartnerId, mnParamBizPartnerCategory);
        SFormUtilities.populateComboBox(miClient, jcbFkCurrencyBizPartnerId, SDataConstants.CFGU_CUR);
    }

    @Override
    public erp.lib.form.SFormValidation formValidate() {
        String message = "";
        SFormValidation validation = new SFormValidation();

        for (int i = 0; i < mvFields.size(); i++) {
            if (!((erp.lib.form.SFormField) mvFields.get(i)).validateField()){
                validation.setIsError(true);
                validation.setComponent(((erp.lib.form.SFormField) mvFields.get(i)).getComponent());
                break;
            }
        }

        if (!validation.getIsError()) {
            message = SDataUtilities.validateExchangeRate(miClient, moFieldValueCy.getDouble(), moFieldExchangeRate.getDouble(), moFieldValue.getDouble(), jlValueCy.getText());
            if (message.length() > 0) {
                if (miClient.showMsgBoxConfirm(message + "\n" + SLibConstants.MSG_CNF_MSG_CONT) != JOptionPane.YES_OPTION) {
                    validation.setMessage(SLibConstants.MSG_ERR_GUI_FIELD_VALUE_DIF + "'" + jlValueCy.getText() + "'.");
                    validation.setComponent(jtfValueCy);
                }
            }
            else if (jckIsCheckApplying.isSelected() && jcbFkCheckId_n.getSelectedIndex() <= 0) {
                validation.setMessage(SLibConstants.MSG_ERR_GUI_FIELD_EMPTY + "'" + jckIsCheckApplying.getText() + "'.");
                validation.setComponent(jcbFkCheckId_n);
            }
            else if (getBizPartnerAccountId().length() == 0) {
                validation.setMessage("No se encuentra la cuenta contable del asociado de negocio");
                validation.setComponent(jcbFkBizPartnerId);
            }
        }

        return validation;
    }

    @Override
    public void setFormStatus(int status) {
        mnFormStatus = status;
    }

    @Override
    public void setFormVisible(boolean visible) {
        setVisible(visible);
    }

    @Override
    public int getFormStatus() {
        return mnFormStatus;
    }

    @Override
    public int getFormResult() {
        return mnFormResult;
    }

    @Override
    public void setRegistry(erp.lib.data.SDataRegistry registry) {
        moRecordEntry = (SDataRecordEntry) registry;

        moFieldConcept.setFieldValue(moRecordEntry.getConcept());
        moFieldFkBizPartnerId.setKey(new int[] { moRecordEntry.getFkBizPartnerId_nr() });
        moFieldValueCy.setFieldValue(moCheck.getValue());
        moFieldValue.setFieldValue(moRecordEntry.getCredit());
        moFieldExchangeRateSystem.setFieldValue(moRecordEntry.getExchangeRateSystem());
        moFieldExchangeRate.setFieldValue(moRecordEntry.getExchangeRate());

        mnFkUser = moRecordEntry.getFkUserNewId();
    }

    @Override
    public erp.lib.data.SDataRegistry getRegistry() {
        moRecordEntry = prepareRecordEntry();

        return moRecordEntry;
    }

    @Override
    @SuppressWarnings("unchecked")
    public void setValue(int type, java.lang.Object value) {
        if (type == SDataConstants.FIN_REC) {
            moParamRecord = (SDataRecord) value;
        }
        else if (type == SDataConstants.FIN_CHECK) {
            SFormComponentItem item = null;
            mvParamCheckVector = (Vector<SDataCheck>) value;
            jcbFkCheckId_n.removeAllItems();
            jcbFkCheckId_n.addItem(new SFormComponentItem(new int[] { 0, 0 }, "(Seleccionar cheque)"));

            for (SDataCheck check : mvParamCheckVector) {
                item = new SFormComponentItem(check.getPrimaryKey(), "#" + check.getNumber() + "; " +
                        miClient.getSessionXXX().getFormatters().getDecimalsCurrencyFormat().format(check.getValue()) + "; " +
                        check.getBeneficiary());
                item.setComplement(check.getNumber());

                jcbFkCheckId_n.addItem(item);
            }

            jcbFkCheckId_n.setSelectedIndex(0);
        }
        else if (type == SDataConstants.BPSU_BP) {
            mnParamBizPartnerCategory = (Integer) value;
        }
        else if (type == SDataConstants.FINS_CLS_ACC_MOV) {
            manParamAccountingMove = (int[]) value;
        }
    }

    @Override
    public java.lang.Object getValue(int type) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public javax.swing.JLabel getTimeoutLabel() {
        return null;
    }

    @Override
    public void actionPerformed(java.awt.event.ActionEvent e) {
        if (e.getSource() instanceof javax.swing.JButton) {
            javax.swing.JButton button = (javax.swing.JButton) e.getSource();

            if (button == jbOk) {
                actionOk();
            }
            else if (button == jbCancel) {
                actionCancel();
            }
            else if (button == jbFkBizPartnerId) {
                actionjbFkBizPartnerId();
            }
            else if (button == jbFkCurrencyBizPartnerId) {
                actionjbFkCurrencyBizPartnerId();
            }
            else if (button == jbValueCy) {
                actionValueCy();
            }
            else if (button == jbValue) {
                actionValue();
            }
            else if (button == jbExchangeRateSystem) {
                actionExchangeRateSystem();
            }
            else if (button == jbExchangeRate) {
                actionExchangeRate();
            }
            else if (button == jbExchangeRateAccountCash) {
                actionExchangeRateAccountCash();
            }
            else if (button == jbExchangeRateAccountCashView) {
                actionExchangeRateAccountCashView();
            }
        }
    }

    @Override
    public void focusGained(java.awt.event.FocusEvent e) {

    }

    @Override
    public void focusLost(java.awt.event.FocusEvent e) {
        if (e.getSource() instanceof javax.swing.JTextField) {
            JTextField textField = (JTextField) e.getSource();

            if (textField == jtfValueCy) {
                focusLostValueCy();
            }
            else if (textField == jtfValue) {
                focusLostValue();
            }
            else if (textField == jtfExchangeRate) {
                focusLostExchangeRate();
            }
        }
    }
}
