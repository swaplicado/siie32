/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mod.trn.form;

import erp.mod.SModConsts;
import erp.mod.SModSysConsts;
import erp.mod.cfg.db.SDbCustomerReport;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import sa.lib.SLibConsts;
import sa.lib.SLibTimeUtils;
import sa.lib.SLibUtils;
import sa.lib.db.SDbConsts;
import sa.lib.gui.SGuiClient;
import sa.lib.gui.SGuiUtils;
import sa.lib.gui.SGuiValidation;

/**
 *
 * @author Isabel Servín
 */
public class SDialogCustomReportFsc extends sa.lib.gui.bean.SBeanDialogReport implements ActionListener {
    
    SDbCustomerReport moCustomerRep;
    boolean mbConfEdit;
    
    /**
     * Creates new form SDialogRepFSC
     * @param client
     * @param subType
     * @param title
     */
    public SDialogCustomReportFsc(SGuiClient client, int subType, String title) {
        setFormSettings(client, SModConsts.TRNR_VTAS_FSC, subType, title);

        initComponents();
        initComponentsCustom();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgDocs = new javax.swing.ButtonGroup();
        bgReport = new javax.swing.ButtonGroup();
        jPanel2 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jPanel16 = new javax.swing.JPanel();
        jlDateStart = new javax.swing.JLabel();
        moDateStart = new sa.lib.gui.bean.SBeanFieldDate();
        jPanel7 = new javax.swing.JPanel();
        jlDateEnd = new javax.swing.JLabel();
        moDateEnd = new sa.lib.gui.bean.SBeanFieldDate();
        jPanel5 = new javax.swing.JPanel();
        moRadioDocsAll = new sa.lib.gui.bean.SBeanFieldRadio();
        jLabel1 = new javax.swing.JLabel();
        moRadioReportDetail = new sa.lib.gui.bean.SBeanFieldRadio();
        jPanel6 = new javax.swing.JPanel();
        moRadioDocsCurrency = new sa.lib.gui.bean.SBeanFieldRadio();
        moKeyCur = new sa.lib.gui.bean.SBeanFieldKey();
        jLabel2 = new javax.swing.JLabel();
        moRadioReportSummary = new sa.lib.gui.bean.SBeanFieldRadio();
        jPanel4 = new javax.swing.JPanel();
        jPanel18 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jPanel9 = new javax.swing.JPanel();
        jlTitle = new javax.swing.JLabel();
        moTextTitle = new sa.lib.gui.bean.SBeanFieldText();
        jPanel11 = new javax.swing.JPanel();
        jPanel10 = new javax.swing.JPanel();
        jPanel12 = new javax.swing.JPanel();
        jlItemKeys = new javax.swing.JLabel();
        jspItemKeys = new javax.swing.JScrollPane();
        jtaItemKeys = new javax.swing.JTextArea();
        jPanel21 = new javax.swing.JPanel();
        jlItemKeysHelp = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jPanel22 = new javax.swing.JPanel();
        jlItemNames = new javax.swing.JLabel();
        jspItemNames = new javax.swing.JScrollPane();
        jtaItemNames = new javax.swing.JTextArea();
        jPanel23 = new javax.swing.JPanel();
        jlItemNamesHelp = new javax.swing.JLabel();
        jPanel14 = new javax.swing.JPanel();
        jPanel15 = new javax.swing.JPanel();
        jPanel17 = new javax.swing.JPanel();
        jbModify = new javax.swing.JButton();
        jPanel19 = new javax.swing.JPanel();
        jbSaveConf = new javax.swing.JButton();
        jPanel20 = new javax.swing.JPanel();
        jbCancelConf = new javax.swing.JButton();

        jPanel2.setLayout(new java.awt.BorderLayout(0, 5));

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder("Parámetros del reporte:"));
        jPanel3.setLayout(new java.awt.GridLayout(4, 0, 0, 5));

        jPanel16.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDateStart.setText("Fecha inicial:*");
        jlDateStart.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel16.add(jlDateStart);
        jPanel16.add(moDateStart);

        jPanel3.add(jPanel16);

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDateEnd.setText("Fecha final:*");
        jlDateEnd.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel7.add(jlDateEnd);
        jPanel7.add(moDateEnd);

        jPanel3.add(jPanel7);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        bgDocs.add(moRadioDocsAll);
        moRadioDocsAll.setSelected(true);
        moRadioDocsAll.setText("Todos los documentos");
        moRadioDocsAll.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel5.add(moRadioDocsAll);

        jLabel1.setPreferredSize(new java.awt.Dimension(255, 23));
        jPanel5.add(jLabel1);

        bgReport.add(moRadioReportDetail);
        moRadioReportDetail.setSelected(true);
        moRadioReportDetail.setText("Reporte a detalle");
        moRadioReportDetail.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel5.add(moRadioReportDetail);

        jPanel3.add(jPanel5);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        bgDocs.add(moRadioDocsCurrency);
        moRadioDocsCurrency.setText("Sólo documentos en moneda:");
        moRadioDocsCurrency.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel6.add(moRadioDocsCurrency);

        moKeyCur.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel6.add(moKeyCur);

        jLabel2.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel6.add(jLabel2);

        bgReport.add(moRadioReportSummary);
        moRadioReportSummary.setText("Reporte en resumen");
        moRadioReportSummary.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel6.add(moRadioReportSummary);

        jPanel3.add(jPanel6);

        jPanel2.add(jPanel3, java.awt.BorderLayout.NORTH);

        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Configuración del reporte:"));
        jPanel4.setLayout(new java.awt.BorderLayout(5, 0));

        jPanel18.setLayout(new java.awt.BorderLayout(0, 5));

        jPanel8.setLayout(new java.awt.GridLayout(1, 0, 0, 5));

        jPanel9.setLayout(new java.awt.BorderLayout(5, 0));

        jlTitle.setText("Titulo del reporte:");
        jlTitle.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel9.add(jlTitle, java.awt.BorderLayout.WEST);

        moTextTitle.setPreferredSize(new java.awt.Dimension(640, 23));
        jPanel9.add(moTextTitle, java.awt.BorderLayout.CENTER);

        jPanel8.add(jPanel9);

        jPanel18.add(jPanel8, java.awt.BorderLayout.NORTH);

        jPanel11.setLayout(new java.awt.GridLayout(1, 2, 5, 0));

        jPanel10.setLayout(new java.awt.BorderLayout(0, 5));

        jPanel12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlItemKeys.setText("Claves de ítems a incluir en el reporte:");
        jlItemKeys.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel12.add(jlItemKeys);

        jPanel10.add(jPanel12, java.awt.BorderLayout.NORTH);

        jtaItemKeys.setColumns(20);
        jtaItemKeys.setRows(5);
        jspItemKeys.setViewportView(jtaItemKeys);

        jPanel10.add(jspItemKeys, java.awt.BorderLayout.CENTER);

        jPanel21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlItemKeysHelp.setForeground(java.awt.Color.gray);
        jlItemKeysHelp.setText("Coincidencia exacta. Separar claves con salto de línea.");
        jlItemKeysHelp.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel21.add(jlItemKeysHelp);

        jPanel10.add(jPanel21, java.awt.BorderLayout.SOUTH);

        jPanel11.add(jPanel10);

        jPanel1.setLayout(new java.awt.BorderLayout(0, 5));

        jPanel22.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlItemNames.setText("Textos de nombres de ítems a incluir en el reporte:");
        jlItemNames.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel22.add(jlItemNames);

        jPanel1.add(jPanel22, java.awt.BorderLayout.NORTH);

        jtaItemNames.setColumns(20);
        jtaItemNames.setRows(5);
        jspItemNames.setViewportView(jtaItemNames);

        jPanel1.add(jspItemNames, java.awt.BorderLayout.CENTER);

        jPanel23.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlItemNamesHelp.setForeground(java.awt.Color.gray);
        jlItemNamesHelp.setText("Coincidencia por contenido. Separar textos con salto de línea.");
        jlItemNamesHelp.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel23.add(jlItemNamesHelp);

        jPanel1.add(jPanel23, java.awt.BorderLayout.SOUTH);

        jPanel11.add(jPanel1);

        jPanel18.add(jPanel11, java.awt.BorderLayout.CENTER);

        jPanel4.add(jPanel18, java.awt.BorderLayout.CENTER);

        jPanel14.setLayout(new java.awt.BorderLayout());

        jPanel15.setLayout(new java.awt.GridLayout(3, 0, 0, 5));

        jPanel17.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.CENTER, 5, 0));

        jbModify.setText("Modificar");
        jbModify.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel17.add(jbModify);

        jPanel15.add(jPanel17);

        jPanel19.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.CENTER, 5, 0));

        jbSaveConf.setText("Guardar");
        jbSaveConf.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel19.add(jbSaveConf);

        jPanel15.add(jPanel19);

        jPanel20.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.CENTER, 5, 0));

        jbCancelConf.setText("Cancelar");
        jbCancelConf.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel20.add(jbCancelConf);

        jPanel15.add(jPanel20);

        jPanel14.add(jPanel15, java.awt.BorderLayout.NORTH);

        jPanel4.add(jPanel14, java.awt.BorderLayout.EAST);

        jPanel2.add(jPanel4, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel2, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgDocs;
    private javax.swing.ButtonGroup bgReport;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JPanel jPanel14;
    private javax.swing.JPanel jPanel15;
    private javax.swing.JPanel jPanel16;
    private javax.swing.JPanel jPanel17;
    private javax.swing.JPanel jPanel18;
    private javax.swing.JPanel jPanel19;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel20;
    private javax.swing.JPanel jPanel21;
    private javax.swing.JPanel jPanel22;
    private javax.swing.JPanel jPanel23;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbCancelConf;
    private javax.swing.JButton jbModify;
    private javax.swing.JButton jbSaveConf;
    private javax.swing.JLabel jlDateEnd;
    private javax.swing.JLabel jlDateStart;
    private javax.swing.JLabel jlItemKeys;
    private javax.swing.JLabel jlItemKeysHelp;
    private javax.swing.JLabel jlItemNames;
    private javax.swing.JLabel jlItemNamesHelp;
    private javax.swing.JLabel jlTitle;
    private javax.swing.JScrollPane jspItemKeys;
    private javax.swing.JScrollPane jspItemNames;
    private javax.swing.JTextArea jtaItemKeys;
    private javax.swing.JTextArea jtaItemNames;
    private sa.lib.gui.bean.SBeanFieldDate moDateEnd;
    private sa.lib.gui.bean.SBeanFieldDate moDateStart;
    private sa.lib.gui.bean.SBeanFieldKey moKeyCur;
    private sa.lib.gui.bean.SBeanFieldRadio moRadioDocsAll;
    private sa.lib.gui.bean.SBeanFieldRadio moRadioDocsCurrency;
    private sa.lib.gui.bean.SBeanFieldRadio moRadioReportDetail;
    private sa.lib.gui.bean.SBeanFieldRadio moRadioReportSummary;
    private sa.lib.gui.bean.SBeanFieldText moTextTitle;
    // End of variables declaration//GEN-END:variables

    private void initComponentsCustom() {
        SGuiUtils.setWindowBounds(this, 880, 550);
        mbConfEdit = false;
        moTextTitle.setEnabled(false);
        jtaItemKeys.setEnabled(false);
        jtaItemNames.setEnabled(false);
        jbSaveConf.setEnabled(false);
        jbCancelConf.setEnabled(false);

        moDateStart.setDateSettings(miClient, SGuiUtils.getLabelName(jlDateStart.getText()), false);
        moDateEnd.setDateSettings(miClient, SGuiUtils.getLabelName(jlDateEnd.getText()), false);
        moRadioDocsAll.setBooleanSettings(SGuiUtils.getLabelName(moRadioDocsAll.getText()), true);
        moRadioDocsCurrency.setBooleanSettings(SGuiUtils.getLabelName(moRadioDocsCurrency.getText()), false);
        moKeyCur.setKeySettings(miClient, SGuiUtils.getLabelName(moRadioDocsCurrency.getText()), false);
        moRadioReportDetail.setBooleanSettings(SGuiUtils.getLabelName(moRadioReportDetail.getText()), true);
        moRadioReportSummary.setBooleanSettings(SGuiUtils.getLabelName(moRadioReportSummary.getText()), false);
        
        moTextTitle.setTextSettings(SGuiUtils.getLabelName(jlTitle), 100);
        
        moFields.addField(moDateStart);
        moFields.addField(moDateEnd);
        moFields.addField(moRadioDocsAll);
        moFields.addField(moRadioDocsCurrency);
        moFields.addField(moKeyCur);
        
        moCustomerRep = new SDbCustomerReport();
        reloadCatalogues();
        
        jbModify.addActionListener(this);
        jbSaveConf.addActionListener(this);
        jbCancelConf.addActionListener(this);
    }
    
    private void reloadCatalogues() {
        try {
            moDateStart.setValue(SLibTimeUtils.getBeginOfYear(miClient.getSession().getCurrentDate()));
            moDateEnd.setValue(SLibTimeUtils.getEndOfMonth(miClient.getSession().getCurrentDate()));
            miClient.getSession().populateCatalogue(moKeyCur, SModConsts.CFGU_CUR, SLibConsts.UNDEFINED, null);
            moCustomerRep.readByReportKey(miClient.getSession(), SModSysConsts.CFG_CUSTOM_REP_FSC);
            moTextTitle.setValue(moCustomerRep.getName());
            jtaItemKeys.setText(moCustomerRep.getSettingsCode().replaceAll(",", "\n"));
            jtaItemNames.setText(moCustomerRep.getSettingsName().replaceAll(",", "\n"));
        }
        catch (Exception e) {
            miClient.showMsgBoxError(e.getMessage());
        }
    }
    
    private void actionModify() {
        mbConfEdit = true;
        jbSaveConf.setEnabled(true);
        jbCancelConf.setEnabled(true);
        moTextTitle.setEnabled(true);
        jtaItemKeys.setEnabled(true);
        jtaItemNames.setEnabled(true);
        jbPrint.setEnabled(false);
    }
    
    private void actionSaveConf() {
        if (mbConfEdit) {
            if (miClient.showMsgBoxConfirm("¿Está seguro/a de guardar la nueva configuración?") == JOptionPane.OK_OPTION) {
                try {
                    moCustomerRep.setRegistryEdited(true);
                    moCustomerRep.setName(moTextTitle.getValue());
                    moCustomerRep.setSettingsCode(jtaItemKeys.getText().replaceAll("\n", ","));
                    moCustomerRep.setSettingsName(jtaItemNames.getText().replaceAll("\n", ","));
                    moCustomerRep.save(miClient.getSession());
                    if (moCustomerRep.getQueryResultId() == SDbConsts.SAVE_OK) {
                        miClient.showMsgBoxInformation("¡Configuración guardada con éxito!");
                        mbConfEdit = false;
                        jbSaveConf.setEnabled(false);
                        jbCancelConf.setEnabled(false);
                        moTextTitle.setEnabled(false);
                        jtaItemKeys.setEnabled(false);
                        jtaItemNames.setEnabled(false);
                        jbPrint.setEnabled(true);
                    }
                }
                catch (Exception e) {
                    miClient.showMsgBoxError(e.getMessage());
                }
            }
        }
    }

    private void actionCancelConf() {
        mbConfEdit = false;
        jbSaveConf.setEnabled(false);
        jbCancelConf.setEnabled(false);
        moTextTitle.setEnabled(false);
        jtaItemKeys.setEnabled(false);
        jtaItemNames.setEnabled(false);
        jbPrint.setEnabled(true);
        moTextTitle.setValue(moCustomerRep.getName());
        jtaItemKeys.setText(moCustomerRep.getSettingsCode().replaceAll(",", "\n"));
        jtaItemNames.setText(moCustomerRep.getSettingsName().replaceAll(",", "\n"));
    }
    
    @Override
    public SGuiValidation validateForm() {
        SGuiValidation validation = moFields.validateFields();
        if (validation.isValid()) {
            if (moRadioDocsCurrency.isSelected() && moKeyCur.getSelectedIndex() <= 0) {
                validation.setMessage("Debe seleccionar una moneda de documento.");
                validation.setComponent(moKeyCur);
            }
        }
        if (validation.isValid()) {
            if (jtaItemKeys.getText().isEmpty() && jtaItemNames.getText().isEmpty()) {
                validation.setMessage("Debe existir configuración del reporte para códigos de ítems o contenido de descripción");
                validation.setComponent(jbModify);
            }
        }
        return validation;
    }

    @Override
    public void createParamsMap() {
        if (jbPrint.isEnabled()) {
            if (SGuiUtils.computeValidation(miClient, validateForm())) {
                String itemKeys = ""; 
                String itemName = "";
                String cur;
                String whereCur = "";
                String parameters = "";
                String between = "dt BETWEEN '" + SLibUtils.DbmsDateFormatDate.format(moDateStart.getValue()) + "' AND '" + SLibUtils.DbmsDateFormatDate.format(moDateEnd.getValue()) + "'";
                if (!jtaItemKeys.getText().isEmpty()) {
                    for (String key : jtaItemKeys.getText().split("\n")) {
                        if (itemKeys.isEmpty()) {
                            itemKeys += "AND i.item_key IN ('" + key + "'";
                        }
                        else {
                            itemKeys += ", '" + key + "'";
                        }
                        if (parameters.isEmpty()) {
                            parameters += "'" + key + "'";
                        }
                        else{
                            parameters += ", '" + key + "'";
                        }
                    }
                }
                if (!itemKeys.isEmpty()) {
                    itemKeys += ") ";
                }
                
                if (!jtaItemNames.getText().isEmpty()) {
                    for (String name : jtaItemNames.getText().split("\n")) {
                        if (itemName.isEmpty()) {
                            itemName += "AND (i.item LIKE '%" + name + "%' ";
                        }
                        else {
                            itemName += "OR i.item LIKE '%" + name + "%' ";
                        }
                        if (parameters.isEmpty()) {
                            parameters = "'" + name + "'";
                        }
                        else {
                            parameters += ", '" + name + "'";
                        }
                    }
                }
                
                if (!itemName.isEmpty()){
                    itemName += ")";
                }
                
                if (moRadioDocsAll.isSelected()) {
                    cur = "TODAS";
                }
                else {
                    cur = moKeyCur.getSelectedItem().toString();
                    whereCur = "AND d.fid_cur = " + moKeyCur.getValue()[0] + " ";
                }
                
                moParamsMap = miClient.createReportParams();
                
                moParamsMap.put("sTitle", moTextTitle.getValue());
                moParamsMap.put("nDpsCategory", mnFormSubtype);
                moParamsMap.put("sItemKeys", itemKeys);  
                moParamsMap.put("tDateStart", moDateStart.getValue());  
                moParamsMap.put("tDateEnd", moDateEnd.getValue());  
                moParamsMap.put("sCur", cur);  
                moParamsMap.put("bDetail", moRadioReportDetail.isSelected());  
                moParamsMap.put("sParameters", parameters);  
                moParamsMap.put("sWhereCur", whereCur);   
                moParamsMap.put("sItemName", itemName);
                moParamsMap.put("sBetween", between);
            }
        }
    }
    
    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();
            if (button == jbModify) {
                actionModify();
            }
            else if (button == jbSaveConf) {
                actionSaveConf();
            }
            else if (button == jbCancelConf) {
                actionCancelConf();
            }
        }
    }
}