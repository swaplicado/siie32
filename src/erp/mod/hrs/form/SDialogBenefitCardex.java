/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mod.hrs.form;

import erp.mod.SModConsts;
import erp.mod.SModSysConsts;
import erp.mod.hrs.db.SDbConfig;
import erp.mod.hrs.db.SDbEmployee;
import erp.mod.hrs.db.SHrsConsts;
import erp.mod.hrs.db.SRowBenefitCardex;
import erp.mod.hrs.db.SRowBenefitDetailCardex;
import java.awt.BorderLayout;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;
import java.util.Vector;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import sa.gui.util.SUtilConsts;
import sa.lib.SLibConsts;
import sa.lib.SLibTimeUtils;
import sa.lib.SLibUtils;
import sa.lib.db.SDbRegistry;
import sa.lib.db.SDbRegistryUser;
import sa.lib.grid.SGridColumnForm;
import sa.lib.grid.SGridConsts;
import sa.lib.grid.SGridPaneForm;
import sa.lib.grid.SGridRow;
import sa.lib.gui.SGuiClient;
import sa.lib.gui.SGuiConsts;
import sa.lib.gui.SGuiUtils;
import sa.lib.gui.SGuiValidation;
import sa.lib.gui.bean.SBeanFormDialog;

/**
 *
 * @author Juan Barajas, Sergio Flores
 */
public class SDialogBenefitCardex extends SBeanFormDialog implements ListSelectionListener {
    
    private SDbEmployee moEmployee;
    private Date mtDateCutoff;
    private int mnSeniorityYears;
    private int mnSeniorityDays;
    private int mnBenefitsTableId;
    private double mdDailyPayment;
    private SGridPaneForm moGridBenefitSummary;
    private SGridPaneForm moGridBenefitDetail;

    /**
     * Creates new form SDialogBenefitCardex
     * @param client GUI client.
     * @param formSubtype Type of benefit. SModSysConsts.HRSS_TP_BEN_...
     * @param title Title of dialog.
     */
    public SDialogBenefitCardex(SGuiClient client, int formSubtype, String title) {
        setFormSettings(client, SGuiConsts.BEAN_FORM_EDIT, SModConsts.HRSX_BEN_MOV, formSubtype, title);
        initComponents();
        initComponentsCustom();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jpBenefit = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jPanel7 = new javax.swing.JPanel();
        jlEmployeeName = new javax.swing.JLabel();
        moTextEmployeeName = new sa.lib.gui.bean.SBeanFieldText();
        moTextEmployeeNumber = new sa.lib.gui.bean.SBeanFieldText();
        jlDailyPayment = new javax.swing.JLabel();
        moDecDailyPayment = new sa.lib.gui.bean.SBeanFieldDecimal();
        jPanel2 = new javax.swing.JPanel();
        jlBenefitType = new javax.swing.JLabel();
        moTextBenefitType = new sa.lib.gui.bean.SBeanFieldText();
        jPanel10 = new javax.swing.JPanel();
        jlDateCutoff = new javax.swing.JLabel();
        moTextDateCutoff = new sa.lib.gui.bean.SBeanFieldText();
        jlDateBenefits = new javax.swing.JLabel();
        moTextDateBenefits = new sa.lib.gui.bean.SBeanFieldText();
        jlSeniority = new javax.swing.JLabel();
        moIntSeniorityYears = new sa.lib.gui.bean.SBeanFieldInteger();
        jlSeniorityYears = new javax.swing.JLabel();
        moIntSeniorityDays = new sa.lib.gui.bean.SBeanFieldInteger();
        jlSeniorityDays = new javax.swing.JLabel();
        jlSeniorityProp = new javax.swing.JLabel();
        moDecSeniorityProp = new sa.lib.gui.bean.SBeanFieldDecimal();
        jPanel3 = new javax.swing.JPanel();
        jpBenefitSummary = new javax.swing.JPanel();
        jpBenefitDetail = new javax.swing.JPanel();

        jPanel1.setLayout(new java.awt.BorderLayout());

        jpBenefit.setLayout(new java.awt.BorderLayout());

        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Prestación:"));
        jPanel4.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlEmployeeName.setText("Empleado:");
        jlEmployeeName.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel7.add(jlEmployeeName);

        moTextEmployeeName.setEditable(false);
        moTextEmployeeName.setText("TEXT");
        moTextEmployeeName.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        moTextEmployeeName.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel7.add(moTextEmployeeName);

        moTextEmployeeNumber.setEditable(false);
        moTextEmployeeNumber.setText("TEXT");
        moTextEmployeeNumber.setToolTipText("Clave");
        moTextEmployeeNumber.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        moTextEmployeeNumber.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel7.add(moTextEmployeeNumber);

        jlDailyPayment.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlDailyPayment.setText("Pago diario:");
        jlDailyPayment.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel7.add(jlDailyPayment);

        moDecDailyPayment.setEditable(false);
        jPanel7.add(moDecDailyPayment);

        jPanel4.add(jPanel7);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlBenefitType.setText("Tipo prestación:");
        jlBenefitType.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel2.add(jlBenefitType);

        moTextBenefitType.setEditable(false);
        moTextBenefitType.setText("TEXT");
        moTextBenefitType.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel2.add(moTextBenefitType);

        jPanel4.add(jPanel2);

        jPanel10.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDateCutoff.setText("Fecha corte:");
        jlDateCutoff.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel10.add(jlDateCutoff);

        moTextDateCutoff.setEditable(false);
        moTextDateCutoff.setText("00/00/0000");
        moTextDateCutoff.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel10.add(moTextDateCutoff);

        jlDateBenefits.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlDateBenefits.setText("Inicio beneficios:");
        jlDateBenefits.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel10.add(jlDateBenefits);

        moTextDateBenefits.setEditable(false);
        moTextDateBenefits.setText("00/00/0000");
        moTextDateBenefits.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel10.add(moTextDateBenefits);

        jlSeniority.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlSeniority.setText("Antigüedad:");
        jlSeniority.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel10.add(jlSeniority);

        moIntSeniorityYears.setEditable(false);
        moIntSeniorityYears.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel10.add(moIntSeniorityYears);

        jlSeniorityYears.setText("años");
        jlSeniorityYears.setPreferredSize(new java.awt.Dimension(30, 23));
        jPanel10.add(jlSeniorityYears);

        moIntSeniorityDays.setEditable(false);
        moIntSeniorityDays.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel10.add(moIntSeniorityDays);

        jlSeniorityDays.setText("días");
        jlSeniorityDays.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel10.add(jlSeniorityDays);

        jlSeniorityProp.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlSeniorityProp.setText("Proporcional:");
        jlSeniorityProp.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel10.add(jlSeniorityProp);

        moDecSeniorityProp.setEditable(false);
        moDecSeniorityProp.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel10.add(moDecSeniorityProp);

        jPanel4.add(jPanel10);

        jpBenefit.add(jPanel4, java.awt.BorderLayout.CENTER);

        jPanel1.add(jpBenefit, java.awt.BorderLayout.NORTH);

        jPanel3.setLayout(new java.awt.BorderLayout());

        jpBenefitSummary.setBorder(javax.swing.BorderFactory.createTitledBorder("Prestación por aniversario:"));
        jpBenefitSummary.setPreferredSize(new java.awt.Dimension(100, 200));
        jpBenefitSummary.setLayout(new java.awt.BorderLayout());
        jPanel3.add(jpBenefitSummary, java.awt.BorderLayout.NORTH);

        jpBenefitDetail.setBorder(javax.swing.BorderFactory.createTitledBorder("Detalle de pagos de la prestación:"));
        jpBenefitDetail.setLayout(new java.awt.BorderLayout());
        jPanel3.add(jpBenefitDetail, java.awt.BorderLayout.CENTER);

        jPanel1.add(jPanel3, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JLabel jlBenefitType;
    private javax.swing.JLabel jlDailyPayment;
    private javax.swing.JLabel jlDateBenefits;
    private javax.swing.JLabel jlDateCutoff;
    private javax.swing.JLabel jlEmployeeName;
    private javax.swing.JLabel jlSeniority;
    private javax.swing.JLabel jlSeniorityDays;
    private javax.swing.JLabel jlSeniorityProp;
    private javax.swing.JLabel jlSeniorityYears;
    private javax.swing.JPanel jpBenefit;
    private javax.swing.JPanel jpBenefitDetail;
    private javax.swing.JPanel jpBenefitSummary;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecDailyPayment;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecSeniorityProp;
    private sa.lib.gui.bean.SBeanFieldInteger moIntSeniorityDays;
    private sa.lib.gui.bean.SBeanFieldInteger moIntSeniorityYears;
    private sa.lib.gui.bean.SBeanFieldText moTextBenefitType;
    private sa.lib.gui.bean.SBeanFieldText moTextDateBenefits;
    private sa.lib.gui.bean.SBeanFieldText moTextDateCutoff;
    private sa.lib.gui.bean.SBeanFieldText moTextEmployeeName;
    private sa.lib.gui.bean.SBeanFieldText moTextEmployeeNumber;
    // End of variables declaration//GEN-END:variables

    private void initComponentsCustom() {
        SGuiUtils.setWindowBounds(this, 960, 600);
        
        jbSave.setEnabled(false);
        jbCancel.setText(SUtilConsts.TXT_CLOSE);

        moTextEmployeeName.setTextSettings(SGuiUtils.getLabelName(jlEmployeeName), 202);
        moTextEmployeeNumber.setTextSettings(SGuiUtils.getLabelName(jlEmployeeName), 10);
        moDecDailyPayment.setDecimalSettings(SGuiUtils.getLabelName(jlDailyPayment), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moTextBenefitType.setTextSettings(SGuiUtils.getLabelName(jlBenefitType), 100);
        moTextDateCutoff.setTextSettings(SGuiUtils.getLabelName(jlDateCutoff.getText()), 25);
        moTextDateBenefits.setTextSettings(SGuiUtils.getLabelName(jlDateBenefits.getText()), 25);
        moIntSeniorityYears.setIntegerSettings(SGuiUtils.getLabelName(jlSeniorityYears), SGuiConsts.GUI_TYPE_INT, false);
        moIntSeniorityDays.setIntegerSettings(SGuiUtils.getLabelName(jlSeniorityDays), SGuiConsts.GUI_TYPE_INT, false);
        moDecSeniorityProp.setDecimalSettings(SGuiUtils.getLabelName(jlSeniorityProp), SGuiConsts.GUI_TYPE_DEC_PER, false);
        moDecSeniorityProp.setDecimalFormat(SLibUtils.DecimalFormatPercentage4D);
        
        moGridBenefitSummary = new SGridPaneForm(miClient, SModConsts.HRSX_BEN_SUM, SLibConsts.UNDEFINED, "Prestación por aniversario") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false);
            }

            @Override
            public ArrayList<SGridColumnForm> createGridColumns() {
                ArrayList<SGridColumnForm> gridColumnsForm = new ArrayList<>();

                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_2B, "Aniversario", 50));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_CAL_YEAR, "Año aniversario", 65));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_2B, "Días prestación", 100));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_4D, "Días proporcionales"));
                
                if (mnFormSubtype == SModSysConsts.HRSS_TP_BEN_VAC) {
                    gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_4D, "Días programados"));
                    gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_4D, "Días pagados"));
                    gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_4D, "Días x pagar"));
                }
                else {
                    if (mnFormSubtype == SModSysConsts.HRSS_TP_BEN_ANN_BON) {
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto prestación $"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto proporcional$"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto pagado $"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto x pagar $"));
                    }
                    else if (mnFormSubtype == SModSysConsts.HRSS_TP_BEN_VAC_BON) {
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_PER_2D, "Prima"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto prestación $"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto proporcional $"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto pagado $"));
                        gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto x pagar $"));
                    }
                } 

                return gridColumnsForm;
            }
        };

        jpBenefitSummary.add(moGridBenefitSummary, BorderLayout.CENTER);
        
        moGridBenefitDetail = new SGridPaneForm(miClient, SModConsts.HRSX_BEN_DET, SLibConsts.UNDEFINED, "Detalle prestación") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false);
            }

            @Override
            public ArrayList<SGridColumnForm> createGridColumns() {
                ArrayList<SGridColumnForm> gridColumnsForm = new ArrayList<>();

                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Fecha"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_CAL_YEAR, "Ejercicio", 50));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_CAL_MONTH, "Período", 50));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_M, "Tipo nómina", 75));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "No. nómina", 50));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Fecha inicial"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Fecha final"));
                if (mnFormSubtype != SModSysConsts.HRSS_TP_BEN_VAC_BON) {
                    gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_4D, "Días"));
                }
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto $"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_USR, "Usr nvo"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE_DATETIME, "Usr TS nvo"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_USR, "Usr mod"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE_DATETIME, "Usr TS mod"));

                return gridColumnsForm;
            }
        };

        jpBenefitDetail.add(moGridBenefitDetail, BorderLayout.CENTER);
    }
    
    private double getSeniorityProp() {
        return (mnSeniorityDays <= SHrsConsts.YEAR_DAYS ? mnSeniorityDays : SHrsConsts.YEAR_DAYS) / (double) SHrsConsts.YEAR_DAYS;
    }
    
    private int getVacationDays(final Statement statement, final int anniversary) throws Exception {
        int days = 0;
        
        String sql = "SELECT benr.id_ben, benr.id_row, benr.mon, benr.ben_day, benr.ben_bon_per "
                + "FROM hrs_ben AS ben "
                + "INNER JOIN hrs_ben_row AS benr ON benr.id_ben = ben.id_ben "
                + "WHERE ben.fk_tp_ben = " + SModSysConsts.HRSS_TP_BEN_VAC + " AND "
                + "benr.mon >= (" + SHrsConsts.YEAR_MONTHS + " * " + anniversary + ") AND "
                + "ben.dt_sta <= '" + SLibUtils.DbmsDateFormatDate.format(mtDateCutoff) + "' AND "
                + "NOT ben.b_del "
                + "ORDER BY benr.id_ben, benr.id_row "
                + "LIMIT 1;";

        try (ResultSet resultSet = statement.executeQuery(sql)) {
            if (resultSet.next()) {
                days = resultSet.getInt("benr.ben_day");
            }
        }
        
        return days;
    }

    @SuppressWarnings("unchecked")
    private void showBenefitCardex() {
        Vector<SGridRow> rows = new Vector<>();

        try {
            try (Statement statementBonus = miClient.getSession().getStatement().getConnection().createStatement()) {
                // proceed adding 1 to show current anniversary, eventhough elapsed partially:
                
                int yearBenefits = SLibTimeUtils.digestYear(moEmployee.getDateBenefits())[0];
                
                for (int anniversary = mnSeniorityYears + 1; anniversary >= 1; anniversary--) {
                    String sql;
                    ResultSet resultSet;
                    
                    int benefitYear = yearBenefits + anniversary - 1;
                    
                    SRowBenefitCardex row = new SRowBenefitCardex(mnFormSubtype);
                    row.setBenefitYear(benefitYear);
                    row.setBenefitAnniversary(anniversary);
                    row.setProportional(anniversary == mnSeniorityYears + 1 ? getSeniorityProp() : 1.0);
                    
                    sql = "SELECT benr.id_ben, benr.id_row, benr.mon, benr.ben_day, benr.ben_bon_per "
                            + "FROM hrs_ben AS ben "
                            + "INNER JOIN hrs_ben_row AS benr ON benr.id_ben = ben.id_ben "
                            + "WHERE ben.id_ben = " + mnBenefitsTableId + " AND ben.fk_tp_ben = " + mnFormSubtype + " AND "
                            + "benr.mon >= (" + SHrsConsts.YEAR_MONTHS + " * " + anniversary + ") AND "
                            + "ben.dt_sta <= '" + SLibUtils.DbmsDateFormatDate.format(mtDateCutoff) + "' AND "
                            + "NOT ben.b_del "
                            + "LIMIT 1;";
                    resultSet = miClient.getSession().getStatement().executeQuery(sql);
                    if (resultSet.next()) {
                        if (mnFormSubtype == SModSysConsts.HRSS_TP_BEN_VAC_BON) {
                            row.setBenefitBonusPct(resultSet.getDouble("benr.ben_bon_per"));
                            row.setBenefitDays(getVacationDays(statementBonus, anniversary));
                        }
                        else {
                            row.setBenefitBonusPct(1);
                            row.setBenefitDays(resultSet.getInt("benr.ben_day"));
                        }
                    }
                    
                    // scheduled days (only for vacations):
                    
                    if (mnFormSubtype == SModSysConsts.HRSS_TP_BEN_VAC) {
                        sql = "SELECT SUM(eff_day) AS _days_sched "
                                + "FROM " + SModConsts.TablesMap.get(SModConsts.HRS_ABS) + " "
                                + "WHERE id_emp = " + moEmployee.getPkEmployeeId() + " AND "
                                + "fk_cl_abs = " + SModSysConsts.HRSU_TP_ABS_VAC[0] + " AND "
                                + "fk_tp_abs = " + SModSysConsts.HRSU_TP_ABS_VAC[1] + " AND "
                                + "ben_year = " + benefitYear + " AND ben_ann = " + anniversary + " AND "
                                + "NOT b_del;";
                        resultSet = miClient.getSession().getStatement().executeQuery(sql);
                        if (resultSet.next()) {
                            row.setBenefitDaysScheduled(resultSet.getDouble(1));
                        }
                    }
                    
                    // payed days and amount:
                    
                    double payedDays = 0;
                    double payedAmount = 0;
                    
                    sql = "SELECT SUM(pre.unt_all) AS _days, SUM(pre.amt_r) AS _amount "
                            + "FROM " + SModConsts.TablesMap.get(SModConsts.HRS_PAY) + " AS p "
                            + "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP) + " AS pr ON pr.id_pay = p.id_pay "
                            + "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP_EAR) + " AS pre ON pre.id_pay = pr.id_pay AND pre.id_emp = pr.id_emp "
                            + "WHERE pr.id_emp = " + moEmployee.getPkEmployeeId() + " AND pre.fk_tp_ben = " + mnFormSubtype + " AND "
                            + "pre.ben_year = " + benefitYear + " AND pre.ben_ann = " + anniversary + " AND "
                            + "p.dt_end <= '" + SLibUtils.DbmsDateFormatDate.format(mtDateCutoff) + "' AND "
                            + "NOT p.b_del AND NOT pr.b_del AND NOT pre.b_del;";
                    resultSet = miClient.getSession().getStatement().executeQuery(sql);
                    if (resultSet.next()) {
                        payedDays = resultSet.getDouble("_days");
                        payedAmount = resultSet.getDouble("_amount");
                    }
                    
                    sql = "SELECT SUM(prd.unt_all) AS _days, SUM(prd.amt_r) AS _amount "
                            + "FROM " + SModConsts.TablesMap.get(SModConsts.HRS_PAY) + " AS p "
                            + "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP) + " AS pr ON pr.id_pay = p.id_pay "
                            + "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP_DED) + " AS prd ON prd.id_pay = pr.id_pay AND prd.id_emp = pr.id_emp "
                            + "WHERE pr.id_emp = " + moEmployee.getPkEmployeeId() + " AND prd.fk_tp_ben = " + mnFormSubtype + " AND "
                            + "prd.ben_year = " + benefitYear + " AND prd.ben_ann = " + anniversary + " AND "
                            + "p.dt_end <= '" + SLibUtils.DbmsDateFormatDate.format(mtDateCutoff) + "' AND "
                            + "NOT p.b_del AND NOT pr.b_del AND NOT prd.b_del;";
                    resultSet = miClient.getSession().getStatement().executeQuery(sql);
                    if (resultSet.next()) {
                        payedDays = (payedDays - resultSet.getDouble("_days")); // decrement days
                        payedAmount = (SLibUtils.roundAmount(payedAmount - resultSet.getDouble("_amount"))); // decrement amount
                    }
                    
                    row.setBenefitDaysPayed(payedDays);
                    row.setBenefitAmount(row.getBenefitDays() * row.getBenefitBonusPct() * mdDailyPayment);
                    row.setBenefitAmountPayed(payedAmount);

                    rows.add(row);
                    resultSet.close();
                }
            }

            moGridBenefitSummary.populateGrid(rows, this);
            moGridBenefitSummary.clearSortKeys();
            moGridBenefitSummary.setSelectedGridRow(0);
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }
    
    private void showBenefitDetail(SRowBenefitCardex rowBenefit) {
        Vector<SGridRow> rows = new Vector<>();
        String sql = "";
        ResultSet resultSet = null;

        try {
            sql = "SELECT IF(p.id_pay = 0, rcp_ear_cmp.dt, p.dt_end) f_dt, p.per_year, p.per AS f_period, IF(p.id_pay = 0, '', tp_pay.name) AS f_tp_pay, p.num AS f_num, IF(p.id_pay = 0, NULL, p.dt_sta) AS f_dt_sta, IF(p.id_pay = 0,NULL, p.dt_end) AS f_dt_end, rcp_ear.id_pay, rcp_ear.id_emp, rcp_ear.id_mov, rcp_ear.unt_all AS f_unt, rcp_ear.amt_r AS f_amt, " +
                    "rcp_ear.ts_usr_ins AS ts_usr_ins, rcp_ear.ts_usr_upd AS ts_usr_upd, ui.usr AS f_usr_ins, uu.usr AS f_usr_upd " +
                    "FROM " + SModConsts.TablesMap.get(SModConsts.HRS_PAY) + " AS p " +
                    "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP) + " AS rcp ON rcp.id_pay = p.id_pay " +
                    "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP_EAR) + " AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp AND rcp_ear.b_del = 0 " +
                    "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.HRSS_TP_PAY) + " AS tp_pay ON tp_pay.id_tp_pay = p.fk_tp_pay " +
                    "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.USRU_USR) + " AS ui ON rcp_ear.fk_usr_ins = ui.id_usr " +
                    "INNER JOIN " + SModConsts.TablesMap.get(SModConsts.USRU_USR) + " AS uu ON rcp_ear.fk_usr_upd = uu.id_usr " +
                    "LEFT OUTER JOIN " + SModConsts.TablesMap.get(SModConsts.HRS_PAY_RCP_EAR_CMP) + " AS rcp_ear_cmp ON rcp_ear_cmp.id_pay = rcp_ear.id_pay AND rcp_ear_cmp.id_emp = rcp_ear.id_emp AND rcp_ear_cmp.id_mov = rcp_ear.id_mov " +
                    "WHERE (p.id_pay = 0 OR p.b_del = 0) AND rcp_ear.id_emp = " + moEmployee.getPkEmployeeId() + " AND rcp.b_del = 0 AND rcp_ear.fk_tp_ben = " + mnFormSubtype + " AND rcp_ear.ben_ann = " + rowBenefit.getBenefitAnniversary() + " AND " +
                    "rcp_ear.ben_year = " + rowBenefit.getBenefitYear() + " " +
                    "ORDER BY f_dt, per_year, f_period, f_tp_pay, f_num, f_dt_sta, f_dt_end, rcp_ear.id_pay, rcp_ear.id_emp, rcp_ear.id_mov ";

            resultSet = miClient.getSession().getStatement().executeQuery(sql);

            while (resultSet.next()) {
                SRowBenefitDetailCardex row = new SRowBenefitDetailCardex(mnFormSubtype);
                
                row.setDate(resultSet.getDate("f_dt"));
                row.setYear(resultSet.getInt("per_year"));
                row.setPeriod(resultSet.getInt("f_period"));
                row.setPayrollType(resultSet.getString("f_tp_pay"));
                row.setNumber(resultSet.getString("f_num"));
                row.setDateStart(resultSet.getDate("f_dt_sta"));
                row.setDateEnd(resultSet.getDate("f_dt_end"));

                row.setDays(resultSet.getDouble("f_unt"));
                row.setAmount(resultSet.getDouble("f_amt"));
                row.setUserInsert(resultSet.getString("f_usr_ins"));
                row.setDateUserInsert(resultSet.getTimestamp("ts_usr_ins"));
                row.setUserUpdate(resultSet.getString("f_usr_upd"));
                row.setDateUserUpdate(resultSet.getTimestamp("ts_usr_upd"));

                rows.add(row);
            }

            moGridBenefitDetail.populateGrid(rows);
            moGridBenefitDetail.clearSortKeys();
            moGridBenefitDetail.setSelectedGridRow(0);
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    /**
     * Show detail of current benefit.
     */
    private void valueChangedBenefitSummary() {
        SRowBenefitCardex benefitCardex = (SRowBenefitCardex) moGridBenefitSummary.getSelectedGridRow();

        if (benefitCardex != null) {
            showBenefitDetail(benefitCardex);
        }
    }
    
    public void setFormParams(final int employeeId, final int seniorityYears, final int seniorityDays, final int benefitsTableId, final Date dateCutoff) {
        SDbConfig config = (SDbConfig) miClient.getSession().readRegistry(SModConsts.HRS_CFG, new int[] { SUtilConsts.BPR_CO_ID });
        
        moEmployee = (SDbEmployee) miClient.getSession().readRegistry(SModConsts.HRSU_EMP, new int[] { employeeId });
        mdDailyPayment = moEmployee.getEffectiveSalary(config.isFortnightStandard());
        
        mnSeniorityYears = seniorityYears;
        mnSeniorityDays = seniorityDays;
        mnBenefitsTableId = benefitsTableId;
        mtDateCutoff = dateCutoff;
        
        moTextEmployeeName.setValue(moEmployee.getXtaEmployeeName());
        moTextEmployeeNumber.setValue(moEmployee.getNumber());
        moDecDailyPayment.setValue(mdDailyPayment);
        moTextBenefitType.setValue(miClient.getSession().readField(SModConsts.HRSS_TP_BEN, new int[] { mnFormSubtype }, SDbRegistryUser.FIELD_NAME));
        moTextDateCutoff.setValue(SLibUtils.DateFormatDate.format(mtDateCutoff));
        moTextDateBenefits.setValue(SLibUtils.DateFormatDate.format(moEmployee.getDateBenefits()));
        moIntSeniorityYears.setValue(mnSeniorityYears);
        moIntSeniorityDays.setValue(mnSeniorityDays);
        moDecSeniorityProp.setValue(getSeniorityProp());
        
        showBenefitCardex();
    }
    
    @Override
    public void addAllListeners() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void removeAllListeners() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void reloadCatalogues() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void setRegistry(SDbRegistry registry) throws Exception {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public SDbRegistry getRegistry() throws Exception {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public SGuiValidation validateForm() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void setValue(final int type, final Object value) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public Object getValue(final int type) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void valueChanged(ListSelectionEvent e) {
        if (!e.getValueIsAdjusting()) {
            if (moGridBenefitSummary.getTable().getSelectedRowCount() != -1) {
                valueChangedBenefitSummary();
            }
        }
    }

    @Override
    public void actionCancel() {
        mnFormResult = SGuiConsts.FORM_RESULT_CANCEL;
        dispose();
    }
}
